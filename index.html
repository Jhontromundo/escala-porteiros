<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Porteiros - CCB Santa Am√©lia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #1976d2;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls input, .controls button {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .controls input:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .btn-gerar {
            background: #1976d2;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-gerar:hover {
            background: #1565c0;
        }
        
        .btn-pdf {
            background: #d32f2f;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-pdf:hover {
            background: #c62828;
        }
        
        .btn-gerenciar {
            background: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-gerenciar:hover {
            background: #45a049;
        }
        
        .tabela-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f5f5f5;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .servico-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        
        .oficial { background: #e3f2fd; color: #1976d2; }
        .rjm { background: #e8f5e8; color: #388e3c; }
        .rsetor { background: #fff3e0; color: #f57c00; }
        .rlocal { background: #f3e5f5; color: #7b1fa2; }
        .ensaio { background: #e8eaf6; color: #3f51b5; }
        
        .mesclar {
            text-align: center;
            background: #f0f0f0;
        }
        
        .editavel {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-height: 20px;
            display: inline-block;
            min-width: 60px;
        }
        
        .editavel:hover {
            background-color: #e3f2fd;
            border: 1px dashed #1976d2;
        }
        
        .editando {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .destaque {
            background-color: #ffeb3b !important;
            font-weight: bold;
            color: #f57f17;
        }
        
        .dropdown-edicao {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            min-width: 120px;
        }
        
        .btn-edicao {
            background: #4caf50;
            color: white;
            border: none;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn-cancelar {
            background: #f44336;
        }
        
        .conflito-alerta {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .conflito-alerta h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conflito-lista {
            color: #d32f2f;
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }
        
        .close:hover {
            color: #000;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: #1976d2;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e3f2fd;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grupo-editor {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .grupo-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .membros-lista {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .membro-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .membro-nome {
            flex: 1;
            font-weight: bold;
        }
        
        .btn-mover, .btn-remover {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-mover {
            background: #2196f3;
        }
        
        .btn-adicionar-membro {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .select-membro {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            flex: 1;
        }
        
        .btn-add {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .btn-salvar {
            background: #4caf50;
            color: white;
        }
        
        .btn-salvar:hover {
            background: #45a049;
        }
        
        .btn-restaurar {
            background: #ff9800;
            color: white;
        }
        
        .btn-restaurar:hover {
            background: #f57c00;
        }
        
        .btn-cancelar-modal {
            background: #f44336;
            color: white;
        }
        
        .btn-cancelar-modal:hover {
            background: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls input, .controls button {
                width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gerador de Escalas de Servi√ßo</h1>
            <p>Congrega√ß√£o Crist√£ no Brasil - Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <label for="mesAno">üìÖ Selecionar M√™s:</label>
            <input type="month" id="mesAno" onchange="gerarEscala()">
            <button class="btn-gerar" onclick="gerarEscala()">üîÑ Gerar Escala</button>
            <button class="btn-pdf" onclick="gerarPDF()">üìÑ Gerar PDF</button>
            <button class="btn-gerenciar" onclick="abrirGerenciador()">‚öôÔ∏è Gerenciar Grupos</button>
            <div id="membroDestacado" style="display: none;" class="btn-gerar">
                Destacando: <span id="nomeDestacado"></span>
                <button onclick="limparDestaque()" style="background: transparent; border: none; color: white; margin-left: 10px;">‚úï</button>
            </div>
        </div>
        
        <div id="alertaConflitos" class="conflito-alerta">
            <h3>‚ö†Ô∏è Conflitos de Mesmo Dia Detectados</h3>
            <div id="listaConflitos" class="conflito-lista"></div>
            <p style="font-size: 12px; margin-top: 15px; color: #666; border-top: 1px solid #ddd; padding-top: 10px;">
                <strong>üí° Como resolver:</strong><br>
                ‚Ä¢ <strong>Aplicar sugest√£o:</strong> Clique no bot√£o "‚ú® Aplicar" nas sugest√µes autom√°ticas<br>
                ‚Ä¢ <strong>Edi√ß√£o manual:</strong> Use <strong>duplo clique</strong> ou <strong>bot√£o direito</strong> em qualquer nome<br>
                ‚Ä¢ <strong>Dica:</strong> Sugest√µes ü•á s√£o as mais recomendadas
            </p>
        </div>
        
        <div class="tabela-container">
            <table id="tabelaEscala">
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- Dados ser√£o inseridos aqui -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>‚úÖ Sistema de Escalas Implementado</p>
            <p>üéØ Distribui√ß√£o Justa e Inteligente</p>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Grupos -->
    <div id="modalGerenciador" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharGerenciador()">&times;</span>
            <h2 style="text-align: center; color: #1976d2; margin-bottom: 30px;">‚öôÔ∏è Gerenciar Grupos e Sequ√™ncias</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="mostrarTab('grupos')">üë• Grupos Semanais</button>
                <button class="tab" onclick="mostrarTab('sequencias')">üîÑ Sequ√™ncias Especiais</button>
                <button class="tab" onclick="mostrarTab('membros')">üë§ Gerenciar Membros</button>
            </div>
            
            <!-- Tab Grupos Semanais -->
            <div id="tab-grupos" class="tab-content active">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è 3¬™ Feira (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-terca" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-terca" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('terca')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è 5¬™ Feira (3 pessoas - sem folga)</div>
                    <div id="grupo-quinta" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-quinta" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('quinta')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è S√°bado (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-sabado" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-sabado" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('sabado')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è Domingo Oficial (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-domingoOficial" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-domingoOficial" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('domingoOficial')">+ Adicionar</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Sequ√™ncias Especiais -->
            <div id="tab-sequencias" class="tab-content">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üìø RJM (2 por domingo)</div>
                    <div id="sequencia-rjm" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rjm" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rjm')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üè¢ R. SETOR (1 por m√™s)</div>
                    <div id="sequencia-rSetor" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rSetor" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rSetor')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üåç R. LOCAL (trimestral)</div>
                    <div id="sequencia-rLocal" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rLocal" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rLocal')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üéµ ENSAIO (2 por m√™s)</div>
                    <div id="sequencia-ensaio" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-ensaio" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('ensaio')">+ Adicionar</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Gerenciar Membros (NOVA ABA) -->
            <div id="tab-membros" class="tab-content">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üë§ Lista de Membros do Sistema</div>
                    <div id="lista-membros" class="membros-lista"></div>
                    
                    <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">‚ûï Adicionar Novo Membro</h4>
                        <div class="btn-adicionar-membro">
                            <input type="text" id="input-novo-membro" placeholder="Digite o nome do novo membro..." class="select-membro" style="flex: 2;">
                            <button class="btn-add" onclick="adicionarNovoMembro()">+ Adicionar ao Sistema</button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            <strong>Dica:</strong> Ap√≥s adicionar, voc√™ poder√° incluir o membro nos grupos e sequ√™ncias desejados.
                        </p>
                    </div>
                </div>
                
                <div class="grupo-editor" style="background: #f0f8ff; border: 1px solid #1976d2;">
                    <div class="grupo-titulo">‚ö†Ô∏è Aten√ß√£o</div>
                    <p style="color: #1976d2; font-size: 14px; line-height: 1.5;">
                        ‚Ä¢ <strong>Adicionar membro:</strong> Inclui na lista geral do sistema<br>
                        ‚Ä¢ <strong>Remover membro:</strong> Remove completamente do sistema<br>
                        ‚Ä¢ <strong>Lembre-se:</strong> Ap√≥s altera√ß√µes, atualize os grupos e sequ√™ncias conforme necess√°rio
                    </p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-modal btn-salvar" onclick="salvarAlteracoes()">üíæ Salvar e Regenerar</button>
                <button class="btn-modal btn-restaurar" onclick="restaurarPadrao()">üîÑ Restaurar Padr√£o</button>
                <button class="btn-modal" onclick="reiniciarSequencias()" style="background: #9c27b0; color: white;">üéØ Reiniciar Sequ√™ncias</button>
                <button class="btn-modal btn-cancelar-modal" onclick="fecharGerenciador()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // Grupos por dia da semana (configura√ß√£o padr√£o)
        const gruposPadraoOriginal = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        // Sequ√™ncias dos servi√ßos especiais (configura√ß√£o padr√£o)
        const sequenciasPadraoOriginal = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN', 'ALGACIR', 'SAULO', 'RODINEI', 'SAMUEL', 'C√âLIO', 'JONAS', 'AFONSO'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'JONAS', 'C√âLIO', 'EDI', 'SAMUEL', 'JOS√â CARLOS', 'MARCOS', 'EDIVAN', 'SAULO'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'C√âLIO', 'SAULO', 'MARCOS'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL', 'EDIVAN', 'MARCOS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'JONAS']
        };

        // Grupos e sequ√™ncias atuais (carregados do localStorage ou padr√£o)
        let gruposPorDia = carregarConfiguracoes('grupos') || JSON.parse(JSON.stringify(gruposPadraoOriginal));
        let sequencias = carregarConfiguracoes('sequencias') || JSON.parse(JSON.stringify(sequenciasPadraoOriginal));

        const diasSemana = ['DOMINGO', '2¬™ FEIRA', '3¬™ FEIRA', '4¬™ FEIRA', '5¬™ FEIRA', '6¬™ FEIRA', 'S√ÅBADO'];
        let escalaAtual = [];
        let membroDestacadoAtual = null;
        let editandoAtualmente = null;

        // Lista de todos os membros para edi√ß√£o (agora din√¢mica)
        let todosMembros = carregarConfiguracoes('membros') || [
            'AFONSO', 'ALGACIR', 'JONAS', 'ZANIN', 'EDI', 'MARCOS', 'SAULO',
            'JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU', 'JOS√â CARDOSO',
            'ODEMIR', 'SAMUEL', 'EDIVAN', 'C√âLIO'
        ];

        // Fun√ß√µes de persist√™ncia
        function salvarConfiguracoes(tipo, dados) {
            try {
                localStorage.setItem('escalas_' + tipo, JSON.stringify(dados));
            } catch (e) {
                console.log('N√£o foi poss√≠vel salvar no localStorage');
            }
        }

        function carregarConfiguracoes(tipo) {
            try {
                const dados = localStorage.getItem('escalas_' + tipo);
                return dados ? JSON.parse(dados) : null;
            } catch (e) {
                console.log('N√£o foi poss√≠vel carregar do localStorage');
                return null;
            }
        }

        // Fun√ß√µes para persistir √≠ndices das sequ√™ncias E grupos semanais
        function salvarIndices(indices) {
            try {
                localStorage.setItem('escalas_indices', JSON.stringify(indices));
            } catch (e) {
                console.log('N√£o foi poss√≠vel salvar √≠ndices');
            }
        }

        function carregarIndices() {
            try {
                const dados = localStorage.getItem('escalas_indices');
                return dados ? JSON.parse(dados) : {
                    rjm: 0,
                    rSetor: 0,
                    rLocal: 0,
                    ensaio: 0,
                    // √çndices para grupos semanais (continuidade entre meses)
                    terca: 0,
                    quinta: 0,
                    sabado: 0,
                    domingoOficial: 0
                };
            } catch (e) {
                console.log('N√£o foi poss√≠vel carregar √≠ndices');
                return {
                    rjm: 0,
                    rSetor: 0,
                    rLocal: 0,
                    ensaio: 0,
                    terca: 0,
                    quinta: 0,
                    sabado: 0,
                    domingoOficial: 0
                };
            }
        }

        // Fun√ß√µes do gerenciador de grupos
        function abrirGerenciador() {
            const modal = document.getElementById('modalGerenciador');
            modal.style.display = 'block';
            atualizarInterfaceGerenciador();
        }

        function fecharGerenciador() {
            const modal = document.getElementById('modalGerenciador');
            modal.style.display = 'none';
        }

        function mostrarTab(tabNome) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById('tab-' + tabNome).classList.add('active');
            event.target.classList.add('active');
        }

        function atualizarInterfaceGerenciador() {
            // Atualizar grupos semanais
            const gruposSemanais = ['terca', 'quinta', 'sabado', 'domingoOficial'];
            gruposSemanais.forEach(grupo => {
                atualizarListaMembros(grupo, gruposPorDia[grupo], 'grupo');
                atualizarSelectMembros(grupo);
            });

            // Atualizar sequ√™ncias especiais
            const sequenciasEspeciais = ['rjm', 'rSetor', 'rLocal', 'ensaio'];
            sequenciasEspeciais.forEach(seq => {
                atualizarListaMembros(seq, sequencias[seq], 'sequencia');
                atualizarSelectMembros(seq);
            });
            
            // Atualizar lista de membros (NOVA FUNCIONALIDADE)
            atualizarListaTodosMembros();
        }

        function atualizarListaMembros(nomeGrupo, membros, tipo) {
            const container = document.getElementById((tipo === 'grupo' ? 'grupo-' : 'sequencia-') + nomeGrupo);
            container.innerHTML = '';

            membros.forEach((membro, index) => {
                const item = document.createElement('div');
                item.className = 'membro-item';
                item.innerHTML = `
                    <span class="membro-nome">${membro}</span>
                    <button class="btn-mover" onclick="moverMembro('${nomeGrupo}', ${index}, -1, '${tipo}')">‚Üë</button>
                    <button class="btn-mover" onclick="moverMembro('${nomeGrupo}', ${index}, 1, '${tipo}')">‚Üì</button>
                    <button class="btn-remover" onclick="removerMembro('${nomeGrupo}', ${index}, '${tipo}')">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function atualizarSelectMembros(nomeGrupo) {
            const select = document.getElementById('select-' + nomeGrupo);
            select.innerHTML = '<option value="">Selecione um membro...</option>';

            todosMembros.forEach(membro => {
                const option = document.createElement('option');
                option.value = membro;
                option.textContent = membro;
                select.appendChild(option);
            });
        }

        function adicionarMembro(nomeGrupo) {
            const select = document.getElementById('select-' + nomeGrupo);
            const novoMembro = select.value;

            if (!novoMembro) {
                alert('Selecione um membro primeiro!');
                return;
            }

            // Verificar se √© grupo ou sequ√™ncia
            let isGrupo = ['terca', 'quinta', 'sabado', 'domingoOficial'].includes(nomeGrupo);
            let lista = isGrupo ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];

            if (lista.includes(novoMembro)) {
                alert('Este membro j√° est√° neste grupo/sequ√™ncia!');
                return;
            }

            lista.push(novoMembro);
            atualizarListaMembros(nomeGrupo, lista, isGrupo ? 'grupo' : 'sequencia');
            select.value = '';
        }

        function removerMembro(nomeGrupo, index, tipo) {
            if (!confirm('Tem certeza que deseja remover este membro?')) return;

            let lista = tipo === 'grupo' ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];
            lista.splice(index, 1);
            atualizarListaMembros(nomeGrupo, lista, tipo);
        }

        function moverMembro(nomeGrupo, index, direcao, tipo) {
            let lista = tipo === 'grupo' ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];
            const novoIndex = index + direcao;

            if (novoIndex < 0 || novoIndex >= lista.length) return;

            // Trocar posi√ß√µes
            [lista[index], lista[novoIndex]] = [lista[novoIndex], lista[index]];
            atualizarListaMembros(nomeGrupo, lista, tipo);
        }

        function salvarAlteracoes() {
            if (!confirm('Salvar altera√ß√µes e regenerar escala?')) return;

            // Salvar no localStorage
            salvarConfiguracoes('grupos', gruposPorDia);
            salvarConfiguracoes('sequencias', sequencias);
            salvarConfiguracoes('membros', todosMembros); // NOVA: Salvar lista de membros

            // Fechar modal
            fecharGerenciador();

            // Regenerar escala
            gerarEscala();

            alert('‚úÖ Altera√ß√µes salvas com sucesso!');
        }

        function restaurarPadrao() {
            if (!confirm('Restaurar configura√ß√µes padr√£o? Todas as altera√ß√µes ser√£o perdidas!')) return;

            // Restaurar grupos padr√£o
            gruposPorDia.terca = [...gruposPadraoOriginal.terca];
            gruposPorDia.quinta = [...gruposPadraoOriginal.quinta];
            gruposPorDia.sabado = [...gruposPadraoOriginal.sabado];
            gruposPorDia.domingoOficial = [...gruposPadraoOriginal.domingoOficial];
            
            sequencias.rjm = [...sequenciasPadraoOriginal.rjm];
            sequencias.rSetor = [...sequenciasPadraoOriginal.rSetor];
            sequencias.rLocal = [...sequenciasPadraoOriginal.rLocal];
            sequencias.ensaio = [...sequenciasPadraoOriginal.ensaio];

            // Limpar √≠ndices salvos (restart das sequ√™ncias)
            localStorage.removeItem('escalas_indices');

            // Atualizar interface
            atualizarInterfaceGerenciador();

            alert('‚úÖ Configura√ß√µes padr√£o restauradas! Sequ√™ncias reiniciadas.');
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalGerenciador');
            if (event.target === modal) {
                fecharGerenciador();
            }
        };

        // Fun√ß√£o para reiniciar apenas as sequ√™ncias
        function reiniciarSequencias() {
            if (!confirm('Reiniciar todas as sequ√™ncias do in√≠cio? Isso vai resetar a continuidade entre meses.')) return;
            
            localStorage.removeItem('escalas_indices');
            alert('‚úÖ Sequ√™ncias reiniciadas! Pr√≥xima escala come√ßar√° do in√≠cio de cada sequ√™ncia.');
        }
        
        // NOVAS FUN√á√ïES para gerenciar membros
        function atualizarListaTodosMembros() {
            const container = document.getElementById('lista-membros');
            container.innerHTML = '';

            todosMembros.forEach((membro, index) => {
                const item = document.createElement('div');
                item.className = 'membro-item';
                item.innerHTML = `
                    <span class="membro-nome">${membro}</span>
                    <button class="btn-mover" onclick="moverMembroGeral(${index}, -1)">‚Üë</button>
                    <button class="btn-mover" onclick="moverMembroGeral(${index}, 1)">‚Üì</button>
                    <button class="btn-remover" onclick="removerMembroGeral(${index})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function adicionarNovoMembro() {
            const input = document.getElementById('input-novo-membro');
            const novoMembro = input.value.trim().toUpperCase();

            if (!novoMembro) {
                alert('Digite o nome do novo membro!');
                return;
            }

            if (todosMembros.includes(novoMembro)) {
                alert('Este membro j√° existe no sistema!');
                return;
            }

            // Adicionar √† lista de membros
            todosMembros.push(novoMembro);
            
            // Atualizar interface
            atualizarListaTodosMembros();
            atualizarTodosSelects();
            
            // Limpar input
            input.value = '';
            
            alert(`‚úÖ Membro "${novoMembro}" adicionado com sucesso!\nAgora voc√™ pode inclu√≠-lo nos grupos e sequ√™ncias desejados.`);
        }

        function removerMembroGeral(index) {
            const membro = todosMembros[index];
            
            if (!confirm(`Tem certeza que deseja remover "${membro}" completamente do sistema?\n\nEle ser√° removido de todos os grupos e sequ√™ncias automaticamente.`)) return;

            // Remover da lista principal
            todosMembros.splice(index, 1);
            
            // Remover de todos os grupos e sequ√™ncias
            Object.keys(gruposPorDia).forEach(grupo => {
                const indiceNoGrupo = gruposPorDia[grupo].indexOf(membro);
                if (indiceNoGrupo !== -1) {
                    gruposPorDia[grupo].splice(indiceNoGrupo, 1);
                }
            });
            
            Object.keys(sequencias).forEach(seq => {
                const indiceNaSeq = sequencias[seq].indexOf(membro);
                if (indiceNaSeq !== -1) {
                    sequencias[seq].splice(indiceNaSeq, 1);
                }
            });
            
            // Atualizar toda a interface
            atualizarInterfaceGerenciador();
            
            alert(`‚úÖ Membro "${membro}" removido de todo o sistema!`);
        }

        function moverMembroGeral(index, direcao) {
            const novoIndex = index + direcao;

            if (novoIndex < 0 || novoIndex >= todosMembros.length) return;

            // Trocar posi√ß√µes
            [todosMembros[index], todosMembros[novoIndex]] = [todosMembros[novoIndex], todosMembros[index]];
            atualizarListaTodosMembros();
        }
        
        function atualizarTodosSelects() {
            // Atualizar todos os selects com a nova lista de membros
            const gruposSemanais = ['terca', 'quinta', 'sabado', 'domingoOficial'];
            const sequenciasEspeciais = ['rjm', 'rSetor', 'rLocal', 'ensaio'];
            
            gruposSemanais.forEach(grupo => {
                atualizarSelectMembros(grupo);
            });
            
            sequenciasEspeciais.forEach(seq => {
                atualizarSelectMembros(seq);
            });
        }

        // Inicializar com m√™s atual
        window.onload = function() {
            const hoje = new Date();
            const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesAno').value = mesAtual;
            gerarEscala();
        };

        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getDiaSemana(ano, mes, dia) {
            return new Date(ano, mes - 1, dia).getDay();
        }

        function encontrarNesimoDay(ano, mes, diaSemana, nesimo) {
            let contador = 0;
            const diasNoMes = getDiasNoMes(ano, mes);
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                if (getDiaSemana(ano, mes, dia) === diaSemana) {
                    contador++;
                    if (contador === nesimo) {
                        return dia;
                    }
                }
            }
            return null;
        }

        function temRLocal(mes) {
            return [1, 4, 7, 10].includes(mes);
        }

        function distribuirGrupoComFolga(grupo, totalOcorrencias, indiceInicial) {
            if (indiceInicial === undefined) indiceInicial = 0;
            const escalacao = [];
            let indiceAtual = indiceInicial;
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicoes = [];
                const indiceFolga = (indiceAtual + 3) % grupo.length;
                
                for (let j = 0; j < 3; j++) {
                    const indiceAtualPessoa = (indiceAtual + j) % grupo.length;
                    if (indiceAtualPessoa !== indiceFolga) {
                        posicoes.push(grupo[indiceAtualPessoa]);
                    }
                }
                
                while (posicoes.length < 3) {
                    for (let k = 0; k < grupo.length; k++) {
                        const indiceK = (indiceAtual + k) % grupo.length;
                        if (indiceK !== indiceFolga && !posicoes.includes(grupo[indiceK])) {
                            posicoes.push(grupo[indiceK]);
                            break;
                        }
                    }
                }
                
                escalacao.push({
                    pedOracao: posicoes[0],
                    principal: posicoes[1],
                    lateral: posicoes[2]
                });
                
                indiceAtual = indiceFolga;
            }
            
            return escalacao;
        }

        function distribuirGrupoSemFolga(grupo, totalOcorrencias, indiceInicial) {
            if (indiceInicial === undefined) indiceInicial = 0;
            const escalacao = [];
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicaoBase = (indiceInicial + i) % grupo.length;
                
                escalacao.push({
                    pedOracao: grupo[posicaoBase],
                    principal: grupo[(posicaoBase + 1) % grupo.length],
                    lateral: grupo[(posicaoBase + 2) % grupo.length]
                });
            }
            
            return escalacao;
        }

        function gerarEscala() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) return;

            const ano = parseInt(mesAnoValue.split('-')[0]);
            const mes = parseInt(mesAnoValue.split('-')[1]);
            const diasNoMes = getDiasNoMes(ano, mes);
            const escala = [];
            
            // Carregar √≠ndices salvos (continuidade entre meses)
            const indices = carregarIndices();
            let indiceRJM = indices.rjm;
            let indiceRSetor = indices.rSetor;
            let indiceRLocal = indices.rLocal;
            let indiceEnsaio = indices.ensaio;
            
            // √çndices para grupos semanais (NOVA FUNCIONALIDADE)
            let indiceTerca = indices.terca || 0;
            let indiceQuinta = indices.quinta || 0;
            let indiceSabado = indices.sabado || 0;
            let indiceDomingoOficial = indices.domingoOficial || 0;
            
            // Contar ocorr√™ncias
            const contadores = { terca: 0, quinta: 0, sabado: 0, domingo: 0 };
            const diasPorTipo = { terca: [], quinta: [], sabado: [], domingo: [] };
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const diaSemana = getDiaSemana(ano, mes, dia);
                
                if (diaSemana === 2) {
                    contadores.terca++;
                    diasPorTipo.terca.push(dia);
                } else if (diaSemana === 4) {
                    contadores.quinta++;
                    diasPorTipo.quinta.push(dia);
                } else if (diaSemana === 6) {
                    contadores.sabado++;
                    diasPorTipo.sabado.push(dia);
                } else if (diaSemana === 0) {
                    contadores.domingo++;
                    diasPorTipo.domingo.push(dia);
                }
            }

            // Gerar escala√ß√µes COM CONTINUIDADE
            const escalacaoTerca = distribuirGrupoComFolga(gruposPorDia.terca, contadores.terca, indiceTerca);
            const escalacaoQuinta = distribuirGrupoSemFolga(gruposPorDia.quinta, contadores.quinta, indiceQuinta);
            const escalacaoSabado = distribuirGrupoComFolga(gruposPorDia.sabado, contadores.sabado, indiceSabado);
            const escalacaoDomingo = distribuirGrupoComFolga(gruposPorDia.domingoOficial, contadores.domingo, indiceDomingoOficial);

            // 3¬™ feiras
            for (let i = 0; i < diasPorTipo.terca.length; i++) {
                const dia = diasPorTipo.terca[i];
                const escalacaoDia = escalacaoTerca[i];
                escala.push({
                    dia: dia,
                    diaSemana: '3¬™ FEIRA',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // 5¬™ feiras
            for (let i = 0; i < diasPorTipo.quinta.length; i++) {
                const dia = diasPorTipo.quinta[i];
                const escalacaoDia = escalacaoQuinta[i];
                escala.push({
                    dia: dia,
                    diaSemana: '5¬™ FEIRA',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // S√°bados
            for (let i = 0; i < diasPorTipo.sabado.length; i++) {
                const dia = diasPorTipo.sabado[i];
                const escalacaoDia = escalacaoSabado[i];
                escala.push({
                    dia: dia,
                    diaSemana: 'S√ÅBADO',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // Domingos
            for (let i = 0; i < diasPorTipo.domingo.length; i++) {
                const dia = diasPorTipo.domingo[i];
                
                // RJM primeiro - usando √≠ndice cont√≠nuo
                const membroRJM1 = sequencias.rjm[indiceRJM % sequencias.rjm.length];
                const membroRJM2 = sequencias.rjm[(indiceRJM + 1) % sequencias.rjm.length];
                indiceRJM += 2;

                escala.push({
                    dia: dia,
                    diaSemana: 'DOMINGO',
                    servico: 'RJM',
                    pedOracao: membroRJM1,
                    principal: '-',
                    lateral: membroRJM2,
                    classe: 'rjm'
                });

                // OFICIAL depois
                const escalacaoDia = escalacaoDomingo[i];
                escala.push({
                    dia: dia,
                    diaSemana: 'DOMINGO',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // R. SETOR - usando √≠ndice cont√≠nuo
            const terceiraSegunda = encontrarNesimoDay(ano, mes, 1, 3);
            if (terceiraSegunda) {
                escala.push({
                    dia: terceiraSegunda,
                    diaSemana: '2¬™ FEIRA',
                    servico: 'R. SETOR',
                    pedOracao: sequencias.rSetor[indiceRSetor % sequencias.rSetor.length],
                    principal: 'MESCLAR',
                    lateral: 'MESCLAR',
                    classe: 'rsetor',
                    mesclar: true
                });
                indiceRSetor++;
            }

            // R. LOCAL - usando √≠ndice cont√≠nuo
            if (temRLocal(mes)) {
                const quartaSegunda = encontrarNesimoDay(ano, mes, 1, 4);
                if (quartaSegunda) {
                    escala.push({
                        dia: quartaSegunda,
                        diaSemana: '2¬™ FEIRA',
                        servico: 'R. LOCAL',
                        pedOracao: sequencias.rLocal[indiceRLocal % sequencias.rLocal.length],
                        principal: 'MESCLAR',
                        lateral: 'MESCLAR',
                        classe: 'rlocal',
                        mesclar: true
                    });
                    indiceRLocal++;
                }
            }

            // ENSAIO - usando √≠ndice cont√≠nuo
            const quartaSexta = encontrarNesimoDay(ano, mes, 5, 4);
            if (quartaSexta) {
                const membroEnsaio1 = sequencias.ensaio[indiceEnsaio % sequencias.ensaio.length];
                const membroEnsaio2 = sequencias.ensaio[(indiceEnsaio + 1) % sequencias.ensaio.length];
                
                escala.push({
                    dia: quartaSexta,
                    diaSemana: '6¬™ FEIRA',
                    servico: 'ENSAIO',
                    pedOracao: membroEnsaio1,
                    principal: '-',
                    lateral: membroEnsaio2,
                    classe: 'ensaio'
                });
                indiceEnsaio += 2;
            }

            // CALCULAR E SALVAR NOVOS √çNDICES para pr√≥ximo m√™s
            
            // Para grupos com folga (4 pessoas): calcular pr√≥ximo √≠ndice baseado no √∫ltimo que folgou
            if (contadores.terca > 0) {
                indiceTerca = calcularProximoIndiceComFolga(gruposPorDia.terca, contadores.terca, indiceTerca);
            }
            if (contadores.sabado > 0) {
                indiceSabado = calcularProximoIndiceComFolga(gruposPorDia.sabado, contadores.sabado, indiceSabado);
            }
            if (contadores.domingo > 0) {
                indiceDomingoOficial = calcularProximoIndiceComFolga(gruposPorDia.domingoOficial, contadores.domingo, indiceDomingoOficial);
            }
            
            // Para grupo sem folga (3 pessoas): apenas avan√ßar
            if (contadores.quinta > 0) {
                indiceQuinta = (indiceQuinta + contadores.quinta) % gruposPorDia.quinta.length;
            }

            // Salvar os novos √≠ndices para continuidade
            salvarIndices({
                rjm: indiceRJM,
                rSetor: indiceRSetor,
                rLocal: indiceRLocal,
                ensaio: indiceEnsaio,
                terca: indiceTerca,
                quinta: indiceQuinta,
                sabado: indiceSabado,
                domingoOficial: indiceDomingoOficial
            });

            // Ordenar e exibir
            escala.sort(function(a, b) { return a.dia - b.dia; });
            escalaAtual = escala;
            exibirEscala(escala);
            detectarConflitos(escala);
        }

        // Fun√ß√£o para calcular pr√≥ximo √≠ndice em grupos com folga
        function calcularProximoIndiceComFolga(grupo, totalOcorrencias, indiceInicial) {
            let indiceAtual = indiceInicial;
            
            // Simular a distribui√ß√£o para encontrar o √∫ltimo que folgou
            for (let i = 0; i < totalOcorrencias; i++) {
                const indiceFolga = (indiceAtual + 3) % grupo.length;
                indiceAtual = indiceFolga; // Pr√≥ximo come√ßa com quem folgou
            }
            
            return indiceAtual;
        }

        function detectarConflitos(escala) {
            const conflitos = [];
            const diasComServicos = {};
            
            // Agrupar servi√ßos por dia
            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                if (!diasComServicos[item.dia]) {
                    diasComServicos[item.dia] = [];
                }
                diasComServicos[item.dia].push(item);
            }
            
            // Verificar conflitos no mesmo dia
            const dias = Object.keys(diasComServicos);
            for (let d = 0; d < dias.length; d++) {
                const dia = dias[d];
                const servicosDoDia = diasComServicos[dia];
                
                if (servicosDoDia.length > 1) {
                    for (let i = 0; i < servicosDoDia.length; i++) {
                        const servico1 = servicosDoDia[i];
                        for (let j = i + 1; j < servicosDoDia.length; j++) {
                            const servico2 = servicosDoDia[j];
                            
                            const pessoas1 = [servico1.pedOracao, servico1.principal, servico1.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            const pessoas2 = [servico2.pedOracao, servico2.principal, servico2.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            for (let p1 = 0; p1 < pessoas1.length; p1++) {
                                const pessoa = pessoas1[p1];
                                if (pessoas2.indexOf(pessoa) !== -1) {
                                    // Verificar se conflito j√° existe
                                    let conflitoDuplicado = false;
                                    for (let c = 0; c < conflitos.length; c++) {
                                        if (conflitos[c].dia === parseInt(dia) && conflitos[c].pessoa === pessoa) {
                                            conflitoDuplicado = true;
                                            break;
                                        }
                                    }
                                    
                                    if (!conflitoDuplicado) {
                                        conflitos.push({
                                            dia: parseInt(dia),
                                            pessoa: pessoa,
                                            servicos: [servico1.servico, servico2.servico]
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alertaDiv = document.getElementById('alertaConflitos');
            const listaDiv = document.getElementById('listaConflitos');
            
            if (conflitos.length === 0) {
                alertaDiv.style.display = 'none';
            } else {
                alertaDiv.style.display = 'block';
                let html = '';
                
                for (let i = 0; i < conflitos.length; i++) {
                    const conflito = conflitos[i];
                    const sugestoes = gerarSugestoesConflito(conflito);
                    
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p><strong>üìÖ Dia ${conflito.dia}:</strong> <span style="color: #d32f2f; font-weight: bold;">${conflito.pessoa}</span> escalado em ${conflito.servicos.join(' e ')}</p>`;
                    
                    if (sugestoes.length > 0) {
                        html += `<div style="margin-top: 8px;">
                            <p style="font-size: 12px; color: #1976d2; font-weight: bold;">üí° Sugest√µes de resolu√ß√£o:</p>`;
                        
                        sugestoes.forEach((sugestao, index) => {
                            const corBotao = index === 0 ? '#4caf50' : '#2196f3'; // Primeira sugest√£o em verde
                            html += `<div style="margin: 5px 0; padding: 6px 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ${corBotao};">
                                <span style="font-size: 12px;">${sugestao.descricao}</span>
                                <button onclick="aplicarSugestao(${conflito.dia}, '${sugestao.campo}', '${sugestao.valorAtual}', '${sugestao.novoValor}', '${sugestao.servico}')" 
                                        style="background: ${corBotao}; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin-left: 8px; cursor: pointer; font-size: 11px;">
                                    ‚ú® Aplicar
                                </button>
                            </div>`;
                        });
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
                
                listaDiv.innerHTML = html;
            }
        }

        // NOVA FUN√á√ÉO: Gerar sugest√µes inteligentes para resolver conflitos
        function gerarSugestoesConflito(conflito) {
            const sugestoes = [];
            const dia = conflito.dia;
            const pessoaConflito = conflito.pessoa;
            
            // Encontrar os servi√ßos em conflito neste dia
            const servicosDoDia = escalaAtual.filter(item => item.dia === dia);
            const servicosComPessoa = servicosDoDia.filter(item => 
                [item.pedOracao, item.principal, item.lateral].includes(pessoaConflito)
            );
            
            if (servicosComPessoa.length >= 2) {
                // Analisar cada servi√ßo e sugerir substitui√ß√µes
                servicosComPessoa.forEach((servico, index) => {
                    if (index > 0) { // Manter o primeiro, sugerir mudan√ßas nos outros
                        const campo = encontrarCampoPessoa(servico, pessoaConflito);
                        if (campo) {
                            const substituicoesSugeridas = encontrarSubstitutosPossiveis(servico, campo, dia);
                            
                            substituicoesSugeridas.forEach((substituto, subIndex) => {
                                const prioridade = subIndex === 0 ? 'ü•á' : subIndex === 1 ? 'ü•à' : 'ü•â';
                                sugestoes.push({
                                    descricao: `${prioridade} Substituir "${pessoaConflito}" por "${substituto}" no ${servico.servico} (${campo})`,
                                    campo: campo,
                                    valorAtual: pessoaConflito,
                                    novoValor: substituto,
                                    servico: servico.servico,
                                    prioridade: subIndex
                                });
                            });
                        }
                    }
                });
            }
            
            // Ordenar por prioridade (melhor sugest√£o primeiro)
            return sugestoes.sort((a, b) => a.prioridade - b.prioridade).slice(0, 3); // M√°ximo 3 sugest√µes
        }

        function encontrarCampoPessoa(servico, pessoa) {
            if (servico.pedOracao === pessoa) return 'pedOracao';
            if (servico.principal === pessoa) return 'principal';
            if (servico.lateral === pessoa) return 'lateral';
            return null;
        }

        function encontrarSubstitutosPossiveis(servico, campo, dia) {
            const substitutos = [];
            
            // Pessoas j√° escaladas neste dia (evitar)
            const pessoasJaEscaladas = [];
            escalaAtual.filter(item => item.dia === dia).forEach(item => {
                if (item.pedOracao && item.pedOracao !== '-' && item.pedOracao !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.pedOracao);
                }
                if (item.principal && item.principal !== '-' && item.principal !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.principal);
                }
                if (item.lateral && item.lateral !== '-' && item.lateral !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.lateral);
                }
            });
            
            // Determinar grupo relevante baseado no servi√ßo
            let grupoRelevante = [];
            const diaSemana = getDiaSemana(parseInt(document.getElementById('mesAno').value.split('-')[0]), 
                                         parseInt(document.getElementById('mesAno').value.split('-')[1]), dia);
            
            if (servico.servico === 'OFICIAL') {
                if (diaSemana === 2) grupoRelevante = gruposPorDia.terca;
                else if (diaSemana === 4) grupoRelevante = gruposPorDia.quinta;
                else if (diaSemana === 6) grupoRelevante = gruposPorDia.sabado;
                else if (diaSemana === 0) grupoRelevante = gruposPorDia.domingoOficial;
            } else {
                // Para servi√ßos especiais, usar toda a sequ√™ncia
                if (servico.servico === 'RJM') grupoRelevante = sequencias.rjm;
                else if (servico.servico === 'R. SETOR') grupoRelevante = sequencias.rSetor;
                else if (servico.servico === 'R. LOCAL') grupoRelevante = sequencias.rLocal;
                else if (servico.servico === 'ENSAIO') grupoRelevante = sequencias.ensaio;
            }
            
            // Sugerir pessoas do grupo relevante que n√£o est√£o escaladas no dia
            grupoRelevante.forEach(pessoa => {
                if (!pessoasJaEscaladas.includes(pessoa)) {
                    substitutos.push(pessoa);
                }
            });
            
            // Se n√£o h√° ningu√©m do grupo relevante dispon√≠vel, sugerir outros membros
            if (substitutos.length === 0) {
                todosMembros.forEach(pessoa => {
                    if (!pessoasJaEscaladas.includes(pessoa)) {
                        substitutos.push(pessoa);
                    }
                });
            }
            
            return substitutos.slice(0, 3); // M√°ximo 3 substitutos
        }

        // NOVA FUN√á√ÉO: Aplicar sugest√£o automaticamente
        function aplicarSugestao(dia, campo, valorAtual, novoValor, servico) {
            if (!confirm(`Aplicar sugest√£o?\n\nSubstituir "${valorAtual}" por "${novoValor}" no ${servico} do dia ${dia}?`)) {
                return;
            }
            
            // Encontrar o item na escala atual
            const indiceItem = escalaAtual.findIndex(item => 
                item.dia === dia && 
                item.servico === servico && 
                item[campo] === valorAtual
            );
            
            if (indiceItem !== -1) {
                // Aplicar a mudan√ßa
                escalaAtual[indiceItem][campo] = novoValor;
                
                // Atualizar a interface
                exibirEscala(escalaAtual);
                
                // Redetectar conflitos
                detectarConflitos(escalaAtual);
                
                // Mostrar feedback
                alert(`‚úÖ Sugest√£o aplicada com sucesso!\n\n"${valorAtual}" foi substitu√≠do por "${novoValor}" no ${servico} do dia ${dia}.`);
            } else {
                alert('‚ùå Erro ao aplicar sugest√£o. Tente fazer a altera√ß√£o manualmente.');
            }
        }

        function exibirEscala(escala) {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                const row = document.createElement('tr');
                
                if (item.mesclar) {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td colspan="3" class="mesclar"><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" oncontextmenu="editarCampo(' + i + ', \'pedOracao\'); return false;" ondblclick="editarCampo(' + i + ', \'pedOracao\')" title="Clique duplo ou bot√£o direito para editar">' + item.pedOracao + '</span></td>';
                } else {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" oncontextmenu="editarCampo(' + i + ', \'pedOracao\'); return false;" ondblclick="editarCampo(' + i + ', \'pedOracao\')" title="Clique duplo ou bot√£o direito para editar">' + item.pedOracao + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.principal + '\')" oncontextmenu="editarCampo(' + i + ', \'principal\'); return false;" ondblclick="editarCampo(' + i + ', \'principal\')" title="Clique duplo ou bot√£o direito para editar">' + item.principal + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.lateral + '\')" oncontextmenu="editarCampo(' + i + ', \'lateral\'); return false;" ondblclick="editarCampo(' + i + ', \'lateral\')" title="Clique duplo ou bot√£o direito para editar">' + item.lateral + '</span></td>';
                }
                
                tbody.appendChild(row);
            }
            
            // Aplicar destaques se houver membro selecionado
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        function destacarMembro(nome) {
            if (nome === '-' || nome === 'MESCLAR') return;
            
            if (membroDestacadoAtual === nome) {
                limparDestaque();
            } else {
                membroDestacadoAtual = nome;
                document.getElementById('nomeDestacado').textContent = nome;
                document.getElementById('membroDestacado').style.display = 'block';
                aplicarDestaques();
            }
        }

        function limparDestaque() {
            membroDestacadoAtual = null;
            document.getElementById('membroDestacado').style.display = 'none';
            
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                editaveis[i].classList.remove('destaque');
            }
        }

        function aplicarDestaques() {
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                const elemento = editaveis[i];
                if (elemento.textContent === membroDestacadoAtual) {
                    elemento.classList.add('destaque');
                } else {
                    elemento.classList.remove('destaque');
                }
            }
        }

        function editarCampo(indiceEscala, campo) {
            if (editandoAtualmente) return; // J√° est√° editando algo
            
            editandoAtualmente = { indice: indiceEscala, campo: campo };
            
            const valorAtual = escalaAtual[indiceEscala][campo];
            
            // Encontrar o elemento na tela
            const tbody = document.getElementById('corpoTabela');
            const rows = tbody.children;
            const targetRow = rows[indiceEscala];
            
            let targetCell;
            if (escalaAtual[indiceEscala].mesclar) {
                targetCell = targetRow.children[3].querySelector('.editavel');
            } else {
                const colIndex = campo === 'pedOracao' ? 3 : campo === 'principal' ? 4 : 5;
                targetCell = targetRow.children[colIndex].querySelector('.editavel');
            }
            
            // Criar dropdown
            const dropdown = document.createElement('select');
            dropdown.className = 'dropdown-edicao';
            
            // Adicionar op√ß√µes
            const opcaoVazia = document.createElement('option');
            opcaoVazia.value = '-';
            opcaoVazia.textContent = '-';
            dropdown.appendChild(opcaoVazia);
            
            for (let i = 0; i < todosMembros.length; i++) {
                const opcao = document.createElement('option');
                opcao.value = todosMembros[i];
                opcao.textContent = todosMembros[i];
                if (todosMembros[i] === valorAtual) {
                    opcao.selected = true;
                }
                dropdown.appendChild(opcao);
            }
            
            // Criar bot√µes
            const btnSalvar = document.createElement('button');
            btnSalvar.textContent = '‚úì';
            btnSalvar.className = 'btn-edicao';
            btnSalvar.onclick = function() { salvarEdicao(dropdown.value); };
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚úï';
            btnCancelar.className = 'btn-edicao btn-cancelar';
            btnCancelar.onclick = cancelarEdicao;
            
            // Substituir conte√∫do
            const conteudoOriginal = targetCell.innerHTML;
            targetCell.innerHTML = '';
            targetCell.appendChild(dropdown);
            targetCell.appendChild(btnSalvar);
            targetCell.appendChild(btnCancelar);
            targetCell.classList.add('editando');
            
            // Focar no dropdown
            dropdown.focus();
            
            // Salvar refer√™ncia para cancelar
            editandoAtualmente.elementoOriginal = targetCell;
            editandoAtualmente.conteudoOriginal = conteudoOriginal;
        }

        function salvarEdicao(novoValor) {
            if (!editandoAtualmente) return;
            
            // Atualizar dados
            escalaAtual[editandoAtualmente.indice][editandoAtualmente.campo] = novoValor;
            
            // Restaurar elemento
            const elemento = editandoAtualmente.elementoOriginal;
            const indice = editandoAtualmente.indice;
            const campo = editandoAtualmente.campo;
            
            elemento.innerHTML = '<span class="editavel" onclick="destacarMembro(\'' + novoValor + '\')" oncontextmenu="editarCampo(' + indice + ', \'' + campo + '\'); return false;" ondblclick="editarCampo(' + indice + ', \'' + campo + '\')" title="Clique duplo ou bot√£o direito para editar">' + novoValor + '</span>';
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
            
            // Redetectar conflitos
            detectarConflitos(escalaAtual);
            
            // Reaplicar destaques
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        function cancelarEdicao() {
            if (!editandoAtualmente) return;
            
            // Restaurar conte√∫do original
            const elemento = editandoAtualmente.elementoOriginal;
            elemento.innerHTML = editandoAtualmente.conteudoOriginal;
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
        }

        function gerarPDF() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) {
                alert('Selecione um m√™s primeiro!');
                return;
            }

            const ano = mesAnoValue.split('-')[0];
            const mes = mesAnoValue.split('-')[1];
            const meses = [
                'JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'
            ];
            const mesNome = meses[parseInt(mes) - 1];
            
            // Construir linhas HTML com cores baseadas na escala atual
            let linhasHTML = '';
            for (let i = 0; i < escalaAtual.length; i++) {
                const item = escalaAtual[i];
                
                // Determinar cor de fundo baseada no servi√ßo
                let corFundo = '';
                switch(item.servico) {
                    case 'OFICIAL':
                        corFundo = '#e3f2fd';
                        break;
                    case 'RJM':
                        corFundo = '#e8f5e8';
                        break;
                    case 'R. SETOR':
                        corFundo = '#fff3e0';
                        break;
                    case 'R. LOCAL':
                        corFundo = '#f3e5f5';
                        break;
                    case 'ENSAIO':
                        corFundo = '#e8eaf6';
                        break;
                    default:
                        corFundo = '#ffffff';
                }
                
                if (item.mesclar) {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td colspan="3" style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                    </tr>`;
                } else {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.principal}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.lateral}</td>
                    </tr>`;
                }
            }
            
            const htmlContent = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Escala de Porteiros - ${mesNome} ${ano}</title>
                <style>
                    @page { 
                        margin: 2cm; 
                        size: A4; 
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 0; 
                        padding: 0; 
                        color: #333; 
                    }
                    .cabecalho { 
                        text-align: center; 
                        margin-bottom: 30px; 
                    }
                    .cabecalho h1 { 
                        font-size: 16px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h2 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h3 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        font-size: 12px; 
                    }
                    th { 
                        background-color: #f0f0f0; 
                        font-weight: bold; 
                        text-align: center; 
                        padding: 10px 8px; 
                        border: 1px solid #333; 
                    }
                    td { 
                        text-align: center; 
                        padding: 8px; 
                        border: 1px solid #333; 
                    }
                    
                    /* Configura√ß√µes para impress√£o colorida */
                    @media print {
                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="cabecalho">
                    <h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
                    <h2>ESCALA DE PORTEIROS</h2>
                    <h3>${mesNome} DE ${ano}</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DIA</th>
                            <th>DIA DA SEMANA</th>
                            <th>SERVI√áO</th>
                            <th>PED ORA√á√ÉO</th>
                            <th>PRINCIPAL</th>
                            <th>LATERAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhasHTML}
                    </tbody>
                </table>
            </body>
            </html>`;
            
            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(htmlContent);
            novaJanela.document.close();
            setTimeout(function() { 
                novaJanela.print(); 
            }, 1000);
        }
    </script>
</body>
</html>
