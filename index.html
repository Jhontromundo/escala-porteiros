<!-- Modal Grupos -->
    <div id="modalGrupos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Gerenciar Grupos</h3>
                <button class="close" onclick="fecharModalGrupos()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grupos-grid" id="gruposContainer"></div>
            </div>
            <div class="modal-footer">
                <button onclick="salvarGrupos()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Salvar</button>
                <button onclick="resetarGrupos()" style="background: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üîÑ Resetar</button>
                <button onclick="fecharModalGrupos()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div><!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escalas CCB - Santa Am√©lia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 { color: #1976d2; font-size: 28px; margin-bottom: 5px; }
        .header p { color: #666; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls input, .controls button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn { 
            cursor: pointer; 
            font-weight: 600; 
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #1976d2; color: white; }
        .btn-secondary { background: #ff5722; color: white; }
        .btn-manager { background: #9c27b0; color: white; }
        .btn-groups { background: #2e7d32; color: white; }
        
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f5f5f5; font-weight: bold; }
        tr:nth-child(even) { background: #fafafa; }
        
        .nome-editavel { 
            cursor: pointer; 
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .nome-editavel:hover { background: #e3f2fd; color: #1976d2; }
        
        .servico-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .oficial { background: #e3f2fd; color: #0d47a1; }
        .rjm { background: #e8f5e8; color: #1b5e20; }
        .rsetor { background: #fff3e0; color: #e65100; }
        .rlocal { background: #f3e5f5; color: #4a148c; }
        .ensaio { background: #e8eaf6; color: #1a237e; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            background: #1976d2;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; background: #f8f9fa; text-align: center; }
        
        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .grupos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grupo-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .grupo-titulo {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        
        .membros-lista {
            min-height: 80px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        
        .membro-item {
            display: inline-block;
            background: white;
            padding: 5px 8px;
            margin: 2px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-size: 12px;
            cursor: pointer;
        }
        
        .membro-item:hover { background: #f44336; color: white; }
        
        .pessoa-disponivel {
            display: inline-block;
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .pessoa-disponivel:hover { background: #4caf50; color: white; }
        
        .nome-destacado {
            background: #ffeb3b !important;
            color: #f57f17 !important;
            font-weight: bold !important;
            box-shadow: 0 0 8px rgba(255, 235, 59, 0.8) !important;
            transform: scale(1.05) !important;
        }
        
        .conflito-alert {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .conflito-item {
            background: white;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
        }
        
        .btn-resolver {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .btn-resolver:hover {
            background: #45a049;
        }
        
        .pessoas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .pessoa-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        
        .btn-remove { 
            background: #f44336; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            cursor: pointer;
            font-size: 12px;
        }
        
        .escala-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }
        
        .escala-card:hover {
            border-color: #1976d2;
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.1);
        }
        
        .escala-info h4 {
            color: #1976d2;
            margin-bottom: 5px;
            font-size: 18px;
        }
        
        .escala-info p {
            color: #666;
            margin: 2px 0;
            font-size: 14px;
        }
        
        .escala-acoes {
            display: flex;
            gap: 8px;
        }
        
        .btn-escala {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-carregar { background: #4caf50; color: white; }
        .btn-deletar { background: #f44336; color: white; }
        
        .btn-escala:hover { transform: translateY(-1px); opacity: 0.9; }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls input, .controls button { width: 100%; margin-bottom: 10px; }
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Sistema de Escalas CCB</h1>
            <p>Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <label for="mesAno">üìÖ M√™s:</label>
            <input type="month" id="mesAno">
            <button class="btn btn-primary" onclick="gerarEscala()">üîÑ Gerar Escala</button>
            <button class="btn btn-secondary" onclick="gerarPDF()">üìÑ PDF</button>
            <button class="btn btn-manager" onclick="abrirModalPessoas()">üë• Pessoas</button>
            <button class="btn btn-groups" onclick="abrirModalGrupos()">‚öôÔ∏è Grupos</button>
            <button class="btn" style="background: #795548; color: white;" onclick="abrirModalEscalas()">üìã Escalas</button>
        </div>
        
        <div class="conflito-alert" id="conflitoAlert">
            <h4 style="color: #d32f2f; margin-bottom: 10px;">üö® Conflitos Detectados!</h4>
            <div id="listaConflitos"></div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Pessoas -->
    <div id="modalPessoas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Gerenciar Pessoas</h3>
                <button class="close" onclick="fecharModalPessoas()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="novaPessoa" placeholder="Nome da pessoa..." style="width: 70%; padding: 8px;">
                    <button onclick="adicionarPessoa()" style="padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Adicionar</button>
                </div>
                <div class="pessoas-grid" id="listaPessoas"></div>
            </div>
            <div class="modal-footer">
                <button onclick="salvarPessoas()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Salvar</button>
                <button onclick="fecharModalPessoas()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Escalas -->
    <div id="modalEscalas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Gerenciador de Escalas</h3>
                <button class="close" onclick="fecharModalEscalas()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #1976d2;">
                    <strong>üí° Informa√ß√µes:</strong><br>
                    ‚Ä¢ <strong>Visualizar:</strong> Veja quantos servi√ßos cada escala possui<br>
                    ‚Ä¢ <strong>Deletar:</strong> Remove a escala para poder gerar uma nova<br>
                    ‚Ä¢ <strong>Carregar:</strong> Seleciona o m√™s e carrega a escala
                </div>
                <div id="listaEscalasSalvas"></div>
                <div id="nenhumaEscala" style="text-align: center; color: #666; padding: 40px; display: none;">
                    <h3>üì≠ Nenhuma escala salva</h3>
                    <p>Gere sua primeira escala selecionando um m√™s!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="limparTodasEscalas()" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Limpar Todas</button>
                <button onclick="fecharModalEscalas()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Gerenciar Grupos</h3>
                <button class="close" onclick="fecharModalGrupos()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grupos-grid" id="gruposContainer"></div>
            </div>
            <div class="modal-footer">
                <button onclick="salvarGrupos()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Salvar</button>
                <button onclick="resetarGrupos()" style="background: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üîÑ Resetar</button>
                <button onclick="fecharModalGrupos()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== DADOS PADR√ÉO ==========
        const GRUPOS_PADRAO = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        const SEQUENCIAS_PADRAO = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN', 'ALGACIR', 'SAULO', 'RODINEI', 'SAMUEL', 'C√âLIO', 'JONAS', 'AFONSO'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'JONAS', 'C√âLIO', 'EDI', 'SAMUEL', 'JOS√â CARLOS', 'MARCOS', 'EDIVAN', 'SAULO'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'C√âLIO', 'SAULO', 'MARCOS'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL', 'EDIVAN', 'MARCOS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'JONAS']
        };

        const GRUPOS_INFO = {
            terca: { nome: '3¬™ FEIRAS', classe: 'oficial' },
            quinta: { nome: '5¬™ FEIRAS', classe: 'oficial' },
            sabado: { nome: 'S√ÅBADOS', classe: 'oficial' },
            domingoOficial: { nome: 'DOMINGOS', classe: 'oficial' },
            rjm: { nome: 'RJM', classe: 'rjm' },
            rSetor: { nome: 'R. SETOR', classe: 'rsetor' },
            rLocal: { nome: 'R. LOCAL', classe: 'rlocal' },
            ensaio: { nome: 'ENSAIO', classe: 'ensaio' }
        };

        // ========== ESCALA BASE FIXA DE AGOSTO 2025 ==========
        const ESCALA_AGOSTO_2025 = [
            {dia: 2, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', pedOracao: 'JOS√â CARLOS', principal: 'RODINEI', lateral: 'VANDERLEI', classe: 'oficial'},
            {dia: 3, diaSemana: 'DOMINGO', servico: 'RJM', pedOracao: 'ELIZEU', principal: '-', lateral: 'ZANIN', classe: 'rjm'},
            {dia: 3, diaSemana: 'DOMINGO', servico: 'OFICIAL', pedOracao: 'EDIVAN', principal: 'JOS√â CARDOSO', lateral: 'ODEMIR', classe: 'oficial'},
            {dia: 5, diaSemana: '3¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'AFONSO', principal: 'ALGACIR', lateral: 'JONAS', classe: 'oficial'},
            {dia: 7, diaSemana: '5¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'EDI', principal: 'MARCOS', lateral: 'SAULO', classe: 'oficial'},
            {dia: 9, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', pedOracao: 'ELIZEU', principal: 'JOS√â CARLOS', lateral: 'RODINEI', classe: 'oficial'},
            {dia: 10, diaSemana: 'DOMINGO', servico: 'RJM', pedOracao: 'ALGACIR', principal: '-', lateral: 'EDI', classe: 'rjm'},
            {dia: 10, diaSemana: 'DOMINGO', servico: 'OFICIAL', pedOracao: 'SAMUEL', principal: 'EDIVAN', lateral: 'JOS√â CARDOSO', classe: 'oficial'},
            {dia: 12, diaSemana: '3¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'ZANIN', principal: 'AFONSO', lateral: 'ALGACIR', classe: 'oficial'},
            {dia: 14, diaSemana: '5¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'SAULO', principal: 'EDI', lateral: 'MARCOS', classe: 'oficial'},
            {dia: 16, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', pedOracao: 'RODINEI', principal: 'VANDERLEI', lateral: 'ELIZEU', classe: 'oficial'},
            {dia: 17, diaSemana: 'DOMINGO', servico: 'RJM', pedOracao: 'JOS√â CARDOSO', principal: '-', lateral: 'C√âLIO', classe: 'rjm'},
            {dia: 17, diaSemana: 'DOMINGO', servico: 'OFICIAL', pedOracao: 'ODEMIR', principal: 'SAMUEL', lateral: 'EDIVAN', classe: 'oficial'},
            {dia: 18, diaSemana: '2¬™ FEIRA', servico: 'R. SETOR', pedOracao: 'JONAS', principal: 'MESCLAR', lateral: 'MESCLAR', classe: 'rsetor', mesclar: true},
            {dia: 19, diaSemana: '3¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'JONAS', principal: 'ZANIN', lateral: 'AFONSO', classe: 'oficial'},
            {dia: 21, diaSemana: '5¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'MARCOS', principal: 'SAULO', lateral: 'EDI', classe: 'oficial'},
            {dia: 22, diaSemana: '6¬™ FEIRA', servico: 'ENSAIO', pedOracao: 'AFONSO', principal: '-', lateral: 'MARCOS', classe: 'ensaio'},
            {dia: 23, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', pedOracao: 'JOS√â CARLOS', principal: 'RODINEI', lateral: 'VANDERLEI', classe: 'oficial'},
            {dia: 24, diaSemana: 'DOMINGO', servico: 'RJM', pedOracao: 'C√âLIO', principal: '-', lateral: 'EDIVAN', classe: 'rjm'},
            {dia: 24, diaSemana: 'DOMINGO', servico: 'OFICIAL', pedOracao: 'JOS√â CARDOSO', principal: 'ODEMIR', lateral: 'SAMUEL', classe: 'oficial'},
            {dia: 26, diaSemana: '3¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'ALGACIR', principal: 'JONAS', lateral: 'ZANIN', classe: 'oficial'},
            {dia: 28, diaSemana: '5¬™ FEIRA', servico: 'OFICIAL', pedOracao: 'EDI', principal: 'MARCOS', lateral: 'SAULO', classe: 'oficial'},
            {dia: 30, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', pedOracao: 'ELIZEU', principal: 'JOS√â CARLOS', lateral: 'RODINEI', classe: 'oficial'},
            {dia: 31, diaSemana: 'DOMINGO', servico: 'RJM', pedOracao: 'SAULO', principal: '-', lateral: 'VANDERLEI', classe: 'rjm'},
            {dia: 31, diaSemana: 'DOMINGO', servico: 'OFICIAL', pedOracao: 'EDIVAN', principal: 'JOS√â CARDOSO', lateral: 'ODEMIR', classe: 'oficial'}
        ];

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let grupos = JSON.parse(JSON.stringify(GRUPOS_PADRAO));
        let sequencias = JSON.parse(JSON.stringify(SEQUENCIAS_PADRAO));
        let pessoas = ['AFONSO', 'ALGACIR', 'C√âLIO', 'EDI', 'EDIVAN', 'ELIZEU', 'JONAS', 'JOS√â CARDOSO', 'JOS√â CARLOS', 'MARCOS', 'ODEMIR', 'RODINEI', 'SAMUEL', 'SAULO', 'VANDERLEI', 'ZANIN'];
        
        // ========== √çNDICES AJUSTADOS PARA CONTINUIDADE AGOSTO ‚Üí SETEMBRO ==========
        let indices = { 
            rjm: 10,              // Pr√≥ximo: RODINEI (ap√≥s SAULO que foi √∫ltimo em agosto)
            rSetor: 8,            // Pr√≥ximo: C√âLIO (seguindo sequ√™ncia R.Setor)
            rLocal: 1,            // Pr√≥ximo: SAMUEL (R.Local em outubro - ap√≥s RODINEI em julho)
            ensaio: 4,            // Pr√≥ximos: C√âLIO + EDI (ap√≥s AFONSO + MARCOS em agosto)
            terca: 0,             // AFONSO (reinicia sequ√™ncia)
            quinta: 0,            // EDI (reinicia sequ√™ncia)
            sabado: 2,            // VANDERLEI (continua sequ√™ncia)
            domingoOficial: 2     // SAMUEL (ap√≥s EDIVAN que foi √∫ltimo pedOracao em agosto)
        };
        
        let escalaAtual = [];
        let escalas = {};

        // ========== INICIALIZA√á√ÉO ==========
        window.onload = function() {
            carregarDados();
            
            // Fixa a escala de agosto 2025 no sistema
            escalas['2025-08'] = ESCALA_AGOSTO_2025;
            
            // FOR√áA os √≠ndices corretos baseados na escala de agosto (sobrescreve localStorage)
            indices = { 
                rjm: 10,              // Pr√≥ximo: RODINEI (ap√≥s SAULO)
                rSetor: 8,            // Pr√≥ximo: C√âLIO 
                rLocal: 1,            // Pr√≥ximo: SAMUEL (outubro)
                ensaio: 4,            // Pr√≥ximos: C√âLIO + EDI
                terca: 0,             // AFONSO (Zanin folga ap√≥s ser lateral)
                quinta: 2,            // SAULO (foi lateral em agosto, agora pedOracao)
                sabado: 2,            // VANDERLEI 
                domingoOficial: 2     // SAMUEL (ap√≥s EDIVAN)
            };
            
            const hoje = new Date();
            const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
            
            // Define setembro como padr√£o se estivermos em 2025
            if (mesAtual >= '2025-09') {
                document.getElementById('mesAno').value = '2025-09';
            } else {
                document.getElementById('mesAno').value = mesAtual;
            }
            
            // Event listeners
            document.getElementById('novaPessoa').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adicionarPessoa();
            });
            
            setTimeout(function() {
                if (document.getElementById('mesAno').value) {
                    gerarEscala();
                }
            }, 100);
        };

        // ========== PERSIST√äNCIA ==========
        function salvarDados() {
            localStorage.setItem('ccb_escalas', JSON.stringify({ grupos, sequencias, pessoas, indices, escalas }));
        }

        function carregarDados() {
            const dados = localStorage.getItem('ccb_escalas');
            if (dados) {
                const parsed = JSON.parse(dados);
                grupos = parsed.grupos || grupos;
                sequencias = parsed.sequencias || sequencias;
                pessoas = parsed.pessoas || pessoas;
                indices = parsed.indices || indices;
                escalas = parsed.escalas || escalas;
            }
        }

        // ========== UTILIT√ÅRIOS DE DATA ==========
        function getDiaSemana(ano, mes, dia) { 
            const data = new Date(ano, mes - 1, dia);
            const diasSemana = ['DOMINGO', '2¬™ FEIRA', '3¬™ FEIRA', '4¬™ FEIRA', '5¬™ FEIRA', '6¬™ FEIRA', 'S√ÅBADO'];
            return { numero: data.getDay(), nome: diasSemana[data.getDay()] };
        }
        function getDiasNoMes(ano, mes) { return new Date(ano, mes, 0).getDate(); }
        
        function encontrarDia(ano, mes, diaSemana, n) {
            let count = 0;
            for (let dia = 1; dia <= getDiasNoMes(ano, mes); dia++) {
                if (getDiaSemana(ano, mes, dia).numero === diaSemana) {
                    count++;
                    if (count === n) return dia;
                }
            }
            return null;
        }

        function temRLocal(mes) {
            return [1, 4, 7, 10].includes(mes);
        }

        // ========== ALGORITMOS DE DISTRIBUI√á√ÉO ==========
        function distribuirGrupo(grupo, total, indice, comFolga = true) {
            const result = [];
            let idx = indice;
            
            for (let i = 0; i < total; i++) {
                if (comFolga) {
                    const folga = (idx + 3) % grupo.length;
                    const pos = [];
                    for (let j = 0; j < grupo.length; j++) {
                        const p = (idx + j) % grupo.length;
                        if (p !== folga) pos.push(grupo[p]);
                        if (pos.length === 3) break;
                    }
                    result.push({ pedOracao: pos[0], principal: pos[1], lateral: pos[2] });
                    idx = folga;
                } else {
                    const base = idx % grupo.length;
                    result.push({
                        pedOracao: grupo[base],
                        principal: grupo[(base + 1) % grupo.length],
                        lateral: grupo[(base + 2) % grupo.length]
                    });
                    idx++;
                }
            }
            
            return { escalacao: result, proximoIndice: idx };
        }

        function distribuirSequencia(seq, qtd, indice) {
            const result = [];
            for (let i = 0; i < qtd; i++) {
                result.push(seq[(indice + i) % seq.length]);
            }
            return { membros: result, proximoIndice: (indice + qtd) % seq.length };
        }

        // ========== GERA√á√ÉO DE ESCALA ==========
        function gerarEscala() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) return;

            // Bloqueia gera√ß√£o anterior a setembro/2025
            if (mesAno < '2025-09') {
                alert('üö´ Gera√ß√£o Bloqueada!\n\nEscalas anteriores a setembro de 2025 n√£o s√£o permitidas.\n\nüìã A escala de agosto/2025 j√° est√° definida como base.\n\n‚úÖ Selecione setembro/2025 ou posterior.');
                document.getElementById('mesAno').value = '2025-09';
                return;
            }

            // Se for agosto, carrega a escala fixa
            if (mesAno === '2025-08') {
                escalaAtual = ESCALA_AGOSTO_2025;
                exibirEscala();
                detectarConflitos();
                alert('üìã Escala Base de Agosto!\n\nEsta √© a escala oficial de agosto de 2025 (imut√°vel).\n\n‚úÖ Serve como base para continuidade das pr√≥ximas escalas.');
                return;
            }

            if (escalas[mesAno]) {
                escalaAtual = escalas[mesAno];
                exibirEscala();
                detectarConflitos();
                
                // Exibe mensagem informativa
                const ano = mesAno.split('-')[0];
                const mes = parseInt(mesAno.split('-')[1]);
                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const mesNome = meses[mes - 1];
                
                alert(`üìã Escala j√° existe!\n\nA escala de ${mesNome} de ${ano} j√° foi gerada anteriormente e foi carregada.\n\n‚úÖ Total: ${escalaAtual.length} servi√ßos programados\n\nüí° Para gerar uma nova escala, delete a atual primeiro ou edite manualmente.`);
                
                return;
            }

            const ano = parseInt(mesAno.split('-')[0]);
            const mes = parseInt(mesAno.split('-')[1]);
            const diasNoMes = getDiasNoMes(ano, mes);
            
            const dias = { terca: [], quinta: [], sabado: [], domingo: [] };
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const diaSemana = getDiaSemana(ano, mes, dia);
                if (diaSemana.numero === 2) dias.terca.push(dia);
                else if (diaSemana.numero === 4) dias.quinta.push(dia);
                else if (diaSemana.numero === 6) dias.sabado.push(dia);
                else if (diaSemana.numero === 0) dias.domingo.push(dia);
            }

            const resultTerca = distribuirGrupo(grupos.terca, dias.terca.length, indices.terca, true);
            const resultQuinta = distribuirGrupo(grupos.quinta, dias.quinta.length, indices.quinta, false);
            const resultSabado = distribuirGrupo(grupos.sabado, dias.sabado.length, indices.sabado, true);
            const resultDomingo = distribuirGrupo(grupos.domingoOficial, dias.domingo.length, indices.domingoOficial, true);

            const resultRJM = distribuirSequencia(sequencias.rjm, dias.domingo.length * 2, indices.rjm);
            const resultRSetor = distribuirSequencia(sequencias.rSetor, 1, indices.rSetor);
            const resultRLocal = distribuirSequencia(sequencias.rLocal, [1,4,7,10].includes(mes) ? 1 : 0, indices.rLocal);
            const resultEnsaio = distribuirSequencia(sequencias.ensaio, 2, indices.ensaio);

            escalaAtual = [];
            let idxRJM = 0;

            // 3¬™ feiras
            dias.terca.forEach((dia, i) => {
                const esc = resultTerca.escalacao[i];
                const diaSemana = getDiaSemana(ano, mes, dia);
                escalaAtual.push({
                    dia, diaSemana: diaSemana.nome, servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // 5¬™ feiras
            dias.quinta.forEach((dia, i) => {
                const esc = resultQuinta.escalacao[i];
                const diaSemana = getDiaSemana(ano, mes, dia);
                escalaAtual.push({
                    dia, diaSemana: diaSemana.nome, servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // S√°bados
            dias.sabado.forEach((dia, i) => {
                const esc = resultSabado.escalacao[i];
                const diaSemana = getDiaSemana(ano, mes, dia);
                escalaAtual.push({
                    dia, diaSemana: diaSemana.nome, servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // Domingos
            dias.domingo.forEach((dia, i) => {
                const diaSemana = getDiaSemana(ano, mes, dia);
                escalaAtual.push({
                    dia, diaSemana: diaSemana.nome, servico: 'RJM', classe: 'rjm',
                    pedOracao: resultRJM.membros[idxRJM], principal: '-', lateral: resultRJM.membros[idxRJM + 1]
                });
                idxRJM += 2;

                const esc = resultDomingo.escalacao[i];
                escalaAtual.push({
                    dia, diaSemana: diaSemana.nome, servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // R. SETOR
            const seg3 = encontrarDia(ano, mes, 1, 3);
            if (seg3) {
                escalaAtual.push({
                    dia: seg3, diaSemana: '2¬™ FEIRA', servico: 'R. SETOR', classe: 'rsetor',
                    pedOracao: resultRSetor.membros[0], principal: 'MESCLAR', lateral: 'MESCLAR', mesclar: true
                });
            }

            // R. LOCAL - Apenas em Jan/Abr/Jul/Out
            if (temRLocal(mes)) {
                const quartaSegunda = encontrarDia(ano, mes, 1, 4);
                if (quartaSegunda && resultRLocal.membros.length > 0) {
                    escalaAtual.push({
                        dia: quartaSegunda, diaSemana: '2¬™ FEIRA', servico: 'R. LOCAL', classe: 'rlocal',
                        pedOracao: resultRLocal.membros[0], principal: 'MESCLAR', lateral: 'MESCLAR', mesclar: true
                    });
                }
            }

            // ENSAIO
            const sex4 = encontrarDia(ano, mes, 5, 4);
            if (sex4) {
                escalaAtual.push({
                    dia: sex4, diaSemana: '6¬™ FEIRA', servico: 'ENSAIO', classe: 'ensaio',
                    pedOracao: resultEnsaio.membros[0], principal: '-', lateral: resultEnsaio.membros[1]
                });
            }

            escalaAtual.sort((a, b) => a.dia - b.dia);

            // Atualizar √≠ndices - ESPECIAL para 5¬™ feira (rotatividade lateral‚ÜípedOracao)
            indices.terca = resultTerca.proximoIndice;
            indices.sabado = resultSabado.proximoIndice;
            indices.domingoOficial = resultDomingo.proximoIndice;
            indices.rjm = resultRJM.proximoIndice;
            indices.rSetor = resultRSetor.proximoIndice;
            if (temRLocal(mes)) {
                indices.rLocal = resultRLocal.proximoIndice;
            }
            indices.ensaio = resultEnsaio.proximoIndice;
            
            // 5¬™ feira: quem foi lateral no √∫ltimo servi√ßo deve ser pedOracao no pr√≥ximo m√™s
            if (dias.quinta.length > 0) {
                const ultimaQuinta = resultQuinta.escalacao[resultQuinta.escalacao.length - 1];
                const ultimoLateral = ultimaQuinta.lateral;
                const posicaoUltimoLateral = grupos.quinta.indexOf(ultimoLateral);
                indices.quinta = posicaoUltimoLateral >= 0 ? posicaoUltimoLateral : resultQuinta.proximoIndice;
            } else {
                indices.quinta = resultQuinta.proximoIndice;
            }

            escalas[mesAno] = [...escalaAtual];
            salvarDados();
            exibirEscala();
            detectarConflitos();
        }

        // ========== EXIBI√á√ÉO ==========
        function exibirEscala() {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            escalaAtual.forEach((item, i) => {
                const row = document.createElement('tr');
                
                if (item.mesclar) {
                    row.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td colspan="3" style="background: #f0f0f0;">${item.pedOracao}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="pedOracao">${item.pedOracao}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="principal">${item.principal}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="lateral">${item.lateral}</span></td>
                    `;
                }
                
                tbody.appendChild(row);
            });

            // Event listeners para edi√ß√£o e destaque
            document.querySelectorAll('.nome-editavel').forEach(span => {
                // Clique simples para destacar
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    destacarPessoa(this.textContent);
                });
                
                // Duplo clique para editar
                span.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    const atual = this.textContent;
                    const select = document.createElement('select');
                    pessoas.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = p;
                        if (p === atual) opt.selected = true;
                        select.appendChild(opt);
                    });
                    
                    const confirmar = document.createElement('button');
                    confirmar.textContent = '‚úì';
                    confirmar.style.cssText = 'margin-left: 5px; padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 3px; cursor: pointer;';
                    confirmar.onclick = () => {
                        const i = parseInt(this.dataset.index);
                        const campo = this.dataset.campo;
                        escalaAtual[i][campo] = select.value;
                        this.textContent = select.value;
                        
                        const mesAno = document.getElementById('mesAno').value;
                        escalas[mesAno] = [...escalaAtual];
                        salvarDados();
                        detectarConflitos();
                        
                        // Reaplica destaque se a pessoa ainda estava destacada
                        if (pessoaDestacada) {
                            setTimeout(() => destacarPessoa(pessoaDestacada), 100);
                        }
                    };
                    
                    this.innerHTML = '';
                    this.appendChild(select);
                    this.appendChild(confirmar);
                    select.focus();
                });
            });
        }

        // ========== SISTEMA DE DESTAQUE ==========
        let pessoaDestacada = null;

        function destacarPessoa(pessoa) {
            // Remove destaques anteriores
            document.querySelectorAll('.nome-destacado').forEach(el => {
                el.classList.remove('nome-destacado');
            });
            
            // Se clicou na mesma pessoa, remove destaque
            if (pessoaDestacada === pessoa) {
                pessoaDestacada = null;
                return;
            }
            
            // Destaca todas as ocorr√™ncias da nova pessoa
            pessoaDestacada = pessoa;
            document.querySelectorAll('.nome-editavel').forEach(span => {
                if (span.textContent === pessoa) {
                    span.classList.add('nome-destacado');
                }
            });
        }

        function removerDestaque() {
            document.querySelectorAll('.nome-destacado').forEach(el => {
                el.classList.remove('nome-destacado');
            });
            pessoaDestacada = null;
        }

        // ========== DETEC√á√ÉO E RESOLU√á√ÉO DE CONFLITOS ==========
        function detectarConflitos() {
            const conflitos = [];
            const servicosPorDia = {};

            // Agrupa servi√ßos por dia
            escalaAtual.forEach((item, index) => {
                if (!servicosPorDia[item.dia]) {
                    servicosPorDia[item.dia] = [];
                }
                servicosPorDia[item.dia].push({...item, index: index});
            });

            // Detecta conflitos
            Object.entries(servicosPorDia).forEach(([dia, servicos]) => {
                const pessoasNoDia = {};
                
                servicos.forEach((servico, servicoIndex) => {
                    [servico.pedOracao, servico.principal, servico.lateral].forEach((pessoa, posicao) => {
                        if (pessoa && pessoa !== '-' && pessoa !== 'MESCLAR') {
                            if (!pessoasNoDia[pessoa]) {
                                pessoasNoDia[pessoa] = [];
                            }
                            pessoasNoDia[pessoa].push({
                                servico: servico.servico,
                                posicao: ['pedOracao', 'principal', 'lateral'][posicao],
                                index: servico.index,
                                servicoIndex: servicoIndex
                            });
                        }
                    });
                });

                // Identifica pessoas com m√∫ltiplas escala√ß√µes no mesmo dia
                Object.entries(pessoasNoDia).forEach(([pessoa, escalacoes]) => {
                    if (escalacoes.length > 1) {
                        const temRJM = escalacoes.some(e => e.servico === 'RJM');
                        const temOficial = escalacoes.some(e => e.servico === 'OFICIAL');
                        
                        if (temRJM && temOficial) {
                            conflitos.push({
                                dia: parseInt(dia),
                                pessoa: pessoa,
                                escalacoes: escalacoes,
                                tipo: 'RJM_OFICIAL'
                            });
                        }
                    }
                });
            });

            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alertDiv = document.getElementById('conflitoAlert');
            const listaDiv = document.getElementById('listaConflitos');
            
            if (conflitos.length === 0) {
                alertDiv.style.display = 'none';
                return;
            }

            alertDiv.style.display = 'block';
            listaDiv.innerHTML = '';

            conflitos.forEach((conflito, i) => {
                const item = document.createElement('div');
                item.className = 'conflito-item';
                
                const sugestao = obterSugestaoTroca(conflito.dia, conflito.pessoa);
                
                item.innerHTML = `
                    <strong>Dia ${conflito.dia}:</strong> ${conflito.pessoa} est√° escalado(a) em RJM e OFICIAL
                    ${sugestao ? `
                        <br><span style="color: #2e7d32;">üí° Sugest√£o: Trocar ${conflito.pessoa} ‚Üî ${sugestao.pessoa} entre domingos ${conflito.dia} e ${sugestao.dia}</span>
                        <button class="btn-resolver" onclick="aplicarTroca(${conflito.dia}, '${conflito.pessoa}', ${sugestao.dia}, '${sugestao.pessoa}')">
                            ‚úÖ Aplicar Troca
                        </button>
                    ` : '<br><span style="color: #d32f2f;">‚ùå Nenhuma troca dispon√≠vel</span>'}
                `;
                
                listaDiv.appendChild(item);
            });
        }

        function obterSugestaoTroca(diaConflito, pessoaConflito) {
            // Busca todos os domingos com RJM no m√™s
            const domingoRJM = escalaAtual.filter(s => s.servico === 'RJM' && s.diaSemana === 'DOMINGO');
            
            for (let domingo of domingoRJM) {
                if (domingo.dia === diaConflito) continue; // Pula o domingo do conflito
                
                // Pega as pessoas da RJM deste domingo
                const pessoasRJM = [domingo.pedOracao, domingo.lateral].filter(p => p && p !== '-');
                
                for (let candidato of pessoasRJM) {
                    // Verifica se o candidato N√ÉO est√° no oficial do dia do conflito
                    const oficiaisDiaConflito = escalaAtual.filter(s => 
                        s.dia === diaConflito && s.servico === 'OFICIAL'
                    );
                    
                    const candidatoTemConflito = oficiaisDiaConflito.some(oficial => 
                        [oficial.pedOracao, oficial.principal, oficial.lateral].includes(candidato)
                    );
                    
                    // Verifica se a pessoa do conflito N√ÉO est√° no oficial do dia do candidato
                    const oficiaisDiaCandidato = escalaAtual.filter(s => 
                        s.dia === domingo.dia && s.servico === 'OFICIAL'
                    );
                    
                    const pessoaConflituTemConflito = oficiaisDiaCandidato.some(oficial => 
                        [oficial.pedOracao, oficial.principal, oficial.lateral].includes(pessoaConflito)
                    );
                    
                    if (!candidatoTemConflito && !pessoaConflituTemConflito) {
                        return {
                            pessoa: candidato,
                            dia: domingo.dia
                        };
                    }
                }
            }
            
            return null;
        }

        function aplicarTroca(dia1, pessoa1, dia2, pessoa2) {
            if (confirm(`Trocar na RJM:\n‚Ä¢ Dia ${dia1}: ${pessoa1} ‚Üí ${pessoa2}\n‚Ä¢ Dia ${dia2}: ${pessoa2} ‚Üí ${pessoa1}\n\nConfirmar troca?`)) {
                // Encontra os √≠ndices das RJMs dos dois domingos
                const rjm1Index = escalaAtual.findIndex(s => s.dia === dia1 && s.servico === 'RJM');
                const rjm2Index = escalaAtual.findIndex(s => s.dia === dia2 && s.servico === 'RJM');
                
                if (rjm1Index === -1 || rjm2Index === -1) {
                    alert('Erro: N√£o foi poss√≠vel encontrar as RJMs dos domingos.');
                    return;
                }
                
                const rjm1 = escalaAtual[rjm1Index];
                const rjm2 = escalaAtual[rjm2Index];
                
                // Realiza a troca
                if (rjm1.pedOracao === pessoa1) {
                    if (rjm2.pedOracao === pessoa2) {
                        rjm1.pedOracao = pessoa2;
                        rjm2.pedOracao = pessoa1;
                    } else if (rjm2.lateral === pessoa2) {
                        rjm1.pedOracao = pessoa2;
                        rjm2.lateral = pessoa1;
                    }
                } else if (rjm1.lateral === pessoa1) {
                    if (rjm2.pedOracao === pessoa2) {
                        rjm1.lateral = pessoa2;
                        rjm2.pedOracao = pessoa1;
                    } else if (rjm2.lateral === pessoa2) {
                        rjm1.lateral = pessoa2;
                        rjm2.lateral = pessoa1;
                    }
                }
                
                // Evita pessoa sozinha na RJM
                corrigirPessoaSozinha(rjm1Index);
                corrigirPessoaSozinha(rjm2Index);
                
                const mesAno = document.getElementById('mesAno').value;
                escalas[mesAno] = [...escalaAtual];
                salvarDados();
                
                exibirEscala();
                detectarConflitos();
                
                alert(`‚úÖ Troca realizada com sucesso!\nDia ${dia1}: ${pessoa2}\nDia ${dia2}: ${pessoa1}`);
            }
        }

        function corrigirPessoaSozinha(rjmIndex) {
            const rjm = escalaAtual[rjmIndex];
            
            // Se a mesma pessoa est√° em pedOracao e lateral
            if (rjm.pedOracao === rjm.lateral && rjm.pedOracao !== '-') {
                // Busca pr√≥xima pessoa da sequ√™ncia RJM que n√£o est√° no oficial do mesmo dia
                const oficiaisDoMesmoDia = escalaAtual.filter(s => 
                    s.dia === rjm.dia && s.servico === 'OFICIAL'
                );
                
                const pessoasOcupadas = new Set();
                oficiaisDoMesmoDia.forEach(oficial => {
                    [oficial.pedOracao, oficial.principal, oficial.lateral].forEach(p => {
                        if (p && p !== '-') pessoasOcupadas.add(p);
                    });
                });
                
                // Adiciona a pessoa atual para evitar mant√™-la
                pessoasOcupadas.add(rjm.pedOracao);
                
                // Busca substituto na sequ√™ncia RJM
                const substituto = sequencias.rjm.find(p => !pessoasOcupadas.has(p));
                
                if (substituto) {
                    rjm.lateral = substituto;
                }
            }
        }

        // ========== GERENCIADOR DE ESCALAS ==========
        function abrirModalEscalas() {
            carregarListaEscalas();
            document.getElementById('modalEscalas').style.display = 'block';
        }

        function fecharModalEscalas() {
            document.getElementById('modalEscalas').style.display = 'none';
        }

        function carregarListaEscalas() {
            const lista = document.getElementById('listaEscalasSalvas');
            const nenhumaDiv = document.getElementById('nenhumaEscala');
            
            const escalasArray = Object.entries(escalas).sort((a, b) => a[0].localeCompare(b[0]));
            
            if (escalasArray.length === 0) {
                lista.style.display = 'none';
                nenhumaDiv.style.display = 'block';
                return;
            }
            
            lista.style.display = 'block';
            nenhumaDiv.style.display = 'none';
            lista.innerHTML = '';
            
            escalasArray.forEach(([mesAno, escala]) => {
                const [ano, mes] = mesAno.split('-');
                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const mesNome = meses[parseInt(mes) - 1];
                
                const servicosOficiais = escala.filter(s => s.servico === 'OFICIAL').length;
                const servicosRJM = escala.filter(s => s.servico === 'RJM').length;
                const outrosServicos = escala.filter(s => !['OFICIAL', 'RJM'].includes(s.servico)).length;
                
                const card = document.createElement('div');
                card.className = 'escala-card';
                
                card.innerHTML = `
                    <div class="escala-info">
                        <h4>üìÖ ${mesNome} de ${ano}</h4>
                        <p><strong>Total:</strong> ${escala.length} servi√ßos</p>
                        <p><strong>Detalhes:</strong> ${servicosOficiais} Oficiais ‚Ä¢ ${servicosRJM} RJM ‚Ä¢ ${outrosServicos} Especiais</p>
                    </div>
                    <div class="escala-acoes">
                        <button class="btn-escala btn-carregar" onclick="carregarEscala('${mesAno}')">üìÇ Carregar</button>
                        <button class="btn-escala btn-deletar" onclick="deletarEscala('${mesAno}', '${mesNome} de ${ano}')">üóëÔ∏è Deletar</button>
                    </div>
                `;
                
                lista.appendChild(card);
            });
        }

        function carregarEscala(mesAno) {
            document.getElementById('mesAno').value = mesAno;
            escalaAtual = escalas[mesAno];
            exibirEscala();
            detectarConflitos();
            fecharModalEscalas();
            
            const [ano, mes] = mesAno.split('-');
            const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const mesNome = meses[parseInt(mes) - 1];
            
            alert(`‚úÖ Escala carregada!\n\nüìÖ ${mesNome} de ${ano}\nüìä ${escalaAtual.length} servi√ßos programados`);
        }

        function deletarEscala(mesAno, nomeCompleto) {
            // Protege a escala base de agosto
            if (mesAno === '2025-08') {
                alert('üîí Escala Protegida!\n\nA escala de agosto de 2025 √© a base do sistema e n√£o pode ser deletada.\n\nüìã Esta escala serve como refer√™ncia para continuidade.');
                return;
            }
            
            if (confirm(`üóëÔ∏è Deletar Escala?\n\nüìÖ ${nomeCompleto}\nüìä ${escalas[mesAno].length} servi√ßos\n\n‚ö†Ô∏è Esta a√ß√£o n√£o pode ser desfeita!`)) {
                delete escalas[mesAno];
                salvarDados();
                carregarListaEscalas();
                
                // Se era a escala atual, limpa a tela
                const mesAtual = document.getElementById('mesAno').value;
                if (mesAtual === mesAno) {
                    escalaAtual = [];
                    document.getElementById('corpoTabela').innerHTML = '';
                    document.getElementById('conflitoAlert').style.display = 'none';
                }
                
                alert(`‚úÖ Escala deletada!\n\n${nomeCompleto} foi removida com sucesso.`);
            }
        }

        function limparTodasEscalas() {
            const totalEscalas = Object.keys(escalas).length;
            const escalasDeleteis = Object.keys(escalas).filter(mes => mes !== '2025-08').length;
            
            if (escalasDeleteis === 0) {
                alert('üì≠ N√£o h√° escalas para deletar!\n\nüîí A escala de agosto/2025 √© protegida.');
                return;
            }
            
            if (confirm(`üóëÔ∏è DELETAR ESCALAS?\n\nüìä Total: ${totalEscalas} escalas\nüóëÔ∏è Delet√°veis: ${escalasDeleteis} escalas\nüîí Protegida: Agosto/2025\n\n‚ö†Ô∏è ESTA A√á√ÉO N√ÉO PODE SER DESFEITA!\n\nTem certeza?`)) {
                // Remove todas exceto agosto/2025
                Object.keys(escalas).forEach(mes => {
                    if (mes !== '2025-08') {
                        delete escalas[mes];
                    }
                });
                
                // Recalcula √≠ndices baseado na escala de agosto
                calcularIndicesBaseadoAgosto();
                
                salvarDados();
                carregarListaEscalas();
                
                escalaAtual = [];
                document.getElementById('corpoTabela').innerHTML = '';
                document.getElementById('conflitoAlert').style.display = 'none';
                
                alert(`‚úÖ Escalas deletadas!\n\nüóëÔ∏è ${escalasDeleteis} escalas removidas\nüîí Agosto/2025 mantida como base\nüîÑ √çndices recalculados`);
            }
        }

        // ========== C√ÅLCULO DE √çNDICES BASEADO NA ESCALA DE AGOSTO ==========
        function calcularIndicesBaseadoAgosto() {
            // Analisa a escala de agosto para determinar onde parou cada sequ√™ncia
            const agostoRJM = ESCALA_AGOSTO_2025.filter(s => s.servico === 'RJM');
            const ultimoRJM = agostoRJM[agostoRJM.length - 1]; // √öltimo RJM: SAULO + VANDERLEI
            
            // Encontra posi√ß√£o do SAULO na sequ√™ncia RJM (√∫ltimo pedOracao)
            const posicaoSaulo = sequencias.rjm.indexOf('SAULO'); // posi√ß√£o 13
            indices.rjm = (posicaoSaulo + 2) % sequencias.rjm.length; // pr√≥ximo: RODINEI (posi√ß√£o 10)
            
            // R.Setor: √∫ltimo foi JONAS (posi√ß√£o 7), pr√≥ximo C√âLIO (posi√ß√£o 8)
            const posicaoJonas = sequencias.rSetor.indexOf('JONAS');
            indices.rSetor = (posicaoJonas + 1) % sequencias.rSetor.length;
            
            // R.Local: pr√≥ximo ser√° em outubro, SAMUEL (posi√ß√£o 1)
            indices.rLocal = 1;
            
            // Ensaio: √∫ltimo foi AFONSO + MARCOS, pr√≥ximos C√âLIO + EDI
            const posicaoAfonso = sequencias.ensaio.indexOf('AFONSO');
            indices.ensaio = (posicaoAfonso + 2) % sequencias.ensaio.length;
            
            // Grupos oficiais: baseado no √∫ltimo domingo de agosto
            // √öltimo domingo oficial: EDIVAN (ped), JOS√â CARDOSO (prin), ODEMIR (lat)
            // Grupo: [JOS√â CARDOSO, ODEMIR, SAMUEL, EDIVAN]
            // √öltimo √≠ndice foi 3 (EDIVAN ped), pr√≥ximo deve ser 2 (SAMUEL ped)
            indices.domingoOficial = 2; // SAMUEL como pr√≥ximo pedOracao
            
            // 5¬™ feira: √∫ltimo servi√ßo agosto foi EDI (ped), MARCOS (prin), SAULO (lat)
            // SAULO foi lateral, ent√£o pr√≥ximo m√™s ele deve ser pedOracao
            const posicaoSauloQuinta = grupos.quinta.indexOf('SAULO');
            indices.quinta = posicaoSauloQuinta; // SAULO como pr√≥ximo pedOracao
            
            // Outros grupos
            indices.terca = 0;
            indices.sabado = 2;
        }
        // ========== GERENCIAMENTO DE PESSOAS ==========
        function abrirModalPessoas() {
            carregarListaPessoas();
            document.getElementById('modalPessoas').style.display = 'block';
        }

        function fecharModalPessoas() {
            document.getElementById('modalPessoas').style.display = 'none';
            document.getElementById('novaPessoa').value = '';
        }

        function carregarListaPessoas() {
            const lista = document.getElementById('listaPessoas');
            lista.innerHTML = '';
            
            pessoas.sort().forEach((pessoa, i) => {
                const card = document.createElement('div');
                card.className = 'pessoa-card';
                card.innerHTML = `
                    <span>${pessoa}</span>
                    <button class="btn-remove" onclick="removerPessoa(${i})">‚úï</button>
                `;
                lista.appendChild(card);
            });
        }

        function adicionarPessoa() {
            const input = document.getElementById('novaPessoa');
            const nome = input.value.trim().toUpperCase();
            
            if (!nome) return alert('Digite um nome!');
            if (pessoas.includes(nome)) return alert('Pessoa j√° cadastrada!');
            
            pessoas.push(nome);
            pessoas.sort();
            carregarListaPessoas();
            input.value = '';
        }

        function removerPessoa(i) {
            if (confirm(`Remover ${pessoas[i]}?`)) {
                pessoas.splice(i, 1);
                carregarListaPessoas();
            }
        }

        function salvarPessoas() {
            salvarDados();
            fecharModalPessoas();
        }

        // ========== GERENCIAMENTO DE GRUPOS ==========
        function abrirModalGrupos() {
            carregarGrupos();
            document.getElementById('modalGrupos').style.display = 'block';
        }

        function fecharModalGrupos() {
            document.getElementById('modalGrupos').style.display = 'none';
        }

        function carregarGrupos() {
            const container = document.getElementById('gruposContainer');
            container.innerHTML = '';

            Object.keys(grupos).forEach(grupoId => {
                container.appendChild(criarCardGrupo(grupoId, grupos[grupoId], true));
            });

            Object.keys(sequencias).forEach(seqId => {
                container.appendChild(criarCardGrupo(seqId, sequencias[seqId], false));
            });
        }

        function criarCardGrupo(id, membros, isGrupo) {
            const info = GRUPOS_INFO[id];
            const card = document.createElement('div');
            card.className = 'grupo-card';
            
            if (isGrupo) {
                // Para grupos: mostra dispon√≠veis
                card.innerHTML = `
                    <div class="grupo-titulo ${info.classe}">${info.nome}</div>
                    <div class="membros-lista" data-grupo="${id}">
                        ${membros.map(m => `<span class="membro-item" onclick="removerMembro('${id}', '${m}', ${isGrupo})">${m}</span>`).join('')}
                    </div>
                    <div style="margin-bottom: 10px;">
                        <strong>Dispon√≠veis:</strong><br>
                        ${obterPessoasLivres(id, isGrupo).map(p => `<span class="pessoa-disponivel" onclick="adicionarMembro('${id}', '${p}', ${isGrupo})">${p}</span>`).join('')}
                    </div>
                    <button onclick="resetarGrupo('${id}', ${isGrupo})" style="width: 100%; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Resetar</button>
                `;
            } else {
                // Para sequ√™ncias: sequ√™ncia completa de rota√ß√£o + banco de reservas
                const pessoasForaDaSequencia = pessoas.filter(p => !membros.includes(p) && p !== 'ODEMIR'); // Odemir n√£o participa das sequ√™ncias
                
                card.innerHTML = `
                    <div class="grupo-titulo ${info.classe}">${info.nome}</div>
                    <div style="margin-bottom: 10px; font-size: 13px; color: #666;">
                        <strong>üîÑ Sequ√™ncia de Rota√ß√£o</strong> (ordem de escala√ß√£o entre meses)
                    </div>
                    <div class="membros-lista" data-grupo="${id}" style="min-height: 140px;">
                        ${membros.map((m, i) => `<span class="membro-item" onclick="removerMembro('${id}', '${m}', ${isGrupo})" title="Posi√ß√£o ${i+1} na sequ√™ncia">${i+1}. ${m}</span>`).join('')}
                    </div>
                    ${pessoasForaDaSequencia.length > 0 ? `
                        <div style="margin-bottom: 10px;">
                            <strong>‚ûï Banco de Reservas:</strong><br>
                            <small style="color: #666;">Pessoas que podem ser inclu√≠das na sequ√™ncia</small><br>
                            ${pessoasForaDaSequencia.map(p => `<span class="pessoa-disponivel" onclick="adicionarMembro('${id}', '${p}', ${isGrupo})">${p}</span>`).join('')}
                        </div>
                    ` : '<div style="margin-bottom: 10px; color: #666; font-style: italic;">‚úÖ Todas as pessoas est√£o na sequ√™ncia</div>'}
                    <button onclick="resetarGrupo('${id}', ${isGrupo})" style="width: 100%; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Resetar Sequ√™ncia</button>
                `;
            }
            
            return card;
        }

        function obterPessoasLivres(grupoAtual, isGrupoAtual) {
            const usadas = new Set();
            
            // Para grupos (ter√ßa, quinta, s√°bado, domingo): exclui pessoas de outros grupos
            if (isGrupoAtual) {
                Object.entries(grupos).forEach(([grupoId, membros]) => {
                    if (grupoId !== grupoAtual) {
                        membros.forEach(m => usadas.add(m));
                    }
                });
            } else {
                // Para sequ√™ncias: exclui pessoas de grupos E outras sequ√™ncias
                Object.values(grupos).forEach(membros => {
                    membros.forEach(m => usadas.add(m));
                });
                
                Object.entries(sequencias).forEach(([sequenciaId, membros]) => {
                    if (sequenciaId !== grupoAtual) {
                        membros.forEach(m => usadas.add(m));
                    }
                });
                
                // ODEMIR √© exclusivo do Domingo Oficial - n√£o pode estar nas sequ√™ncias especiais
                usadas.add('ODEMIR');
            }
            
            return pessoas.filter(p => !usadas.has(p)).sort();
        }

        function adicionarMembro(grupoId, pessoa, isGrupo) {
            if (isGrupo) {
                if (!grupos[grupoId].includes(pessoa)) {
                    grupos[grupoId].push(pessoa);
                    grupos[grupoId].sort();
                }
            } else {
                if (!sequencias[grupoId].includes(pessoa)) {
                    sequencias[grupoId].push(pessoa);
                    sequencias[grupoId].sort();
                }
            }
            carregarGrupos();
        }

        function removerMembro(grupoId, pessoa, isGrupo) {
            if (confirm(`Remover ${pessoa} do grupo ${GRUPOS_INFO[grupoId].nome}?`)) {
                if (isGrupo) {
                    const idx = grupos[grupoId].indexOf(pessoa);
                    if (idx > -1) grupos[grupoId].splice(idx, 1);
                } else {
                    const idx = sequencias[grupoId].indexOf(pessoa);
                    if (idx > -1) sequencias[grupoId].splice(idx, 1);
                }
                carregarGrupos();
            }
        }

        function resetarGrupo(grupoId, isGrupo) {
            if (confirm(`Resetar ${GRUPOS_INFO[grupoId].nome} ao padr√£o?`)) {
                if (isGrupo) {
                    grupos[grupoId] = [...GRUPOS_PADRAO[grupoId]];
                } else {
                    sequencias[grupoId] = [...SEQUENCIAS_PADRAO[grupoId]];
                }
                carregarGrupos();
            }
        }

        function resetarGrupos() {
            if (confirm('Resetar TODOS os grupos ao padr√£o?')) {
                grupos = JSON.parse(JSON.stringify(GRUPOS_PADRAO));
                sequencias = JSON.parse(JSON.stringify(SEQUENCIAS_PADRAO));
                carregarGrupos();
            }
        }

        function salvarGrupos() {
            salvarDados();
            fecharModalGrupos();
        }

        // ========== GERA√á√ÉO DE PDF ==========
        function gerarPDF() {
            if (!escalaAtual.length) return alert('Gere uma escala primeiro!');

            const mesAno = document.getElementById('mesAno').value;
            const [ano, mes] = mesAno.split('-');
            const meses = ['JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            const mesNome = meses[parseInt(mes) - 1];
            
            let linhas = '';
            escalaAtual.forEach(item => {
                if (item.mesclar) {
                    linhas += `<tr><td>${item.dia}</td><td>${item.diaSemana}</td><td class="cor-${item.classe}">${item.servico}</td><td colspan="3" class="mesclar">${item.pedOracao}</td></tr>`;
                } else {
                    linhas += `<tr><td>${item.dia}</td><td>${item.diaSemana}</td><td class="cor-${item.classe}">${item.servico}</td><td>${item.pedOracao}</td><td>${item.principal}</td><td>${item.lateral}</td></tr>`;
                }
            });
            
            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Escala ${mesNome} ${ano}</title>
<style>
@page { margin: 2cm; }
body { font-family: Arial, sans-serif; color: #333; }
.cabecalho { text-align: center; margin-bottom: 30px; }
.cabecalho h1 { font-size: 18px; color: #1976d2; margin: 5px 0; }
.cabecalho h2 { font-size: 16px; margin: 5px 0; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background: #f0f0f0; font-weight: bold; }
tr:nth-child(even) { background: #f9f9f9; }
.cor-oficial { background: #e3f2fd !important; color: #0d47a1 !important; font-weight: bold; }
.cor-rjm { background: #e8f5e8 !important; color: #1b5e20 !important; font-weight: bold; }
.cor-rsetor { background: #fff3e0 !important; color: #e65100 !important; font-weight: bold; }
.cor-rlocal { background: #f3e5f5 !important; color: #4a148c !important; font-weight: bold; }
.cor-ensaio { background: #e8eaf6 !important; color: #1a237e !important; font-weight: bold; }
.mesclar { background: #f5f5f5 !important; font-weight: normal; }
</style></head>
<body>
<div class="cabecalho">
<h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
<h2>ESCALA DE PORTEIROS</h2>
<h2>${mesNome} DE ${ano}</h2>
</div>
<table>
<thead><tr><th>DIA</th><th>DIA DA SEMANA</th><th>SERVI√áO</th><th>PED ORA√á√ÉO</th><th>PRINCIPAL</th><th>LATERAL</th></tr></thead>
<tbody>${linhas}</tbody>
</table>
<div style="margin-top: 20px; text-align: center; font-size: 11px; color: #666;">
<p>Sistema de Escalas CCB Santa Am√©lia ‚Ä¢ Gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
</div>
</body></html>`;
            
            const janela = window.open('', '_blank');
            janela.document.write(html);
            janela.document.close();
            setTimeout(() => janela.print(), 500);
        }

        // ========== EVENT LISTENERS GLOBAIS ==========
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                fecharModalPessoas();
                fecharModalGrupos();
                fecharModalEscalas();
            }
            
            // Remove destaque quando clica em √°rea neutra
            if (!e.target.closest('.nome-editavel') && !e.target.closest('select') && !e.target.closest('button')) {
                removerDestaque();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalPessoas();
                fecharModalGrupos();
                fecharModalEscalas();
                removerDestaque();
            }
        });
    </script>
</body>
</html>
