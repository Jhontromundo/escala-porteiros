<div class="<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Porteiros - CCB Santa Am√©lia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #1976d2;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls input, .controls button {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .controls input:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .btn-gerar {
            background: #1976d2;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-gerar:hover {
            background: #1565c0;
        }
        
        .btn-pdf {
            background: #d32f2f;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-pdf:hover {
            background: #c62828;
        }
        
        .btn-gerenciar {
            background: #4caf50;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-gerenciar:hover {
            background: #45a049;
        }
        
        .tabela-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f5f5f5;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .servico-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        
        .oficial { background: #e3f2fd; color: #1976d2; }
        .rjm { background: #e8f5e8; color: #388e3c; }
        .rsetor { background: #fff3e0; color: #f57c00; }
        .rlocal { background: #f3e5f5; color: #7b1fa2; }
        .ensaio { background: #e8eaf6; color: #3f51b5; }
        
        .mesclar {
            text-align: center;
            background: #f0f0f0;
        }
        
        .editavel {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-height: 20px;
            display: inline-block;
            min-width: 60px;
        }
        
        .editavel:hover {
            background-color: #e3f2fd;
            border: 1px dashed #1976d2;
        }
        
        .editando {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .destaque {
            background-color: #ffeb3b !important;
            font-weight: bold;
            color: #f57f17;
        }
        
        .dropdown-edicao {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            min-width: 120px;
        }
        
        .btn-edicao {
            background: #4caf50;
            color: white;
            border: none;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .btn-cancelar {
            background: #f44336;
        }
        
        .conflito-alerta {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .conflito-alerta h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conflito-lista {
            color: #d32f2f;
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            margin-top: -10px;
        }
        
        .close:hover {
            color: #000;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
            gap: 10px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: #f5f5f5;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .tab.active {
            background: #1976d2;
            color: white;
        }
        
        .tab:hover:not(.active) {
            background: #e3f2fd;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .grupo-editor {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .grupo-titulo {
            font-size: 18px;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .membros-lista {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .membro-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .membro-nome {
            flex: 1;
            font-weight: bold;
        }
        
        .btn-mover, .btn-remover {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .btn-mover {
            background: #2196f3;
        }
        
        .btn-adicionar-membro {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }
        
        .select-membro {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            flex: 1;
        }
        
        .btn-add {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .modal-footer {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        .btn-modal {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        .btn-salvar {
            background: #4caf50;
            color: white;
        }
        
        .btn-salvar:hover {
            background: #45a049;
        }
        
        .btn-restaurar {
            background: #ff9800;
            color: white;
        }
        
        .btn-restaurar:hover {
            background: #f57c00;
        }
        
        .btn-cancelar-modal {
            background: #f44336;
            color: white;
        }
        
        .btn-cancelar-modal:hover {
            background: #d32f2f;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls input, .controls button {
                width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gerador de Escalas de Servi√ßo</h1>
            <p>Congrega√ß√£o Crist√£ no Brasil - Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="mesAno">üìÖ M√™s Selecionado:</label>
                <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 8px 12px; border-radius: 8px; border: 2px solid #ddd;">
                    <span id="mesTexto" style="font-weight: bold; color: #1976d2; min-width: 150px;">AGOSTO DE 2025</span>
                    <button onclick="abrirSeletorMes()" style="background: #1976d2; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer;" title="Alterar m√™s">
                        üìÖ
                    </button>
                </div>
                <input type="month" id="mesAno" style="display: none;" onchange="atualizarMesTexto(); gerarEscala()">
            </div>
            <button class="btn-gerar" onclick="gerarEscala()">üîÑ Gerar Escala</button>
            <button class="btn-pdf" onclick="gerarPDF()">üìÑ Gerar PDF</button>
            <button class="btn-gerenciar" onclick="abrirGerenciador()">‚öôÔ∏è Gerenciar Grupos</button>
            <button class="btn-gerar" onclick="resolverConflitosAutomatico()" id="btnResolverConflitos" style="display: none; background: #ff9800;">üîß Resolver Conflitos</button>
            <div id="membroDestacado" style="display: none;" class="btn-gerar">
                Destacando: <span id="nomeDestacado"></span>
                <button onclick="limparDestaque()" style="background: transparent; border: none; color: white; margin-left: 10px;">‚úï</button>
            </div>
        </div>
        
        <div id="alertaConflitos" class="conflito-alerta">
            <h3>‚ö†Ô∏è Conflitos de Mesmo Dia Detectados</h3>
            <div id="listaConflitos" class="conflito-lista"></div>
            <p style="font-size: 12px; margin-top: 15px; color: #666; border-top: 1px solid #ddd; padding-top: 10px;">
                <strong>üí° Como resolver:</strong><br>
                ‚Ä¢ <strong>Aplicar sugest√£o:</strong> Clique no bot√£o "‚ú® Aplicar" nas sugest√µes autom√°ticas<br>
                ‚Ä¢ <strong>Edi√ß√£o manual:</strong> Use <strong>duplo clique</strong> ou <strong>bot√£o direito</strong> em qualquer nome<br>
                ‚Ä¢ <strong>Dica:</strong> Sugest√µes ü•á s√£o as mais recomendadas
            </p>
        </div>
        
        <div class="tabela-container">
            <table id="tabelaEscala">
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- Dados ser√£o inseridos aqui -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>‚úÖ Sistema v3.0 - Continuidade Total Implementada</p>
            <p>üéØ Distribui√ß√£o Justa e Inteligente com Persist√™ncia</p>
        </div>
    </div>

    <!-- Modal de Gerenciamento de Grupos -->
    <div id="modalGerenciador" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharGerenciador()">&times;</span>
            <h2 style="text-align: center; color: #1976d2; margin-bottom: 30px;">‚öôÔ∏è Gerenciar Grupos e Sequ√™ncias v3.0</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="mostrarTab('grupos')">üë• Grupos Semanais</button>
                <button class="tab" onclick="mostrarTab('sequencias')">üîÑ Sequ√™ncias Especiais</button>
                <button class="tab" onclick="mostrarTab('membros')">üë§ Gerenciar Membros</button>
            </div>
            
            <!-- Tab Grupos Semanais -->
            <div id="tab-grupos" class="tab-content active">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è 3¬™ Feira (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-terca" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-terca" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('terca')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è 5¬™ Feira (3 pessoas - sem folga)</div>
                    <div id="grupo-quinta" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-quinta" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('quinta')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è S√°bado (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-sabado" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-sabado" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('sabado')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üóìÔ∏è Domingo Oficial (4 pessoas - 1 folga rotativa)</div>
                    <div id="grupo-domingoOficial" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-domingoOficial" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('domingoOficial')">+ Adicionar</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Sequ√™ncias Especiais -->
            <div id="tab-sequencias" class="tab-content">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üìø RJM (2 por domingo)</div>
                    <div id="sequencia-rjm" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rjm" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rjm')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üè¢ R. SETOR (1 por m√™s - 3¬™ segunda-feira)</div>
                    <div id="sequencia-rSetor" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rSetor" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rSetor')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üåç R. LOCAL (trimestral - 4¬™ segunda-feira jan/abr/jul/out)</div>
                    <div id="sequencia-rLocal" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-rLocal" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('rLocal')">+ Adicionar</button>
                    </div>
                </div>
                
                <div class="grupo-editor">
                    <div class="grupo-titulo">üéµ ENSAIO (2 por m√™s - 4¬™ sexta-feira)</div>
                    <div id="sequencia-ensaio" class="membros-lista"></div>
                    <div class="btn-adicionar-membro">
                        <select id="select-ensaio" class="select-membro"></select>
                        <button class="btn-add" onclick="adicionarMembro('ensaio')">+ Adicionar</button>
                    </div>
                </div>
            </div>
            
            <!-- Tab Gerenciar Membros -->
            <div id="tab-membros" class="tab-content">
                <div class="grupo-editor">
                    <div class="grupo-titulo">üë§ Lista de Membros do Sistema</div>
                    <div id="lista-membros" class="membros-lista"></div>
                    
                    <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-top: 15px;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">‚ûï Adicionar Novo Membro</h4>
                        <div class="btn-adicionar-membro">
                            <input type="text" id="input-novo-membro" placeholder="Digite o nome do novo membro..." class="select-membro" style="flex: 2;">
                            <button class="btn-add" onclick="adicionarNovoMembro()">+ Adicionar ao Sistema</button>
                        </div>
                        <p style="font-size: 12px; color: #666; margin-top: 8px;">
                            <strong>Dica:</strong> Ap√≥s adicionar, voc√™ poder√° incluir o membro nos grupos e sequ√™ncias desejados.
                        </p>
                    </div>
                </div>
                
                <div class="grupo-editor" style="background: #f0f8ff; border: 1px solid #1976d2;">
                    <div class="grupo-titulo">‚ö†Ô∏è Aten√ß√£o</div>
                    <p style="color: #1976d2; font-size: 14px; line-height: 1.5;">
                        ‚Ä¢ <strong>Adicionar membro:</strong> Inclui na lista geral do sistema<br>
                        ‚Ä¢ <strong>Remover membro:</strong> Remove completamente do sistema<br>
                        ‚Ä¢ <strong>Lembre-se:</strong> Ap√≥s altera√ß√µes, atualize os grupos e sequ√™ncias conforme necess√°rio
                    </p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn-modal btn-salvar" onclick="salvarAlteracoes()">üíæ Salvar e Regenerar</button>
                <button class="btn-modal btn-restaurar" onclick="restaurarPadrao()">üîÑ Restaurar Padr√£o</button>
                <button class="btn-modal" onclick="reiniciarSequencias()" style="background: #9c27b0; color: white;">üéØ Reiniciar Sequ√™ncias</button>
                <button class="btn-modal btn-cancelar-modal" onclick="fecharGerenciador()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURA√á√ïES PADR√ÉO v3.0 ====================
        
        // Grupos por dia da semana (configura√ß√£o padr√£o conforme documenta√ß√£o)
        const gruposPadraoOriginal = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        // Sequ√™ncias dos servi√ßos especiais (configura√ß√£o padr√£o conforme documenta√ß√£o)
        const sequenciasPadraoOriginal = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN', 'ALGACIR', 'SAULO', 'RODINEI', 'SAMUEL', 'C√âLIO', 'JONAS', 'AFONSO'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'JONAS', 'C√âLIO', 'EDI', 'SAMUEL', 'JOS√â CARLOS', 'MARCOS', 'EDIVAN', 'SAULO'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'C√âLIO', 'SAULO', 'MARCOS'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL', 'EDIVAN', 'MARCOS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'JONAS']
        };

        // ==================== VARI√ÅVEIS GLOBAIS ====================
        
        // Grupos e sequ√™ncias atuais (carregados do localStorage ou padr√£o)
        let gruposPorDia = carregarConfiguracoes('grupos') || JSON.parse(JSON.stringify(gruposPadraoOriginal));
        let sequencias = carregarConfiguracoes('sequencias') || JSON.parse(JSON.stringify(sequenciasPadraoOriginal));

        const diasSemana = ['DOMINGO', '2¬™ FEIRA', '3¬™ FEIRA', '4¬™ FEIRA', '5¬™ FEIRA', '6¬™ FEIRA', 'S√ÅBADO'];
        let escalaAtual = [];
        let membroDestacadoAtual = null;
        let editandoAtualmente = null;

        // Lista de todos os membros para edi√ß√£o (din√¢mica conforme documenta√ß√£o)
        let todosMembros = carregarConfiguracoes('membros') || [
            'AFONSO', 'ALGACIR', 'JONAS', 'ZANIN', 'EDI', 'MARCOS', 'SAULO',
            'JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU', 'JOS√â CARDOSO',
            'ODEMIR', 'SAMUEL', 'EDIVAN', 'C√âLIO'
        ];

        // ==================== FUN√á√ïES DE PERSIST√äNCIA v3.0 ====================
        
        function salvarConfiguracoes(tipo, dados) {
            try {
                localStorage.setItem('escalas_' + tipo, JSON.stringify(dados));
            } catch (e) {
                console.log('N√£o foi poss√≠vel salvar no localStorage');
            }
        }

        function carregarConfiguracoes(tipo) {
            try {
                const dados = localStorage.getItem('escalas_' + tipo);
                return dados ? JSON.parse(dados) : null;
            } catch (e) {
                console.log('N√£o foi poss√≠vel carregar do localStorage');
                return null;
            }
        }

        // ==================== SISTEMA DE CONTINUIDADE v3.0 ====================
        
        // Fun√ß√µes para persistir √≠ndices das sequ√™ncias E grupos semanais
        function salvarIndices(indices) {
            try {
                localStorage.setItem('escalas_indices', JSON.stringify(indices));
                console.log('√çndices salvos para continuidade:', indices);
            } catch (e) {
                console.log('N√£o foi poss√≠vel salvar √≠ndices');
            }
        }

        function carregarIndices() {
            try {
                const dados = localStorage.getItem('escalas_indices');
                const indicesPadrao = {
                    rjm: 0,
                    rSetor: 0,
                    rLocal: 0,
                    ensaio: 0,
                    // NOVA FUNCIONALIDADE v3.0: √çndices para grupos semanais (continuidade entre meses)
                    terca: 0,
                    quinta: 0,
                    sabado: 0,
                    domingoOficial: 0
                };
                return dados ? JSON.parse(dados) : indicesPadrao;
            } catch (e) {
                console.log('N√£o foi poss√≠vel carregar √≠ndices');
                return {
                    rjm: 0, rSetor: 0, rLocal: 0, ensaio: 0,
                    terca: 0, quinta: 0, sabado: 0, domingoOficial: 0
                };
            }
        }

        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getDiaSemana(ano, mes, dia) {
            return new Date(ano, mes - 1, dia).getDay();
        }

        function encontrarNesimoDay(ano, mes, diaSemana, nesimo) {
            let contador = 0;
            const diasNoMes = getDiasNoMes(ano, mes);
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                if (getDiaSemana(ano, mes, dia) === diaSemana) {
                    contador++;
                    if (contador === nesimo) {
                        return dia;
                    }
                }
            }
            return null;
        }

        function temRLocal(mes) {
            return [1, 4, 7, 10].includes(mes);
        }

        // ==================== ALGORITMOS DE DISTRIBUI√á√ÉO v3.0 ====================
        
        // Fun√ß√£o para calcular pr√≥ximo √≠ndice em grupos com folga (NOVA v3.0)
        function calcularProximoIndiceComFolga(grupo, totalOcorrencias, indiceInicial) {
            let indiceAtual = indiceInicial;
            
            // Simular a distribui√ß√£o para encontrar o √∫ltimo que folgou
            for (let i = 0; i < totalOcorrencias; i++) {
                const indiceFolga = (indiceAtual + 3) % grupo.length;
                indiceAtual = indiceFolga; // Pr√≥ximo come√ßa com quem folgou
            }
            
            return indiceAtual;
        }

        // Distribui√ß√£o com folga rotativa (4‚Üí3 postos) - ATUALIZADA v3.0
        function distribuirGrupoComFolga(grupo, totalOcorrencias, indiceInicial = 0) {
            const escalacao = [];
            let indiceAtual = indiceInicial;
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicoes = [];
                const indiceFolga = (indiceAtual + 3) % grupo.length;
                
                // Preencher 3 posi√ß√µes, pulando quem folga
                for (let j = 0; j < 3; j++) {
                    const indiceAtualPessoa = (indiceAtual + j) % grupo.length;
                    if (indiceAtualPessoa !== indiceFolga) {
                        posicoes.push(grupo[indiceAtualPessoa]);
                    }
                }
                
                // Garantir 3 posi√ß√µes preenchidas
                while (posicoes.length < 3) {
                    for (let k = 0; k < grupo.length; k++) {
                        const indiceK = (indiceAtual + k) % grupo.length;
                        if (indiceK !== indiceFolga && !posicoes.includes(grupo[indiceK])) {
                            posicoes.push(grupo[indiceK]);
                            break;
                        }
                    }
                }
                
                escalacao.push({
                    pedOracao: posicoes[0],
                    principal: posicoes[1],
                    lateral: posicoes[2]
                });
                
                // REGRA FUNDAMENTAL: Quem folga sempre inicia na pr√≥xima no Ped Ora√ß√£o
                indiceAtual = indiceFolga;
            }
            
            return escalacao;
        }

        // Distribui√ß√£o sem folga (3‚Üí3 postos) - ATUALIZADA v3.0
        function distribuirGrupoSemFolga(grupo, totalOcorrencias, indiceInicial = 0) {
            const escalacao = [];
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicaoBase = (indiceInicial + i) % grupo.length;
                
                escalacao.push({
                    pedOracao: grupo[posicaoBase],
                    principal: grupo[(posicaoBase + 1) % grupo.length],
                    lateral: grupo[(posicaoBase + 2) % grupo.length]
                });
            }
            
            return escalacao;
        }

        // ==================== FUN√á√ÉO PRINCIPAL DE GERA√á√ÉO v3.0 - CORRIGIDA ====================
        
        function gerarEscala() {
            console.log('üîÑ Iniciando gera√ß√£o de escala...');
            
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) {
                mostrarFeedback('Selecione um m√™s primeiro!', 'erro');
                return;
            }

            try {
                const ano = parseInt(mesAnoValue.split('-')[0]);
                const mes = parseInt(mesAnoValue.split('-')[1]);
                
                console.log(`Gerando escala para ${mes}/${ano}`);
                
                // ==================== VERIFICA√á√ÉO DE ESCALA EXISTENTE ====================
                const chaveEscala = `escala_${ano}_${mes}`;
                const escalaExistente = carregarConfiguracoes(chaveEscala);
                
                if (escalaExistente && escalaExistente.length > 0) {
                    // Se j√° existe uma escala salva para este m√™s, carregar ela
                    escalaAtual = escalaExistente;
                    exibirEscala(escalaAtual);
                    detectarConflitos(escalaAtual);
                    
                    console.log(`üìã Escala ${mes}/${ano} carregada (determin√≠stica) - ${escalaAtual.length} itens`);
                    mostrarFeedback(`Escala ${mes}/${ano} carregada (vers√£o salva)`, 'info');
                    return;
                }
                
                // ==================== VALIDAR CONFIGURA√á√ÉO ====================
                if (!validarConfiguracao()) {
                    mostrarFeedback('Configura√ß√£o incompleta. Verifique os grupos no Gerenciador.', 'erro');
                    return;
                }
                
                // ==================== GERA√á√ÉO NOVA ESCALA ====================
                const diasNoMes = getDiasNoMes(ano, mes);
                const escala = [];
                
                // Carregar √≠ndices para continuidade v3.0
                const indices = carregarIndices();
                let indiceRJM = indices.rjm || 0;
                let indiceRSetor = indices.rSetor || 0;
                let indiceRLocal = indices.rLocal || 0;
                let indiceEnsaio = indices.ensaio || 0;
                
                // √çndices para grupos semanais (CONTINUIDADE v3.0)
                let indiceTerca = indices.terca || 0;
                let indiceQuinta = indices.quinta || 0;
                let indiceSabado = indices.sabado || 0;
                let indiceDomingoOficial = indices.domingoOficial || 0;
                
                // Contar ocorr√™ncias
                const contadores = { terca: 0, quinta: 0, sabado: 0, domingo: 0 };
                const diasPorTipo = { terca: [], quinta: [], sabado: [], domingo: [] };
                
                for (let dia = 1; dia <= diasNoMes; dia++) {
                    const diaSemana = getDiaSemana(ano, mes, dia);
                    
                    if (diaSemana === 2) {
                        contadores.terca++;
                        diasPorTipo.terca.push(dia);
                    } else if (diaSemana === 4) {
                        contadores.quinta++;
                        diasPorTipo.quinta.push(dia);
                    } else if (diaSemana === 6) {
                        contadores.sabado++;
                        diasPorTipo.sabado.push(dia);
                    } else if (diaSemana === 0) {
                        contadores.domingo++;
                        diasPorTipo.domingo.push(dia);
                    }
                }

                console.log('Contadores:', contadores);

                // Gerar escala√ß√µes COM CONTINUIDADE v3.0
                const escalacaoTerca = distribuirGrupoComFolga(gruposPorDia.terca, contadores.terca, indiceTerca);
                const escalacaoQuinta = distribuirGrupoSemFolga(gruposPorDia.quinta, contadores.quinta, indiceQuinta);
                const escalacaoSabado = distribuirGrupoComFolga(gruposPorDia.sabado, contadores.sabado, indiceSabado);
                const escalacaoDomingo = distribuirGrupoComFolga(gruposPorDia.domingoOficial, contadores.domingo, indiceDomingoOficial);

                // ==================== APLICAR ESCALA√á√ïES - 3¬™ FEIRAS ====================
                for (let i = 0; i < diasPorTipo.terca.length; i++) {
                    const dia = diasPorTipo.terca[i];
                    const escalacaoDia = escalacaoTerca[i];
                    escala.push({
                        dia: dia,
                        diaSemana: '3¬™ FEIRA',
                        servico: 'OFICIAL',
                        pedOracao: escalacaoDia.pedOracao,
                        principal: escalacaoDia.principal,
                        lateral: escalacaoDia.lateral,
                        classe: 'oficial'
                    });
                }

                // ==================== APLICAR ESCALA√á√ïES - 5¬™ FEIRAS ====================
                for (let i = 0; i < diasPorTipo.quinta.length; i++) {
                    const dia = diasPorTipo.quinta[i];
                    const escalacaoDia = escalacaoQuinta[i];
                    escala.push({
                        dia: dia,
                        diaSemana: '5¬™ FEIRA',
                        servico: 'OFICIAL',
                        pedOracao: escalacaoDia.pedOracao,
                        principal: escalacaoDia.principal,
                        lateral: escalacaoDia.lateral,
                        classe: 'oficial'
                    });
                }

                // ==================== APLICAR ESCALA√á√ïES - S√ÅBADOS ====================
                for (let i = 0; i < diasPorTipo.sabado.length; i++) {
                    const dia = diasPorTipo.sabado[i];
                    const escalacaoDia = escalacaoSabado[i];
                    escala.push({
                        dia: dia,
                        diaSemana: 'S√ÅBADO',
                        servico: 'OFICIAL',
                        pedOracao: escalacaoDia.pedOracao,
                        principal: escalacaoDia.principal,
                        lateral: escalacaoDia.lateral,
                        classe: 'oficial'
                    });
                }

                // ==================== APLICAR ESCALA√á√ïES - DOMINGOS ====================
                for (let i = 0; i < diasPorTipo.domingo.length; i++) {
                    const dia = diasPorTipo.domingo[i];
                    
                    // RJM primeiro - usando √≠ndice cont√≠nuo v3.0
                    const membroRJM1 = sequencias.rjm[indiceRJM % sequencias.rjm.length];
                    const membroRJM2 = sequencias.rjm[(indiceRJM + 1) % sequencias.rjm.length];
                    indiceRJM += 2;

                    escala.push({
                        dia: dia,
                        diaSemana: 'DOMINGO',
                        servico: 'RJM',
                        pedOracao: membroRJM1,
                        principal: '-',
                        lateral: membroRJM2,
                        classe: 'rjm'
                    });

                    // OFICIAL depois
                    const escalacaoDia = escalacaoDomingo[i];
                    escala.push({
                        dia: dia,
                        diaSemana: 'DOMINGO',
                        servico: 'OFICIAL',
                        pedOracao: escalacaoDia.pedOracao,
                        principal: escalacaoDia.principal,
                        lateral: escalacaoDia.lateral,
                        classe: 'oficial'
                    });
                }

                // ==================== SEQU√äNCIAS ESPECIAIS ====================
                
                // R. SETOR - 3¬™ segunda-feira - usando √≠ndice cont√≠nuo v3.0
                const terceiraSegunda = encontrarNesimoDay(ano, mes, 1, 3);
                if (terceiraSegunda) {
                    escala.push({
                        dia: terceiraSegunda,
                        diaSemana: '2¬™ FEIRA',
                        servico: 'R. SETOR',
                        pedOracao: sequencias.rSetor[indiceRSetor % sequencias.rSetor.length],
                        principal: 'MESCLAR',
                        lateral: 'MESCLAR',
                        classe: 'rsetor',
                        mesclar: true
                    });
                    indiceRSetor++;
                }

                // R. LOCAL - 4¬™ segunda-feira trimestral - usando √≠ndice cont√≠nuo v3.0
                if (temRLocal(mes)) {
                    const quartaSegunda = encontrarNesimoDay(ano, mes, 1, 4);
                    if (quartaSegunda) {
                        escala.push({
                            dia: quartaSegunda,
                            diaSemana: '2¬™ FEIRA',
                            servico: 'R. LOCAL',
                            pedOracao: sequencias.rLocal[indiceRLocal % sequencias.rLocal.length],
                            principal: 'MESCLAR',
                            lateral: 'MESCLAR',
                            classe: 'rlocal',
                            mesclar: true
                        });
                        indiceRLocal++;
                    }
                }

                // ENSAIO - 4¬™ sexta-feira - usando √≠ndice cont√≠nuo v3.0
                const quartaSexta = encontrarNesimoDay(ano, mes, 5, 4);
                if (quartaSexta) {
                    const membroEnsaio1 = sequencias.ensaio[indiceEnsaio % sequencias.ensaio.length];
                    const membroEnsaio2 = sequencias.ensaio[(indiceEnsaio + 1) % sequencias.ensaio.length];
                    
                    escala.push({
                        dia: quartaSexta,
                        diaSemana: '6¬™ FEIRA',
                        servico: 'ENSAIO',
                        pedOracao: membroEnsaio1,
                        principal: '-',
                        lateral: membroEnsaio2,
                        classe: 'ensaio'
                    });
                    indiceEnsaio += 2;
                }

                // ==================== CALCULAR E SALVAR NOVOS √çNDICES v3.0 ====================
                
                // Para grupos com folga (4 pessoas): calcular pr√≥ximo √≠ndice baseado no √∫ltimo que folgou
                if (contadores.terca > 0) {
                    indiceTerca = calcularProximoIndiceComFolga(gruposPorDia.terca, contadores.terca, indiceTerca);
                }
                if (contadores.sabado > 0) {
                    indiceSabado = calcularProximoIndiceComFolga(gruposPorDia.sabado, contadores.sabado, indiceSabado);
                }
                if (contadores.domingo > 0) {
                    indiceDomingoOficial = calcularProximoIndiceComFolga(gruposPorDia.domingoOficial, contadores.domingo, indiceDomingoOficial);
                }
                
                // Para grupo sem folga (3 pessoas): apenas avan√ßar
                if (contadores.quinta > 0) {
                    indiceQuinta = (indiceQuinta + contadores.quinta) % gruposPorDia.quinta.length;
                }

                // SALVAR √çNDICES PARA CONTINUIDADE TOTAL v3.0
                salvarIndices({
                    rjm: indiceRJM,
                    rSetor: indiceRSetor,
                    rLocal: indiceRLocal,
                    ensaio: indiceEnsaio,
                    terca: indiceTerca,
                    quinta: indiceQuinta,
                    sabado: indiceSabado,
                    domingoOficial: indiceDomingoOficial
                });

                // ==================== SALVAR ESCALA GERADA (DETERMIN√çSTICA) ====================
                
                // Ordenar e salvar escala
                escala.sort(function(a, b) { return a.dia - b.dia; });
                escalaAtual = escala;
                
                // SALVAR A ESCALA PARA ESTE M√äS
                salvarConfiguracoes(chaveEscala, escala);
                
                exibirEscala(escala);
                detectarConflitos(escala);
                
                console.log(`‚úÖ Nova escala ${mes}/${ano} gerada e salva - ${escala.length} itens`);
                mostrarFeedback(`Escala ${mes}/${ano} gerada com sucesso!`, 'sucesso');
                
                // Limpar substitui√ß√µes ao gerar nova escala
                limparSubstituicoes();
                
                // Remover exibi√ß√£o de substitui√ß√µes anteriores
                const substituicoesExistentes = document.getElementById('substituicoesRealizadas');
                if (substituicoesExistentes) {
                    substituicoesExistentes.remove();
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao gerar escala:', error);
                mostrarFeedback('Erro ao gerar escala: ' + error.message, 'erro');
            }
        }
        }

        // ==================== FUN√á√ïES DE INTERFACE PARA M√äS v3.0 ====================
        
        function abrirSeletorMes() {
            document.getElementById('mesAno').click();
        }

        function atualizarMesTexto() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) return;

            const ano = mesAnoValue.split('-')[0];
            const mes = parseInt(mesAnoValue.split('-')[1]);
            const meses = [
                'JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'
            ];
            const mesNome = meses[mes - 1];
            
            document.getElementById('mesTexto').textContent = `${mesNome} DE ${ano}`;
        }

        // ==================== RESOLU√á√ÉO AUTOM√ÅTICA DE CONFLITOS v3.0 ====================
        
        function resolverConflitosAutomatico() {
            if (!confirm('üîß Resolver conflitos automaticamente?\n\n‚ö†Ô∏è Esta a√ß√£o ir√°:\n‚Ä¢ Manter todas as escalas oficiais intactas\n‚Ä¢ Ajustar apenas a escala RJM para eliminar conflitos\n‚Ä¢ Usar flexibiliza√ß√£o de postos (Ped Ora√ß√£o ‚Üî Lateral) quando necess√°rio\n\nContinuar?')) {
                return;
            }

            // Limpar registro de substitui√ß√µes anteriores
            limparSubstituicoes();

            let conflitosResolvidos = 0;
            const conflitosOriginais = detectarConflitosDetalhados(escalaAtual);
            
            console.log('üîç Conflitos detectados:', conflitosOriginais);

            // Processar cada conflito
            conflitosOriginais.forEach(conflito => {
                if (resolverConflitoRJM(conflito)) {
                    conflitosResolvidos++;
                }
            });

            // Atualizar interface
            exibirEscala(escalaAtual);
            
            // Exibir substitui√ß√µes realizadas antes dos conflitos remanescentes
            mostrarSubstituicoesNaInterface();
            
            detectarConflitos(escalaAtual);

            if (conflitosResolvidos > 0) {
                mostrarFeedback(`‚úÖ ${conflitosResolvidos} conflito(s) resolvido(s) automaticamente!`, 'sucesso');
                
                // Salvar escala atualizada
                const mesAnoValue = document.getElementById('mesAno').value;
                if (mesAnoValue) {
                    const ano = parseInt(mesAnoValue.split('-')[0]);
                    const mes = parseInt(mesAnoValue.split('-')[1]);
                    const chaveEscala = `escala_${ano}_${mes}`;
                    salvarConfiguracoes(chaveEscala, escalaAtual);
                }
            } else {
                mostrarFeedback('‚ÑπÔ∏è Nenhum conflito p√¥de ser resolvido automaticamente.', 'info');
            }
        }

        function mostrarSubstituicoesNaInterface() {
            const substituicoesHTML = exibirSubstituicoesRealizadas();
            if (substituicoesHTML) {
                // Inserir antes do alerta de conflitos
                const alertaConflitos = document.getElementById('alertaConflitos');
                
                // Remover substitui√ß√µes anteriores se existirem
                const substituicoesExistentes = document.getElementById('substituicoesRealizadas');
                if (substituicoesExistentes) {
                    substituicoesExistentes.remove();
                }
                
                // Criar div para substitui√ß√µes
                const divSubstituicoes = document.createElement('div');
                divSubstituicoes.id = 'substituicoesRealizadas';
                divSubstituicoes.innerHTML = substituicoesHTML;
                
                // Inserir antes do alerta de conflitos
                alertaConflitos.parentNode.insertBefore(divSubstituicoes, alertaConflitos);
            }
        }

        function detectarConflitosDetalhados(escala) {
            const conflitos = [];
            const diasComServicos = {};
            
            // Agrupar servi√ßos por dia
            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                if (!diasComServicos[item.dia]) {
                    diasComServicos[item.dia] = [];
                }
                diasComServicos[item.dia].push({ ...item, indiceEscala: i });
            }
            
            // Verificar conflitos no mesmo dia
            const dias = Object.keys(diasComServicos);
            for (let d = 0; d < dias.length; d++) {
                const dia = dias[d];
                const servicosDoDia = diasComServicos[dia];
                
                if (servicosDoDia.length > 1) {
                    for (let i = 0; i < servicosDoDia.length; i++) {
                        const servico1 = servicosDoDia[i];
                        for (let j = i + 1; j < servicosDoDia.length; j++) {
                            const servico2 = servicosDoDia[j];
                            
                            const pessoas1 = [servico1.pedOracao, servico1.principal, servico1.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            const pessoas2 = [servico2.pedOracao, servico2.principal, servico2.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            for (let p1 = 0; p1 < pessoas1.length; p1++) {
                                const pessoa = pessoas1[p1];
                                if (pessoas2.indexOf(pessoa) !== -1) {
                                    // Identificar qual campo em cada servi√ßo
                                    const campo1 = encontrarCampoPessoa(servico1, pessoa);
                                    const campo2 = encontrarCampoPessoa(servico2, pessoa);
                                    
                                    conflitos.push({
                                        dia: parseInt(dia),
                                        pessoa: pessoa,
                                        servico1: {
                                            ...servico1,
                                            campo: campo1
                                        },
                                        servico2: {
                                            ...servico2,
                                            campo: campo2
                                        }
                                    });
                                }
                            }
                        }
                    }
                }
            }
            
            return conflitos;
        }

        function resolverConflitoRJM(conflito) {
            // Priorizar altera√ß√µes no RJM (conforme solicitado)
            let servicoRJM = null;
            let servicoIntacto = null;

            if (conflito.servico1.servico === 'RJM') {
                servicoRJM = conflito.servico1;
                servicoIntacto = conflito.servico2;
            } else if (conflito.servico2.servico === 'RJM') {
                servicoRJM = conflito.servico2;
                servicoIntacto = conflito.servico1;
            } else {
                // Se nenhum √© RJM, n√£o alterar (manter escalas oficiais intactas)
                console.log('‚ö†Ô∏è Conflito entre escalas oficiais - n√£o alterado:', conflito);
                return false;
            }

            // NOVA L√ìGICA: Flexibiliza√ß√£o apenas entre Ped Ora√ß√£o ‚Üî Lateral no RJM
            const indiceEscalaRJM = servicoRJM.indiceEscala;
            const itemRJM = escalaAtual[indiceEscalaRJM];
            
            // Primeiro tentar trocar postos dentro do pr√≥prio RJM (Ped Ora√ß√£o ‚Üî Lateral)
            if (servicoRJM.campo === 'pedOracao' && itemRJM.lateral !== conflito.pessoa) {
                // Trocar Ped Ora√ß√£o com Lateral
                const pessoaOriginalPed = itemRJM.pedOracao;
                const pessoaOriginalLat = itemRJM.lateral;
                
                // Verificar se a pessoa do Lateral n√£o est√° escalada em outro servi√ßo no mesmo dia
                if (!estaPessoaEscaladaNoDia(pessoaOriginalLat, conflito.dia, 'RJM')) {
                    escalaAtual[indiceEscalaRJM].pedOracao = pessoaOriginalLat;
                    escalaAtual[indiceEscalaRJM].lateral = pessoaOriginalPed;
                    
                    // Salvar informa√ß√£o da substitui√ß√£o para exibi√ß√£o
                    salvarSubstituicaoRealizada({
                        dia: conflito.dia,
                        servico: 'RJM',
                        tipo: 'Troca de postos',
                        detalhes: `${pessoaOriginalPed} (Ped Ora√ß√£o) ‚Üî ${pessoaOriginalLat} (Lateral)`,
                        motivoOriginal: `Conflito de ${conflito.pessoa} com ${servicoIntacto.servico}`
                    });
                    
                    console.log(`‚úÖ Conflito resolvido por troca de postos RJM: ${pessoaOriginalPed} ‚Üî ${pessoaOriginalLat} no dia ${conflito.dia}`);
                    return true;
                }
            } else if (servicoRJM.campo === 'lateral' && itemRJM.pedOracao !== conflito.pessoa) {
                // Trocar Lateral com Ped Ora√ß√£o
                const pessoaOriginalPed = itemRJM.pedOracao;
                const pessoaOriginalLat = itemRJM.lateral;
                
                // Verificar se a pessoa do Ped Ora√ß√£o n√£o est√° escalada em outro servi√ßo no mesmo dia
                if (!estaPessoaEscaladaNoDia(pessoaOriginalPed, conflito.dia, 'RJM')) {
                    escalaAtual[indiceEscalaRJM].pedOracao = pessoaOriginalLat;
                    escalaAtual[indiceEscalaRJM].lateral = pessoaOriginalPed;
                    
                    // Salvar informa√ß√£o da substitui√ß√£o para exibi√ß√£o
                    salvarSubstituicaoRealizada({
                        dia: conflito.dia,
                        servico: 'RJM',
                        tipo: 'Troca de postos',
                        detalhes: `${pessoaOriginalLat} (Lateral) ‚Üî ${pessoaOriginalPed} (Ped Ora√ß√£o)`,
                        motivoOriginal: `Conflito de ${conflito.pessoa} com ${servicoIntacto.servico}`
                    });
                    
                    console.log(`‚úÖ Conflito resolvido por troca de postos RJM: ${pessoaOriginalLat} ‚Üî ${pessoaOriginalPed} no dia ${conflito.dia}`);
                    return true;
                }
            }

            // Se troca de postos n√£o resolveu, tentar substitui√ß√£o por pessoa da sequ√™ncia RJM
            const substitutoDisponivel = encontrarSubstitutoRJM(conflito.dia, conflito.pessoa);
            
            if (substitutoDisponivel) {
                // Aplicar substitui√ß√£o
                const campo = servicoRJM.campo;
                const pessoaOriginal = escalaAtual[indiceEscalaRJM][campo];
                
                escalaAtual[indiceEscalaRJM][campo] = substitutoDisponivel;
                
                // Salvar informa√ß√£o da substitui√ß√£o para exibi√ß√£o
                salvarSubstituicaoRealizada({
                    dia: conflito.dia,
                    servico: 'RJM',
                    tipo: 'Substitui√ß√£o de pessoa',
                    detalhes: `${pessoaOriginal} ‚Üí ${substitutoDisponivel} (${campo === 'pedOracao' ? 'Ped Ora√ß√£o' : 'Lateral'})`,
                    motivoOriginal: `Conflito de ${conflito.pessoa} com ${servicoIntacto.servico}`
                });
                
                console.log(`‚úÖ Conflito resolvido por substitui√ß√£o: ${pessoaOriginal} ‚Üí ${substitutoDisponivel} no ${servicoRJM.servico} dia ${conflito.dia}`);
                return true;
            } else {
                console.log(`‚ö†Ô∏è N√£o foi poss√≠vel encontrar substituto para ${conflito.pessoa} no dia ${conflito.dia}`);
                return false;
            }
        }

        // ==================== SISTEMA DE REGISTRO DE SUBSTITUI√á√ïES ====================
        
        let substituicoesRealizadas = [];

        function salvarSubstituicaoRealizada(substituicao) {
            substituicoesRealizadas.push(substituicao);
        }

        function limparSubstituicoes() {
            substituicoesRealizadas = [];
        }

        function exibirSubstituicoesRealizadas() {
            if (substituicoesRealizadas.length === 0) return '';

            let html = '<div style="background: #e8f5e8; border: 2px solid #4caf50; border-radius: 15px; padding: 20px; margin-bottom: 30px;">';
            html += '<h3 style="color: #2e7d32; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">';
            html += 'üîß Substitui√ß√µes Realizadas para Resolver Conflitos</h3>';
            
            substituicoesRealizadas.forEach((sub, index) => {
                html += `<div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <p style="margin: 0; font-weight: bold; color: #2e7d32;">üìÖ Dia ${sub.dia} - ${sub.servico}</p>
                    <p style="margin: 5px 0 0 0; font-size: 14px;">
                        <strong>${sub.tipo}:</strong> ${sub.detalhes}<br>
                        <em style="color: #666; font-size: 12px;">Motivo: ${sub.motivoOriginal}</em>
                    </p>
                </div>`;
            });
            
            html += '<p style="font-size: 12px; color: #666; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px;">';
            html += '<strong>üí° Nota:</strong> Apenas a escala RJM foi alterada. Todas as escalas oficiais permanecem inalteradas conforme a sequ√™ncia original.';
            html += '</p></div>';
            
            return html;
        }

        function encontrarSubstitutoRJM(dia, pessoaConflito) {
            // Pessoas j√° escaladas neste dia (evitar)
            const pessoasJaEscaladas = [];
            escalaAtual.filter(item => item.dia === dia).forEach(item => {
                if (item.pedOracao && item.pedOracao !== '-' && item.pedOracao !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.pedOracao);
                }
                if (item.principal && item.principal !== '-' && item.principal !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.principal);
                }
                if (item.lateral && item.lateral !== '-' && item.lateral !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.lateral);
                }
            });
            
            // Remover a pessoa em conflito da lista (ela pode ser substitu√≠da)
            const pessoasIndisponiveis = pessoasJaEscaladas.filter(p => p !== pessoaConflito);
            
            // Procurar na sequ√™ncia RJM algu√©m dispon√≠vel
            for (let i = 0; i < sequencias.rjm.length; i++) {
                const candidato = sequencias.rjm[i];
                if (!pessoasIndisponiveis.includes(candidato)) {
                    return candidato;
                }
            }
            
            return null; // Nenhum substituto encontrado
        }

        // ==================== DETEC√á√ÉO DE CONFLITOS ATUALIZADA v3.0 ====================
        
        function detectarConflitos(escala) {
            const conflitos = [];
            const diasComServicos = {};
            
            // Agrupar servi√ßos por dia
            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                if (!diasComServicos[item.dia]) {
                    diasComServicos[item.dia] = [];
                }
                diasComServicos[item.dia].push(item);
            }
            
            // Verificar conflitos no mesmo dia
            const dias = Object.keys(diasComServicos);
            for (let d = 0; d < dias.length; d++) {
                const dia = dias[d];
                const servicosDoDia = diasComServicos[dia];
                
                if (servicosDoDia.length > 1) {
                    for (let i = 0; i < servicosDoDia.length; i++) {
                        const servico1 = servicosDoDia[i];
                        for (let j = i + 1; j < servicosDoDia.length; j++) {
                            const servico2 = servicosDoDia[j];
                            
                            const pessoas1 = [servico1.pedOracao, servico1.principal, servico1.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            const pessoas2 = [servico2.pedOracao, servico2.principal, servico2.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            for (let p1 = 0; p1 < pessoas1.length; p1++) {
                                const pessoa = pessoas1[p1];
                                if (pessoas2.indexOf(pessoa) !== -1) {
                                    // Verificar se conflito j√° existe
                                    let conflitoDuplicado = false;
                                    for (let c = 0; c < conflitos.length; c++) {
                                        if (conflitos[c].dia === parseInt(dia) && conflitos[c].pessoa === pessoa) {
                                            conflitoDuplicado = true;
                                            break;
                                        }
                                    }
                                    
                                    if (!conflitoDuplicado) {
                                        conflitos.push({
                                            dia: parseInt(dia),
                                            pessoa: pessoa,
                                            servicos: [servico1.servico, servico2.servico]
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alertaDiv = document.getElementById('alertaConflitos');
            const listaDiv = document.getElementById('listaConflitos');
            const btnResolver = document.getElementById('btnResolverConflitos');
            
            if (conflitos.length === 0) {
                alertaDiv.style.display = 'none';
                btnResolver.style.display = 'none';
            } else {
                alertaDiv.style.display = 'block';
                btnResolver.style.display = 'block';
                
                let html = '<div style="background: #fff3e0; padding: 10px; border-radius: 8px; border: 1px solid #ff9800; margin-bottom: 15px;">';
                html += '<div style="display: flex; align-items: center; justify-content: space-between;">';
                html += '<p style="margin: 0; color: #f57c00; font-weight: bold;">üîß Resolu√ß√£o Autom√°tica Dispon√≠vel</p>';
                html += '<button onclick="resolverConflitosAutomatico()" style="background: #ff9800; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;">‚ú® Resolver Automaticamente</button>';
                html += '</div>';
                html += '<p style="margin: 5px 0 0 0; font-size: 12px; color: #666;">O sistema pode resolver conflitos automaticamente ajustando apenas a escala RJM.</p>';
                html += '</div>';
                
                for (let i = 0; i < conflitos.length; i++) {
                    const conflito = conflitos[i];
                    const sugestoes = gerarSugestoesConflito(conflito);
                    
                    html += `<div style="margin-bottom: 15px; padding: 10px; background: #fff; border-radius: 8px; border-left: 4px solid #f44336;">
                        <p><strong>üìÖ Dia ${conflito.dia}:</strong> <span style="color: #d32f2f; font-weight: bold;">${conflito.pessoa}</span> escalado em ${conflito.servicos.join(' e ')}</p>`;
                    
                    if (sugestoes.length > 0) {
                        html += `<div style="margin-top: 8px;">
                            <p style="font-size: 12px; color: #1976d2; font-weight: bold;">üí° Sugest√µes de resolu√ß√£o manual:</p>`;
                        
                        sugestoes.forEach((sugestao, index) => {
                            const corBotao = index === 0 ? '#4caf50' : '#2196f3';
                            
                            // Escapar aspas nos par√¢metros para evitar problemas no onclick
                            const diaParam = conflito.dia;
                            const campoParam = sugestao.campo.replace(/'/g, "\\'");
                            const valorAtualParam = sugestao.valorAtual.replace(/'/g, "\\'");
                            const novoValorParam = sugestao.novoValor.replace(/'/g, "\\'");
                            const servicoParam = sugestao.servico.replace(/'/g, "\\'");
                            
                            // Criar um ID √∫nico para cada bot√£o e usar atributos data
                            const botaoId = `btn-sugestao-${conflito.dia}-${index}`;
                            
                            html += `<div style="margin: 5px 0; padding: 6px 10px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid ${corBotao};">
                                <span style="font-size: 12px;">${sugestao.descricao}</span>
                                <button id="${botaoId}" 
                                        data-dia="${diaParam}"
                                        data-campo="${campoParam}"
                                        data-valor-atual="${valorAtualParam}"
                                        data-novo-valor="${novoValorParam}"
                                        data-servico="${servicoParam}"
                                        data-dados-troca='${sugestao.dadosTraca ? JSON.stringify(sugestao.dadosTraca) : 'null'}'
                                        style="background: ${corBotao}; color: white; border: none; padding: 3px 8px; border-radius: 3px; margin-left: 8px; cursor: pointer; font-size: 11px;">
                                    ‚ú® Aplicar
                                </button>
                            </div>`;
                        });
                        
                        html += '</div>';
                    }
                    
                    html += '</div>';
                }
                
                listaDiv.innerHTML = html;
                
                // Adicionar event listeners para os bot√µes ap√≥s inserir o HTML
                for (let i = 0; i < conflitos.length; i++) {
                    const conflito = conflitos[i];
                    const sugestoes = gerarSugestoesConflito(conflito);
                    
                    sugestoes.forEach((sugestao, index) => {
                        const botaoId = `btn-sugestao-${conflito.dia}-${index}`;
                        const botao = document.getElementById(botaoId);
                        
                        if (botao) {
                            botao.addEventListener('click', function() {
                                const dia = parseInt(this.getAttribute('data-dia'));
                                const campo = this.getAttribute('data-campo');
                                const valorAtual = this.getAttribute('data-valor-atual');
                                const novoValor = this.getAttribute('data-novo-valor');
                                const servico = this.getAttribute('data-servico');
                                const dadosTracaStr = this.getAttribute('data-dados-troca');
                                const dadosTraca = dadosTracaStr === 'null' ? null : JSON.parse(dadosTracaStr);
                                
                                aplicarSugestao(dia, campo, valorAtual, novoValor, servico, dadosTraca);
                            });
                        }
                    });
                }
            }
        }

        // ==================== SUGEST√ïES INTELIGENTES DE CONFLITOS v3.0 ====================
        
        function gerarSugestoesConflito(conflito) {
            const sugestoes = [];
            const dia = conflito.dia;
            const pessoaConflito = conflito.pessoa;
            
            // Encontrar os servi√ßos em conflito neste dia
            const servicosDoDia = escalaAtual.filter(item => item.dia === dia);
            const servicosComPessoa = servicosDoDia.filter(item => 
                [item.pedOracao, item.principal, item.lateral].includes(pessoaConflito)
            );
            
            if (servicosComPessoa.length >= 2) {
                // REGRA NOVA v3.0: Priorizar altera√ß√µes apenas em sequ√™ncias especiais
                const servicosFlexiveis = servicosComPessoa.filter(servico => 
                    ['RJM', 'R. SETOR', 'R. LOCAL', 'ENSAIO'].includes(servico.servico)
                );
                
                // Se h√° servi√ßos flex√≠veis, sugerir altera√ß√µes apenas neles
                if (servicosFlexiveis.length > 0) {
                    servicosFlexiveis.forEach(servico => {
                        const sugestoesPorServico = gerarSugestoesParaSequenciaEspecial(servico, pessoaConflito, dia);
                        sugestoes.push(...sugestoesPorServico);
                    });
                } else {
                    // Caso extremo: s√≥ servi√ßos oficiais (manter l√≥gica original como fallback)
                    servicosComPessoa.forEach((servico, index) => {
                        if (index > 0) {
                            const campo = encontrarCampoPessoa(servico, pessoaConflito);
                            if (campo) {
                                const substituicoesSugeridas = encontrarSubstitutosPossiveis(servico, campo, dia);
                                
                                substituicoesSugeridas.forEach((substituto, subIndex) => {
                                    const prioridade = subIndex === 0 ? 'ü•á' : subIndex === 1 ? 'ü•à' : 'ü•â';
                                    sugestoes.push({
                                        descricao: `${prioridade} Substituir "${pessoaConflito}" por "${substituto}" no ${servico.servico} (${campo})`,
                                        campo: campo,
                                        valorAtual: pessoaConflito,
                                        novoValor: substituto,
                                        servico: servico.servico,
                                        prioridade: subIndex + 10 // Baixa prioridade para servi√ßos oficiais
                                    });
                                });
                            }
                        }
                    });
                }
            }
            
            // Ordenar por prioridade (melhor sugest√£o primeiro)
            return sugestoes.sort((a, b) => a.prioridade - b.prioridade).slice(0, 3);
        }

        function gerarSugestoesParaSequenciaEspecial(servico, pessoaConflito, diaConflito) {
            const sugestoes = [];
            const tipoServico = servico.servico;
            
            // Encontrar todas as ocorr√™ncias desta sequ√™ncia especial no m√™s
            const outrasOcorrenciasSequencia = escalaAtual.filter(item => 
                item.servico === tipoServico && item.dia !== diaConflito
            );
            
            // Para cada outra ocorr√™ncia, verificar se podemos fazer uma troca
            outrasOcorrenciasSequencia.forEach(outraOcorrencia => {
                const pessoas = [outraOcorrencia.pedOracao, outraOcorrencia.principal, outraOcorrencia.lateral]
                    .filter(p => p && p !== '-' && p !== 'MESCLAR');
                
                pessoas.forEach(pessoaAlternativa => {
                    // Verificar se a pessoa alternativa est√° dispon√≠vel no dia do conflito
                    const pessoaDisponivelNoConflito = !estaPessoaEscaladaNoDia(pessoaAlternativa, diaConflito);
                    // Verificar se a pessoa em conflito est√° dispon√≠vel no outro dia
                    const pessoaConflitoDisponivelNoOutroDia = !estaPessoaEscaladaNoDia(pessoaConflito, outraOcorrencia.dia, tipoServico);
                    
                    if (pessoaDisponivelNoConflito && pessoaConflitoDisponivelNoOutroDia) {
                        const campoConflito = encontrarCampoPessoa(servico, pessoaConflito);
                        const campoAlternativo = encontrarCampoPessoa(outraOcorrencia, pessoaAlternativa);
                        
                        if (campoConflito && campoAlternativo) {
                            // Sugest√£o de troca entre dias
                            sugestoes.push({
                                descricao: `üîÑ Trocar "${pessoaConflito}" (dia ${diaConflito}) com "${pessoaAlternativa}" (dia ${outraOcorrencia.dia}) no ${tipoServico}`,
                                campo: campoConflito,
                                valorAtual: pessoaConflito,
                                novoValor: pessoaAlternativa,
                                servico: tipoServico,
                                prioridade: 0, // Alta prioridade para trocas dentro da sequ√™ncia
                                dadosTraca: {
                                    diaOrigem: diaConflito,
                                    diaDestino: outraOcorrencia.dia,
                                    campoDestino: campoAlternativo,
                                    pessoaDestino: pessoaAlternativa
                                }
                            });
                        }
                    }
                });
            });
            
            // Se n√£o h√° trocas poss√≠veis, sugerir substitui√ß√µes simples dentro da sequ√™ncia
            if (sugestoes.length === 0) {
                const campo = encontrarCampoPessoa(servico, pessoaConflito);
                if (campo) {
                    const sequenciaRelevante = obterSequenciaRelevante(tipoServico);
                    const pessoasDisponiveis = sequenciaRelevante.filter(pessoa => 
                        !estaPessoaEscaladaNoDia(pessoa, diaConflito)
                    );
                    
                    pessoasDisponiveis.slice(0, 3).forEach((substituto, index) => {
                        const prioridade = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                        sugestoes.push({
                            descricao: `${prioridade} Substituir "${pessoaConflito}" por "${substituto}" no ${tipoServico} (qualquer posto)`,
                            campo: campo,
                            valorAtual: pessoaConflito,
                            novoValor: substituto,
                            servico: tipoServico,
                            prioridade: index + 1
                        });
                    });
                }
            }
            
            return sugestoes;
        }

        function estaPessoaEscaladaNoDia(pessoa, dia, excluirServico = null) {
            const servicosDoDia = escalaAtual.filter(item => 
                item.dia === dia && (excluirServico ? item.servico !== excluirServico : true)
            );
            
            return servicosDoDia.some(item => 
                [item.pedOracao, item.principal, item.lateral].includes(pessoa)
            );
        }

        function obterSequenciaRelevante(tipoServico) {
            switch(tipoServico) {
                case 'RJM': return sequencias.rjm;
                case 'R. SETOR': return sequencias.rSetor;
                case 'R. LOCAL': return sequencias.rLocal;
                case 'ENSAIO': return sequencias.ensaio;
                default: return todosMembros;
            }
        }

        function encontrarCampoPessoa(servico, pessoa) {
            if (servico.pedOracao === pessoa) return 'pedOracao';
            if (servico.principal === pessoa) return 'principal';
            if (servico.lateral === pessoa) return 'lateral';
            return null;
        }

        function encontrarSubstitutosPossiveis(servico, campo, dia) {
            const substitutos = [];
            
            // Pessoas j√° escaladas neste dia (evitar)
            const pessoasJaEscaladas = [];
            escalaAtual.filter(item => item.dia === dia).forEach(item => {
                if (item.pedOracao && item.pedOracao !== '-' && item.pedOracao !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.pedOracao);
                }
                if (item.principal && item.principal !== '-' && item.principal !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.principal);
                }
                if (item.lateral && item.lateral !== '-' && item.lateral !== 'MESCLAR') {
                    pessoasJaEscaladas.push(item.lateral);
                }
            });
            
            // Determinar grupo relevante baseado no servi√ßo
            let grupoRelevante = [];
            const diaSemana = getDiaSemana(parseInt(document.getElementById('mesAno').value.split('-')[0]), 
                                         parseInt(document.getElementById('mesAno').value.split('-')[1]), dia);
            
            if (servico.servico === 'OFICIAL') {
                if (diaSemana === 2) grupoRelevante = gruposPorDia.terca;
                else if (diaSemana === 4) grupoRelevante = gruposPorDia.quinta;
                else if (diaSemana === 6) grupoRelevante = gruposPorDia.sabado;
                else if (diaSemana === 0) grupoRelevante = gruposPorDia.domingoOficial;
            } else {
                // Para servi√ßos especiais, usar toda a sequ√™ncia
                if (servico.servico === 'RJM') grupoRelevante = sequencias.rjm;
                else if (servico.servico === 'R. SETOR') grupoRelevante = sequencias.rSetor;
                else if (servico.servico === 'R. LOCAL') grupoRelevante = sequencias.rLocal;
                else if (servico.servico === 'ENSAIO') grupoRelevante = sequencias.ensaio;
            }
            
            // Sugerir pessoas do grupo relevante que n√£o est√£o escaladas no dia
            grupoRelevante.forEach(pessoa => {
                if (!pessoasJaEscaladas.includes(pessoa)) {
                    substitutos.push(pessoa);
                }
            });
            
            // Se n√£o h√° ningu√©m do grupo relevante dispon√≠vel, sugerir outros membros
            if (substitutos.length === 0) {
                todosMembros.forEach(pessoa => {
                    if (!pessoasJaEscaladas.includes(pessoa)) {
                        substitutos.push(pessoa);
                    }
                });
            }
            
            return substitutos.slice(0, 3); // M√°ximo 3 substitutos
        }

        function aplicarSugestao(dia, campo, valorAtual, novoValor, servico, dadosTraca = null) {
            let mensagemConfirmacao = `Aplicar sugest√£o?\n\nSubstituir "${valorAtual}" por "${novoValor}" no ${servico} do dia ${dia}?`;
            
            if (dadosTraca) {
                mensagemConfirmacao = `Aplicar troca?\n\n"${valorAtual}" (dia ${dia}) ‚Üî "${dadosTraca.pessoaDestino}" (dia ${dadosTraca.diaDestino})\nno ${servico}?`;
            }
            
            if (!confirm(mensagemConfirmacao)) {
                return;
            }
            
            // Encontrar o item na escala atual
            const indiceItem = escalaAtual.findIndex(item => 
                item.dia === dia && 
                item.servico === servico && 
                item[campo] === valorAtual
            );
            
            if (indiceItem !== -1) {
                // Aplicar a mudan√ßa principal
                escalaAtual[indiceItem][campo] = novoValor;
                
                // Se √© uma troca, aplicar a mudan√ßa no outro dia tamb√©m
                if (dadosTraca) {
                    const indiceItemDestino = escalaAtual.findIndex(item => 
                        item.dia === dadosTraca.diaDestino && 
                        item.servico === servico && 
                        item[dadosTraca.campoDestino] === dadosTraca.pessoaDestino
                    );
                    
                    if (indiceItemDestino !== -1) {
                        escalaAtual[indiceItemDestino][dadosTraca.campoDestino] = valorAtual;
                    }
                }
                
                // Atualizar a interface
                exibirEscala(escalaAtual);
                
                // Redetectar conflitos
                detectarConflitos(escalaAtual);
                
                // Salvar escala atualizada
                const mesAnoValue = document.getElementById('mesAno').value;
                if (mesAnoValue) {
                    const ano = parseInt(mesAnoValue.split('-')[0]);
                    const mes = parseInt(mesAnoValue.split('-')[1]);
                    const chaveEscala = `escala_${ano}_${mes}`;
                    salvarConfiguracoes(chaveEscala, escalaAtual);
                }
                
                // Mostrar feedback
                const mensagemSucesso = dadosTraca 
                    ? `‚úÖ Troca realizada com sucesso!\n\n"${valorAtual}" e "${dadosTraca.pessoaDestino}" trocaram de dias no ${servico}.`
                    : `‚úÖ Sugest√£o aplicada com sucesso!\n\n"${valorAtual}" foi substitu√≠do por "${novoValor}" no ${servico} do dia ${dia}.`;
                
                mostrarFeedback(mensagemSucesso.replace(/\n\n.*/, ''), 'sucesso');
            } else {
                mostrarFeedback('Erro ao aplicar sugest√£o. Tente fazer a altera√ß√£o manualmente.', 'erro');
            }
        }

        // ==================== EXIBI√á√ÉO DA ESCALA v3.0 ====================
        
        function exibirEscala(escala) {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                const row = document.createElement('tr');
                
                if (item.mesclar) {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td colspan="3" class="mesclar"><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" oncontextmenu="editarCampo(' + i + ', \'pedOracao\'); return false;" ondblclick="editarCampo(' + i + ', \'pedOracao\')" title="Duplo clique ou bot√£o direito para editar">' + item.pedOracao + '</span></td>';
                } else {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" oncontextmenu="editarCampo(' + i + ', \'pedOracao\'); return false;" ondblclick="editarCampo(' + i + ', \'pedOracao\')" title="Duplo clique ou bot√£o direito para editar">' + item.pedOracao + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.principal + '\')" oncontextmenu="editarCampo(' + i + ', \'principal\'); return false;" ondblclick="editarCampo(' + i + ', \'principal\')" title="Duplo clique ou bot√£o direito para editar">' + item.principal + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.lateral + '\')" oncontextmenu="editarCampo(' + i + ', \'lateral\'); return false;" ondblclick="editarCampo(' + i + ', \'lateral\')" title="Duplo clique ou bot√£o direito para editar">' + item.lateral + '</span></td>';
                }
                
                tbody.appendChild(row);
            }
            
            // Aplicar destaques se houver membro selecionado
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        // ==================== SISTEMA DE DESTAQUE v3.0 ====================
        
        function destacarMembro(nome) {
            if (nome === '-' || nome === 'MESCLAR') return;
            
            if (membroDestacadoAtual === nome) {
                limparDestaque();
            } else {
                membroDestacadoAtual = nome;
                document.getElementById('nomeDestacado').textContent = nome;
                document.getElementById('membroDestacado').style.display = 'block';
                aplicarDestaques();
            }
        }

        function limparDestaque() {
            membroDestacadoAtual = null;
            document.getElementById('membroDestacado').style.display = 'none';
            
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                editaveis[i].classList.remove('destaque');
            }
        }

        function aplicarDestaques() {
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                const elemento = editaveis[i];
                if (elemento.textContent === membroDestacadoAtual) {
                    elemento.classList.add('destaque');
                } else {
                    elemento.classList.remove('destaque');
                }
            }
        }

        // ==================== EDI√á√ÉO MANUAL v3.0 ====================
        
        function editarCampo(indiceEscala, campo) {
            if (editandoAtualmente) return; // J√° est√° editando algo
            
            editandoAtualmente = { indice: indiceEscala, campo: campo };
            
            const valorAtual = escalaAtual[indiceEscala][campo];
            
            // Encontrar o elemento na tela
            const tbody = document.getElementById('corpoTabela');
            const rows = tbody.children;
            const targetRow = rows[indiceEscala];
            
            let targetCell;
            if (escalaAtual[indiceEscala].mesclar) {
                targetCell = targetRow.children[3].querySelector('.editavel');
            } else {
                const colIndex = campo === 'pedOracao' ? 3 : campo === 'principal' ? 4 : 5;
                targetCell = targetRow.children[colIndex].querySelector('.editavel');
            }
            
            // Criar dropdown
            const dropdown = document.createElement('select');
            dropdown.className = 'dropdown-edicao';
            
            // Adicionar op√ß√µes
            const opcaoVazia = document.createElement('option');
            opcaoVazia.value = '-';
            opcaoVazia.textContent = '-';
            dropdown.appendChild(opcaoVazia);
            
            for (let i = 0; i < todosMembros.length; i++) {
                const opcao = document.createElement('option');
                opcao.value = todosMembros[i];
                opcao.textContent = todosMembros[i];
                if (todosMembros[i] === valorAtual) {
                    opcao.selected = true;
                }
                dropdown.appendChild(opcao);
            }
            
            // Criar bot√µes
            const btnSalvar = document.createElement('button');
            btnSalvar.textContent = '‚úì';
            btnSalvar.className = 'btn-edicao';
            btnSalvar.onclick = function() { salvarEdicao(dropdown.value); };
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚úï';
            btnCancelar.className = 'btn-edicao btn-cancelar';
            btnCancelar.onclick = cancelarEdicao;
            
            // Substituir conte√∫do
            const conteudoOriginal = targetCell.innerHTML;
            targetCell.innerHTML = '';
            targetCell.appendChild(dropdown);
            targetCell.appendChild(btnSalvar);
            targetCell.appendChild(btnCancelar);
            targetCell.classList.add('editando');
            
            // Focar no dropdown
            dropdown.focus();
            
            // Salvar refer√™ncia para cancelar
            editandoAtualmente.elementoOriginal = targetCell;
            editandoAtualmente.conteudoOriginal = conteudoOriginal;
        }

        function salvarEdicao(novoValor) {
            if (!editandoAtualmente) return;
            
            // Atualizar dados
            escalaAtual[editandoAtualmente.indice][editandoAtualmente.campo] = novoValor;
            
            // Restaurar elemento
            const elemento = editandoAtualmente.elementoOriginal;
            const indice = editandoAtualmente.indice;
            const campo = editandoAtualmente.campo;
            
            elemento.innerHTML = '<span class="editavel" onclick="destacarMembro(\'' + novoValor + '\')" oncontextmenu="editarCampo(' + indice + ', \'' + campo + '\'); return false;" ondblclick="editarCampo(' + indice + ', \'' + campo + '\')" title="Duplo clique ou bot√£o direito para editar">' + novoValor + '</span>';
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
            
            // Redetectar conflitos
            detectarConflitos(escalaAtual);
            
            // Reaplicar destaques
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        function cancelarEdicao() {
            if (!editandoAtualmente) return;
            
            // Restaurar conte√∫do original
            const elemento = editandoAtualmente.elementoOriginal;
            elemento.innerHTML = editandoAtualmente.conteudoOriginal;
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
        }

        // ==================== GERENCIADOR DE GRUPOS v3.0 ====================
        
        function abrirGerenciador() {
            const modal = document.getElementById('modalGerenciador');
            modal.style.display = 'block';
            atualizarInterfaceGerenciador();
        }

        function fecharGerenciador() {
            const modal = document.getElementById('modalGerenciador');
            modal.style.display = 'none';
        }

        function mostrarTab(tabNome) {
            // Esconder todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Mostrar tab selecionada
            document.getElementById('tab-' + tabNome).classList.add('active');
            event.target.classList.add('active');
        }

        function atualizarInterfaceGerenciador() {
            // Atualizar grupos semanais
            const gruposSemanais = ['terca', 'quinta', 'sabado', 'domingoOficial'];
            gruposSemanais.forEach(grupo => {
                atualizarListaMembros(grupo, gruposPorDia[grupo], 'grupo');
                atualizarSelectMembros(grupo);
            });

            // Atualizar sequ√™ncias especiais
            const sequenciasEspeciais = ['rjm', 'rSetor', 'rLocal', 'ensaio'];
            sequenciasEspeciais.forEach(seq => {
                atualizarListaMembros(seq, sequencias[seq], 'sequencia');
                atualizarSelectMembros(seq);
            });
            
            // Atualizar lista de membros
            atualizarListaTodosMembros();
        }

        function atualizarListaMembros(nomeGrupo, membros, tipo) {
            const container = document.getElementById((tipo === 'grupo' ? 'grupo-' : 'sequencia-') + nomeGrupo);
            container.innerHTML = '';

            membros.forEach((membro, index) => {
                const item = document.createElement('div');
                item.className = 'membro-item';
                item.innerHTML = `
                    <span class="membro-nome">${membro}</span>
                    <button class="btn-mover" onclick="moverMembro('${nomeGrupo}', ${index}, -1, '${tipo}')">‚Üë</button>
                    <button class="btn-mover" onclick="moverMembro('${nomeGrupo}', ${index}, 1, '${tipo}')">‚Üì</button>
                    <button class="btn-remover" onclick="removerMembro('${nomeGrupo}', ${index}, '${tipo}')">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function atualizarSelectMembros(nomeGrupo) {
            const select = document.getElementById('select-' + nomeGrupo);
            select.innerHTML = '<option value="">Selecione um membro...</option>';

            todosMembros.forEach(membro => {
                const option = document.createElement('option');
                option.value = membro;
                option.textContent = membro;
                select.appendChild(option);
            });
        }

        function adicionarMembro(nomeGrupo) {
            const select = document.getElementById('select-' + nomeGrupo);
            const novoMembro = select.value;

            if (!novoMembro) {
                alert('Selecione um membro primeiro!');
                return;
            }

            // Verificar se √© grupo ou sequ√™ncia
            let isGrupo = ['terca', 'quinta', 'sabado', 'domingoOficial'].includes(nomeGrupo);
            let lista = isGrupo ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];

            if (lista.includes(novoMembro)) {
                alert('Este membro j√° est√° neste grupo/sequ√™ncia!');
                return;
            }

            lista.push(novoMembro);
            atualizarListaMembros(nomeGrupo, lista, isGrupo ? 'grupo' : 'sequencia');
            select.value = '';
        }

        function removerMembro(nomeGrupo, index, tipo) {
            if (!confirm('Tem certeza que deseja remover este membro?')) return;

            let lista = tipo === 'grupo' ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];
            lista.splice(index, 1);
            atualizarListaMembros(nomeGrupo, lista, tipo);
        }

        function moverMembro(nomeGrupo, index, direcao, tipo) {
            let lista = tipo === 'grupo' ? gruposPorDia[nomeGrupo] : sequencias[nomeGrupo];
            const novoIndex = index + direcao;

            if (novoIndex < 0 || novoIndex >= lista.length) return;

            // Trocar posi√ß√µes
            [lista[index], lista[novoIndex]] = [lista[novoIndex], lista[index]];
            atualizarListaMembros(nomeGrupo, lista, tipo);
        }

        function salvarAlteracoes() {
            if (!confirm('Salvar altera√ß√µes e regenerar escala?')) return;

            // Salvar no localStorage
            salvarConfiguracoes('grupos', gruposPorDia);
            salvarConfiguracoes('sequencias', sequencias);
            salvarConfiguracoes('membros', todosMembros);

            // NOVA FUNCIONALIDADE: Limpar escalas salvas para for√ßar regenera√ß√£o
            limparEscalasSalvas();

            // Fechar modal
            fecharGerenciador();

            // Regenerar escala
            gerarEscala();

            alert('‚úÖ Altera√ß√µes salvas com sucesso! Escala regenerada.');
        }

        function restaurarPadrao() {
            if (!confirm('Restaurar configura√ß√µes padr√£o? Todas as altera√ß√µes ser√£o perdidas!')) return;

            // Restaurar grupos padr√£o
            gruposPorDia.terca = [...gruposPadraoOriginal.terca];
            gruposPorDia.quinta = [...gruposPadraoOriginal.quinta];
            gruposPorDia.sabado = [...gruposPadraoOriginal.sabado];
            gruposPorDia.domingoOficial = [...gruposPadraoOriginal.domingoOficial];
            
            sequencias.rjm = [...sequenciasPadraoOriginal.rjm];
            sequencias.rSetor = [...sequenciasPadraoOriginal.rSetor];
            sequencias.rLocal = [...sequenciasPadraoOriginal.rLocal];
            sequencias.ensaio = [...sequenciasPadraoOriginal.ensaio];

            // Restaurar lista de membros padr√£o
            todosMembros = [
                'AFONSO', 'ALGACIR', 'JONAS', 'ZANIN', 'EDI', 'MARCOS', 'SAULO',
                'JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU', 'JOS√â CARDOSO',
                'ODEMIR', 'SAMUEL', 'EDIVAN', 'C√âLIO'
            ];

            // Limpar √≠ndices salvos (restart das sequ√™ncias)
            localStorage.removeItem('escalas_indices');
            
            // NOVA FUNCIONALIDADE: Limpar todas as escalas salvas
            limparEscalasSalvas();

            // Atualizar interface
            atualizarInterfaceGerenciador();

            alert('‚úÖ Configura√ß√µes padr√£o restauradas! Sequ√™ncias e escalas reiniciadas.');
        }

        function reiniciarSequencias() {
            if (!confirm('Reiniciar todas as sequ√™ncias do in√≠cio? Isso vai resetar a continuidade entre meses.')) return;
            
            localStorage.removeItem('escalas_indices');
            
            // NOVA FUNCIONALIDADE: Limpar escalas salvas para regenera√ß√£o
            limparEscalasSalvas();
            
            alert('‚úÖ Sequ√™ncias reiniciadas! Escalas existentes ser√£o regeneradas.');
        }

        // ==================== NOVA FUN√á√ÉO: GERENCIAR ESCALAS SALVAS ====================
        
        function limparEscalasSalvas() {
            // Remover todas as escalas salvas (chaves que come√ßam com 'escala_')
            const chavesParaRemover = [];
            for (let i = 0; i < localStorage.length; i++) {
                const chave = localStorage.key(i);
                if (chave && chave.startsWith('escalas_escala_')) {
                    chavesParaRemover.push(chave);
                }
            }
            
            chavesParaRemover.forEach(chave => {
                localStorage.removeItem(chave);
            });
            
            console.log(`üóëÔ∏è ${chavesParaRemover.length} escalas salvas removidas para regenera√ß√£o`);
        }

        function adicionarNovaSerieEscalas() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° limpar TODAS as escalas salvas e reiniciar as sequ√™ncias.\n\nUse apenas quando quiser come√ßar uma nova s√©rie de escalas (ex: novo ano).\n\nContinuar?')) return;
            
            // Limpar tudo
            localStorage.removeItem('escalas_indices');
            limparEscalasSalvas();
            
            // Regenerar escala atual
            gerarEscala();
            
            alert('‚úÖ Nova s√©rie de escalas iniciada! Todas as escalas anteriores foram limpas.');
        }

        // ==================== GERENCIAMENTO DE MEMBROS v3.0 ====================
        
        function atualizarListaTodosMembros() {
            const container = document.getElementById('lista-membros');
            container.innerHTML = '';

            todosMembros.forEach((membro, index) => {
                const item = document.createElement('div');
                item.className = 'membro-item';
                item.innerHTML = `
                    <span class="membro-nome">${membro}</span>
                    <button class="btn-mover" onclick="moverMembroGeral(${index}, -1)">‚Üë</button>
                    <button class="btn-mover" onclick="moverMembroGeral(${index}, 1)">‚Üì</button>
                    <button class="btn-remover" onclick="removerMembroGeral(${index})">üóëÔ∏è</button>
                `;
                container.appendChild(item);
            });
        }

        function adicionarNovoMembro() {
            const input = document.getElementById('input-novo-membro');
            const novoMembro = input.value.trim().toUpperCase();

            if (!novoMembro) {
                alert('Digite o nome do novo membro!');
                return;
            }

            if (todosMembros.includes(novoMembro)) {
                alert('Este membro j√° existe no sistema!');
                return;
            }

            // Adicionar √† lista de membros
            todosMembros.push(novoMembro);
            
            // Atualizar interface
            atualizarListaTodosMembros();
            atualizarTodosSelects();
            
            // Limpar input
            input.value = '';
            
            alert(`‚úÖ Membro "${novoMembro}" adicionado com sucesso!\nAgora voc√™ pode inclu√≠-lo nos grupos e sequ√™ncias desejados.`);
        }

        function removerMembroGeral(index) {
            const membro = todosMembros[index];
            
            if (!confirm(`Tem certeza que deseja remover "${membro}" completamente do sistema?\n\nEle ser√° removido de todos os grupos e sequ√™ncias automaticamente.`)) return;

            // Remover da lista principal
            todosMembros.splice(index, 1);
            
            // Remover de todos os grupos e sequ√™ncias
            Object.keys(gruposPorDia).forEach(grupo => {
                const indiceNoGrupo = gruposPorDia[grupo].indexOf(membro);
                if (indiceNoGrupo !== -1) {
                    gruposPorDia[grupo].splice(indiceNoGrupo, 1);
                }
            });
            
            Object.keys(sequencias).forEach(seq => {
                const indiceNaSeq = sequencias[seq].indexOf(membro);
                if (indiceNaSeq !== -1) {
                    sequencias[seq].splice(indiceNaSeq, 1);
                }
            });
            
            // Atualizar toda a interface
            atualizarInterfaceGerenciador();
            
            alert(`‚úÖ Membro "${membro}" removido de todo o sistema!`);
        }

        function moverMembroGeral(index, direcao) {
            const novoIndex = index + direcao;

            if (novoIndex < 0 || novoIndex >= todosMembros.length) return;

            // Trocar posi√ß√µes
            [todosMembros[index], todosMembros[novoIndex]] = [todosMembros[novoIndex], todosMembros[index]];
            atualizarListaTodosMembros();
        }
        
        function atualizarTodosSelects() {
            // Atualizar todos os selects com a nova lista de membros
            const gruposSemanais = ['terca', 'quinta', 'sabado', 'domingoOficial'];
            const sequenciasEspeciais = ['rjm', 'rSetor', 'rLocal', 'ensaio'];
            
            gruposSemanais.forEach(grupo => {
                atualizarSelectMembros(grupo);
            });
            
            sequenciasEspeciais.forEach(seq => {
                atualizarSelectMembros(seq);
            });
        }

        // ==================== GERA√á√ÉO DE PDF v3.0 ====================
        
        function gerarPDF() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) {
                alert('Selecione um m√™s primeiro!');
                return;
            }

            const ano = mesAnoValue.split('-')[0];
            const mes = mesAnoValue.split('-')[1];
            const meses = [
                'JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'
            ];
            const mesNome = meses[parseInt(mes) - 1];
            
            // Construir linhas HTML com cores baseadas na escala atual
            let linhasHTML = '';
            for (let i = 0; i < escalaAtual.length; i++) {
                const item = escalaAtual[i];
                
                // Determinar cor de fundo baseada no servi√ßo (conforme documenta√ß√£o v3.0)
                let corFundo = '';
                switch(item.servico) {
                    case 'OFICIAL':
                        corFundo = '#e3f2fd';
                        break;
                    case 'RJM':
                        corFundo = '#e8f5e8';
                        break;
                    case 'R. SETOR':
                        corFundo = '#fff3e0';
                        break;
                    case 'R. LOCAL':
                        corFundo = '#f3e5f5';
                        break;
                    case 'ENSAIO':
                        corFundo = '#e8eaf6';
                        break;
                    default:
                        corFundo = '#ffffff';
                }
                
                if (item.mesclar) {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td colspan="3" style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                    </tr>`;
                } else {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.principal}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.lateral}</td>
                    </tr>`;
                }
            }
            
            const htmlContent = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Escala de Porteiros - ${mesNome} ${ano}</title>
                <style>
                    @page { 
                        margin: 2cm; 
                        size: A4; 
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 0; 
                        padding: 0; 
                        color: #333; 
                    }
                    .cabecalho { 
                        text-align: center; 
                        margin-bottom: 30px; 
                    }
                    .cabecalho h1 { 
                        font-size: 16px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h2 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h3 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .versao {
                        font-size: 10px;
                        color: #666;
                        margin-top: 10px;
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        font-size: 12px; 
                    }
                    th { 
                        background-color: #f0f0f0; 
                        font-weight: bold; 
                        text-align: center; 
                        padding: 10px 8px; 
                        border: 1px solid #333; 
                    }
                    td { 
                        text-align: center; 
                        padding: 8px; 
                        border: 1px solid #333; 
                    }
                    
                    /* Configura√ß√µes para impress√£o colorida */
                    @media print {
                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="cabecalho">
                    <h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
                    <h2>ESCALA DE PORTEIROS</h2>
                    <h3>${mesNome} DE ${ano}</h3>
                    <div class="versao">Sistema v3.0 - Gerado com Continuidade Total</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DIA</th>
                            <th>DIA DA SEMANA</th>
                            <th>SERVI√áO</th>
                            <th>PED ORA√á√ÉO</th>
                            <th>PRINCIPAL</th>
                            <th>LATERAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhasHTML}
                    </tbody>
                </table>
            </body>
            </html>`;
            
            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(htmlContent);
            novaJanela.document.close();
            setTimeout(function() { 
                novaJanela.print(); 
            }, 1000);
        }

        // ==================== INICIALIZA√á√ÉO DO SISTEMA v3.0 ====================
        
        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalGerenciador');
            if (event.target === modal) {
                fecharGerenciador();
            }
        };

        // ==================== INICIALIZA√á√ÉO DO SISTEMA v3.0 - CORRIGIDA ====================
        
        // Verificar compatibilidade do navegador
        function verificarCompatibilidade() {
            try {
                // Testar localStorage
                localStorage.setItem('teste', 'teste');
                localStorage.removeItem('teste');
                
                // Testar APIs necess√°rias
                if (!Date || !JSON || !Array.prototype.forEach) {
                    throw new Error('APIs b√°sicas n√£o suportadas');
                }
                
                return true;
            } catch (e) {
                mostrarFeedback('Seu navegador pode n√£o ser compat√≠vel com este sistema.', 'erro');
                return false;
            }
        }

        // Inicializar com m√™s atual
        window.onload = function() {
            console.log('üéâ Iniciando Sistema de Escalas CCB v3.0...');
            
            // Verificar compatibilidade
            if (!verificarCompatibilidade()) {
                return;
            }
            
            try {
                const hoje = new Date();
                const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
                document.getElementById('mesAno').value = mesAtual;
                
                // Atualizar texto do m√™s
                atualizarMesTexto();
                
                // Validar configura√ß√£o
                if (!validarConfiguracao()) {
                    console.warn('‚ö†Ô∏è Sistema carregado com configura√ß√£o incompleta');
                    return;
                }
                
                // Gerar escala
                gerarEscala();
                
                console.log('‚úÖ Sistema carregado com sucesso!');
                mostrarFeedback('Sistema carregado com sucesso!', 'sucesso');
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar sistema:', error);
                mostrarFeedback('Erro ao carregar o sistema: ' + error.message, 'erro');
            }
        };

        // ==================== FUN√á√ïES DE DEBUG E MONITORAMENTO v3.0 ====================
        
        // Fun√ß√£o para verificar estado das sequ√™ncias (√∫til para debug)
        function verificarEstadoSequencias() {
            const indices = carregarIndices();
            console.log('Estado atual das sequ√™ncias:', indices);
            console.log('Grupos semanais:', gruposPorDia);
            console.log('Sequ√™ncias especiais:', sequencias);
            console.log('Todos os membros:', todosMembros);
        }

        // Fun√ß√£o para exportar configura√ß√µes (funcionalidade futura)
        function exportarConfiguracoes() {
            const configuracoes = {
                versao: '3.0',
                grupos: gruposPorDia,
                sequencias: sequencias,
                membros: todosMembros,
                indices: carregarIndices(),
                dataExportacao: new Date().toISOString()
            };
            
            const json = JSON.stringify(configuracoes, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `escalas_ccb_config_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== FUN√á√ïES AUXILIARES DE VALIDA√á√ÉO ====================
        
        function validarConfiguracao() {
            // Verificar se grupos t√™m membros suficientes
            const erros = [];
            
            if (!gruposPorDia.terca || gruposPorDia.terca.length < 3) {
                erros.push('Grupo 3¬™ feira precisa de pelo menos 3 membros');
            }
            if (!gruposPorDia.quinta || gruposPorDia.quinta.length < 3) {
                erros.push('Grupo 5¬™ feira precisa de pelo menos 3 membros');
            }
            if (!gruposPorDia.sabado || gruposPorDia.sabado.length < 3) {
                erros.push('Grupo s√°bado precisa de pelo menos 3 membros');
            }
            if (!gruposPorDia.domingoOficial || gruposPorDia.domingoOficial.length < 3) {
                erros.push('Grupo domingo precisa de pelo menos 3 membros');
            }
            
            if (!sequencias.rjm || sequencias.rjm.length < 2) {
                erros.push('Sequ√™ncia RJM precisa de pelo menos 2 membros');
            }
            if (!sequencias.rSetor || sequencias.rSetor.length < 1) {
                erros.push('Sequ√™ncia R.SETOR precisa de pelo menos 1 membro');
            }
            if (!sequencias.rLocal || sequencias.rLocal.length < 1) {
                erros.push('Sequ√™ncia R.LOCAL precisa de pelo menos 1 membro');
            }
            if (!sequencias.ensaio || sequencias.ensaio.length < 2) {
                erros.push('Sequ√™ncia ENSAIO precisa de pelo menos 2 membros');
            }
            
            if (erros.length > 0) {
                mostrarFeedback('Configura√ß√£o incompleta: ' + erros[0], 'erro');
                return false;
            }
            
            return true;
        }

        // ==================== EVENTOS E TRATAMENTO DE ERROS v3.0 ====================
        
        // Adicionar tratamento global de erros
        window.onerror = function(msg, url, linha, coluna, erro) {
            console.error('‚ùå Erro JavaScript:', {
                mensagem: msg,
                linha: linha,
                coluna: coluna,
                erro: erro
            });
            
            // N√£o mostrar alert para n√£o irritar o usu√°rio
            // mostrarFeedback('Erro interno do sistema. Verifique o console.', 'erro');
            return false; // Permitir que o erro seja tratado pelo navegador
        };

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('modalGerenciador');
            if (event.target === modal) {
                fecharGerenciador();
            }
        };

        // Adicionar atalhos de teclado
        document.addEventListener('keydown', function(event) {
            try {
                // Ctrl + G = Gerar Escala
                if (event.ctrlKey && event.key === 'g') {
                    event.preventDefault();
                    gerarEscala();
                }
                
                // Ctrl + P = Gerar PDF
                if (event.ctrlKey && event.key === 'p') {
                    event.preventDefault();
                    gerarPDF();
                }
                
                // Ctrl + M = Abrir Gerenciador
                if (event.ctrlKey && event.key === 'm') {
                    event.preventDefault();
                    abrirGerenciador();
                }
                
                // Escape = Fechar Modal
                if (event.key === 'Escape') {
                    fecharGerenciador();
                    if (editandoAtualmente) {
                        cancelarEdicao();
                    }
                }
                
                // F1 = Ajuda
                if (event.key === 'F1') {
                    event.preventDefault();
                    mostrarAjuda();
                }
            } catch (error) {
                console.error('Erro no evento de teclado:', error);
            }
        });

        // ==================== SISTEMA DE FEEDBACK v3.0 ====================
        
        function mostrarFeedback(mensagem, tipo = 'sucesso') {
            // Criar elemento de feedback tempor√°rio
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
                max-width: 300px;
            `;
            
            switch (tipo) {
                case 'sucesso':
                    feedback.style.backgroundColor = '#4caf50';
                    feedback.innerHTML = '‚úÖ ' + mensagem;
                    break;
                case 'erro':
                    feedback.style.backgroundColor = '#f44336';
                    feedback.innerHTML = '‚ùå ' + mensagem;
                    break;
                case 'aviso':
                    feedback.style.backgroundColor = '#ff9800';
                    feedback.innerHTML = '‚ö†Ô∏è ' + mensagem;
                    break;
                case 'info':
                    feedback.style.backgroundColor = '#2196f3';
                    feedback.innerHTML = '‚ÑπÔ∏è ' + mensagem;
                    break;
            }
            
            document.body.appendChild(feedback);
            
            // Remover ap√≥s 3 segundos
            setTimeout(() => {
                feedback.style.opacity = '0';
                feedback.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.parentNode.removeChild(feedback);
                    }
                }, 300);
            }, 3000);
        }

        // ==================== ANALYTICS E ESTAT√çSTICAS v3.0 ====================
        
        function gerarEstatisticasEscala() {
            if (escalaAtual.length === 0) {
                alert('Gere uma escala primeiro!');
                return;
            }
            
            const estatisticas = {};
            const contadorServicos = {};
            
            // Contar participa√ß√µes por membro
            escalaAtual.forEach(item => {
                // Contar por pessoa
                [item.pedOracao, item.principal, item.lateral].forEach(pessoa => {
                    if (pessoa && pessoa !== '-' && pessoa !== 'MESCLAR') {
                        if (!estatisticas[pessoa]) estatisticas[pessoa] = 0;
                        estatisticas[pessoa]++;
                    }
                });
                
                // Contar por tipo de servi√ßo
                if (!contadorServicos[item.servico]) contadorServicos[item.servico] = 0;
                contadorServicos[item.servico]++;
            });
            
            // Montar relat√≥rio
            let relatorio = 'üìä ESTAT√çSTICAS DA ESCALA ATUAL\n\n';
            relatorio += 'üë• PARTICIPA√á√ïES POR MEMBRO:\n';
            
            const ordenados = Object.entries(estatisticas).sort((a, b) => b[1] - a[1]);
            ordenados.forEach(([nome, count]) => {
                relatorio += `${nome}: ${count} participa√ß√µes\n`;
            });
            
            relatorio += '\nüìã SERVI√áOS DO M√äS:\n';
            Object.entries(contadorServicos).forEach(([servico, count]) => {
                relatorio += `${servico}: ${count} ocorr√™ncias\n`;
            });
            
            alert(relatorio);
        }

        // ==================== FUN√á√ïES AUXILIARES FINAIS v3.0 ====================
        
        // Fun√ß√£o para verificar compatibilidade do navegador
        function verificarCompatibilidade() {
            try {
                // Testar localStorage
                localStorage.setItem('teste', 'teste');
                localStorage.removeItem('teste');
                
                // Testar APIs necess√°rias
                if (!Date || !JSON || !Array.prototype.forEach) {
                    throw new Error('APIs b√°sicas n√£o suportadas');
                }
                
                return true;
            } catch (e) {
                alert('‚ö†Ô∏è Seu navegador pode n√£o ser totalmente compat√≠vel com este sistema.\n\nRecomendamos usar Chrome, Firefox ou Edge atualizados.');
                return false;
            }
        }

        // Verificar compatibilidade na inicializa√ß√£o
        if (typeof window !== 'undefined') {
            verificarCompatibilidade();
        }

        // ==================== SISTEMA DE AJUDA E DEBUG v3.0 ====================
        
        function mostrarAjuda() {
            const ajuda = `
üéØ SISTEMA DE ESCALAS CCB v3.0 - GUIA R√ÅPIDO

üìã GERAR ESCALA:
1. Selecione o m√™s clicando no √≠cone üìÖ
2. Clique "üîÑ Gerar Escala"
3. Sistema mant√©m continuidade autom√°tica

‚úèÔ∏è EDITAR:
‚Ä¢ Duplo clique OU bot√£o direito em qualquer nome
‚Ä¢ Escolha substituto e clique ‚úì

üîß RESOLVER CONFLITOS:
‚Ä¢ Clique "üîß Resolver Conflitos" (aparece automaticamente)
‚Ä¢ Sistema ajusta apenas RJM, mant√©m escalas oficiais

‚öôÔ∏è GERENCIAR:
‚Ä¢ Use "‚öôÔ∏è Gerenciar Grupos" para configurar membros

‚å®Ô∏è ATALHOS:
‚Ä¢ Ctrl+G = Gerar Escala
‚Ä¢ Ctrl+P = PDF
‚Ä¢ Ctrl+M = Gerenciar
‚Ä¢ F1 = Esta ajuda

üéâ SISTEMA v3.0 - 100% FUNCIONAL
            `;
            
            alert(ajuda);
        }

        // Debug - verificar estado do sistema
        function debugSistema() {
            console.log('üîç DEBUG DO SISTEMA:');
            console.log('Grupos:', gruposPorDia);
            console.log('Sequ√™ncias:', sequencias);
            console.log('Membros:', todosMembros);
            console.log('Escala atual:', escalaAtual);
            console.log('√çndices:', carregarIndices());
            console.log('Substitui√ß√µes:', substituicoesRealizadas);
        }

        // Disponibilizar fun√ß√£o debug globalmente para teste
        window.debugSistema = debugSistema;

        // ==================== FINALIZA√á√ÉO v3.0 ====================
        
        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë                                                              ‚ïë
        ‚ïë     üéâ SISTEMA DE ESCALAS CCB v3.0 CARREGADO COM SUCESSO     ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  ‚úÖ Continuidade Total Entre Meses Implementada              ‚ïë
        ‚ïë  ‚úÖ Edi√ß√£o Manual Aprimorada (Duplo Clique + Bot√£o Direito) ‚ïë  
        ‚ïë  ‚úÖ Detec√ß√£o Inteligente de Conflitos                       ‚ïë
        ‚ïë  ‚úÖ Gerenciamento Completo de Grupos e Sequ√™ncias           ‚ïë
        ‚ïë  ‚úÖ PDF Colorido Profissional                               ‚ïë
        ‚ïë  ‚úÖ Persist√™ncia Total de Configura√ß√µes                     ‚ïë
        ‚ïë  ‚úÖ Sistema 100% Funcional e Robusto                        ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïë  üìã Desenvolvido para CCB Santa Am√©lia - Curitiba PR        ‚ïë
        ‚ïë  üôè Para a obra de Deus com excel√™ncia t√©cnica              ‚ïë
        ‚ïë                                                              ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        `);

    </script>
</body>
</html>
