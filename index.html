<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Porteiros - CCB Santa Am√©lia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 { color: #1976d2; font-size: 28px; margin-bottom: 10px; }
        .header p { color: #666; font-size: 16px; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .mes-selector {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        
        .mes-texto {
            font-weight: bold;
            color: #1976d2;
            min-width: 150px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary { background: #1976d2; color: white; }
        .btn-primary:hover { background: #1565c0; }
        .btn-danger { background: #d32f2f; color: white; }
        .btn-danger:hover { background: #c62828; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #45a049; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; }
        
        .tabela-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th {
            background: #f5f5f5;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
        }
        td { padding: 12px 10px; border-bottom: 1px solid #eee; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #e3f2fd; }
        
        .servico-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
        }
        
        .oficial { background: #e3f2fd; color: #1976d2; }
        .rjm { background: #e8f5e8; color: #388e3c; }
        .rsetor { background: #fff3e0; color: #f57c00; }
        .rlocal { background: #f3e5f5; color: #7b1fa2; }
        .ensaio { background: #e8eaf6; color: #3f51b5; }
        
        .editavel {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            min-width: 60px;
            display: inline-block;
        }
        .editavel:hover { background: #e3f2fd; border: 1px dashed #1976d2; }
        
        .conflitos {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .conflitos h3 { color: #d32f2f; margin-bottom: 10px; }
        
        .substituicoes {
            background: #e8f5e8;
            border: 2px solid #4caf50;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            z-index: 9999;
            display: none;
        }
        
        .feedback.sucesso { background: #4caf50; }
        .feedback.erro { background: #f44336; }
        .feedback.info { background: #2196f3; }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gerador de Escalas de Servi√ßo</h1>
            <p>Congrega√ß√£o Crist√£ no Brasil - Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <div class="mes-selector">
                <span>üìÖ M√™s Selecionado:</span>
                <span id="mesTexto" class="mes-texto">AGOSTO DE 2025</span>
                <button onclick="selecionarMes()" class="btn btn-primary" style="padding: 6px 8px;">üìÖ</button>
                <input type="month" id="mesAno" style="display: none;">
            </div>
            <button onclick="gerarEscala()" class="btn btn-primary">üîÑ Gerar Escala</button>
            <button onclick="gerarPDF()" class="btn btn-danger">üìÑ Gerar PDF</button>
            <button onclick="abrirGerenciador()" class="btn btn-success">‚öôÔ∏è Gerenciar</button>
            <button onclick="resolverConflitos()" id="btnConflitos" class="btn btn-warning" style="display: none;">üîß Resolver Conflitos</button>
        </div>
        
        <div id="alertaSubstituicoes" class="substituicoes">
            <h3>üîß Substitui√ß√µes Realizadas</h3>
            <div id="listaSubstituicoes"></div>
        </div>
        
        <div id="alertaConflitos" class="conflitos">
            <h3>‚ö†Ô∏è Conflitos Detectados</h3>
            <div id="listaConflitos"></div>
        </div>
        
        <div class="tabela-container">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="tabelaCorpo"></tbody>
            </table>
        </div>
        
        <div id="modalGerenciador" class="modal">
            <div class="modal-content">
                <h2>‚öôÔ∏è Gerenciar Grupos</h2>
                <div id="gerenciadorConteudo"></div>
                <div style="margin-top: 20px; text-align: center;">
                    <button onclick="salvarGrupos()" class="btn btn-success">üíæ Salvar</button>
                    <button onclick="fecharModal()" class="btn" style="background: #666; color: white;">‚ùå Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="feedback" class="feedback"></div>

    <script>
        // ==================== DADOS B√ÅSICOS ====================
        
        const gruposPadrao = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        const sequenciasPadrao = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN', 'ALGACIR', 'SAULO', 'RODINEI', 'SAMUEL', 'C√âLIO', 'JONAS', 'AFONSO'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'JONAS', 'C√âLIO', 'EDI', 'SAMUEL', 'JOS√â CARLOS', 'MARCOS', 'EDIVAN', 'SAULO'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'C√âLIO', 'SAULO', 'MARCOS'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL', 'EDIVAN', 'MARCOS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'JONAS']
        };

        let grupos = JSON.parse(localStorage.getItem('grupos') || JSON.stringify(gruposPadrao));
        let sequencias = JSON.parse(localStorage.getItem('sequencias') || JSON.stringify(sequenciasPadrao));
        let indices = JSON.parse(localStorage.getItem('indices') || '{"rjm":0,"rSetor":0,"rLocal":0,"ensaio":0,"terca":0,"quinta":0,"sabado":0,"domingoOficial":0}');
        let escalaAtual = [];
        let substituicoes = [];

        // ==================== FUN√á√ïES AUXILIARES ====================
        
        function salvarDados() {
            localStorage.setItem('grupos', JSON.stringify(grupos));
            localStorage.setItem('sequencias', JSON.stringify(sequencias));
            localStorage.setItem('indices', JSON.stringify(indices));
        }

        function mostrarFeedback(msg, tipo = 'sucesso') {
            const fb = document.getElementById('feedback');
            fb.textContent = msg;
            fb.className = `feedback ${tipo}`;
            fb.style.display = 'block';
            setTimeout(() => fb.style.display = 'none', 3000);
        }

        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getDiaSemana(ano, mes, dia) {
            return new Date(ano, mes - 1, dia).getDay();
        }

        function encontrarNDay(ano, mes, diaSemana, n) {
            let count = 0;
            for (let dia = 1; dia <= getDiasNoMes(ano, mes); dia++) {
                if (getDiaSemana(ano, mes, dia) === diaSemana) {
                    count++;
                    if (count === n) return dia;
                }
            }
            return null;
        }

        // ==================== INTERFACE ====================
        
        function selecionarMes() {
            document.getElementById('mesAno').click();
        }

        function atualizarMesTexto() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) return;
            
            const [ano, mes] = mesAno.split('-');
            const meses = ['JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                          'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            
            document.getElementById('mesTexto').textContent = `${meses[parseInt(mes) - 1]} DE ${ano}`;
        }

        // ==================== GERA√á√ÉO DE ESCALA ====================
        
        function gerarEscala() {
            try {
                const mesAno = document.getElementById('mesAno').value;
                if (!mesAno) {
                    mostrarFeedback('Selecione um m√™s!', 'erro');
                    return;
                }

                const [ano, mes] = mesAno.split('-').map(Number);
                
                // Verificar escala salva
                const chave = `escala_${ano}_${mes}`;
                const escalaSalva = localStorage.getItem(chave);
                if (escalaSalva) {
                    escalaAtual = JSON.parse(escalaSalva);
                    exibirEscala();
                    detectarConflitos();
                    mostrarFeedback('Escala carregada (salva)');
                    return;
                }

                escalaAtual = [];
                
                // Contar dias
                const contadores = { terca: 0, quinta: 0, sabado: 0, domingo: 0 };
                const dias = { terca: [], quinta: [], sabado: [], domingo: [] };
                
                for (let dia = 1; dia <= getDiasNoMes(ano, mes); dia++) {
                    const semana = getDiaSemana(ano, mes, dia);
                    if (semana === 2) { contadores.terca++; dias.terca.push(dia); }
                    if (semana === 4) { contadores.quinta++; dias.quinta.push(dia); }
                    if (semana === 6) { contadores.sabado++; dias.sabado.push(dia); }
                    if (semana === 0) { contadores.domingo++; dias.domingo.push(dia); }
                }

                // Gerar escala√ß√µes
                gerarEscalacaoSemanal('terca', dias.terca, grupos.terca, true);
                gerarEscalacaoSemanal('quinta', dias.quinta, grupos.quinta, false);
                gerarEscalacaoSemanal('sabado', dias.sabado, grupos.sabado, true);
                gerarEscalacaoSemanal('domingoOficial', dias.domingo, grupos.domingoOficial, true, 'DOMINGO');

                // RJM nos domingos
                dias.domingo.forEach(dia => {
                    const p1 = sequencias.rjm[indices.rjm % sequencias.rjm.length];
                    const p2 = sequencias.rjm[(indices.rjm + 1) % sequencias.rjm.length];
                    indices.rjm += 2;
                    
                    escalaAtual.unshift({
                        dia, diaSemana: 'DOMINGO', servico: 'RJM',
                        pedOracao: p1, principal: '-', lateral: p2, classe: 'rjm'
                    });
                });

                // Servi√ßos especiais
                const rSetor = encontrarNDay(ano, mes, 1, 3);
                if (rSetor) {
                    escalaAtual.push({
                        dia: rSetor, diaSemana: '2¬™ FEIRA', servico: 'R. SETOR',
                        pedOracao: sequencias.rSetor[indices.rSetor % sequencias.rSetor.length],
                        principal: 'MESCLAR', lateral: 'MESCLAR', classe: 'rsetor'
                    });
                    indices.rSetor++;
                }

                if ([1, 4, 7, 10].includes(mes)) {
                    const rLocal = encontrarNDay(ano, mes, 1, 4);
                    if (rLocal) {
                        escalaAtual.push({
                            dia: rLocal, diaSemana: '2¬™ FEIRA', servico: 'R. LOCAL',
                            pedOracao: sequencias.rLocal[indices.rLocal % sequencias.rLocal.length],
                            principal: 'MESCLAR', lateral: 'MESCLAR', classe: 'rlocal'
                        });
                        indices.rLocal++;
                    }
                }

                const ensaio = encontrarNDay(ano, mes, 5, 4);
                if (ensaio) {
                    const p1 = sequencias.ensaio[indices.ensaio % sequencias.ensaio.length];
                    const p2 = sequencias.ensaio[(indices.ensaio + 1) % sequencias.ensaio.length];
                    indices.ensaio += 2;
                    
                    escalaAtual.push({
                        dia: ensaio, diaSemana: '6¬™ FEIRA', servico: 'ENSAIO',
                        pedOracao: p1, principal: '-', lateral: p2, classe: 'ensaio'
                    });
                }

                // Atualizar √≠ndices dos grupos
                atualizarIndicesGrupos(contadores);

                // Ordenar e salvar
                escalaAtual.sort((a, b) => a.dia - b.dia);
                localStorage.setItem(chave, JSON.stringify(escalaAtual));
                salvarDados();

                exibirEscala();
                detectarConflitos();
                mostrarFeedback('Escala gerada com sucesso!');
                
                // Limpar substitui√ß√µes
                substituicoes = [];
                document.getElementById('alertaSubstituicoes').style.display = 'none';

            } catch (error) {
                console.error('Erro:', error);
                mostrarFeedback('Erro ao gerar escala: ' + error.message, 'erro');
            }
        }

        function gerarEscalacaoSemanal(tipo, diasArray, grupo, temFolga, diaSemanaTexto = null) {
            if (!diasArray.length) return;
            
            const nomes = {
                terca: '3¬™ FEIRA',
                quinta: '5¬™ FEIRA', 
                sabado: 'S√ÅBADO',
                domingoOficial: diaSemanaTexto || 'DOMINGO'
            };

            let indice = indices[tipo] || 0;
            
            diasArray.forEach((dia, i) => {
                let posicoes;
                if (temFolga && grupo.length >= 4) {
                    // Com folga: 4‚Üí3 pessoas
                    const folgaPos = (indice + 3) % grupo.length;
                    posicoes = [];
                    for (let j = 0; j < 3; j++) {
                        const pos = (indice + j) % grupo.length;
                        if (pos !== folgaPos) posicoes.push(grupo[pos]);
                    }
                    while (posicoes.length < 3) {
                        for (let k = 0; k < grupo.length; k++) {
                            const pos = (indice + k) % grupo.length;
                            if (pos !== folgaPos && !posicoes.includes(grupo[pos])) {
                                posicoes.push(grupo[pos]);
                                break;
                            }
                        }
                    }
                    indice = folgaPos; // Pr√≥ximo come√ßa com quem folgou
                } else {
                    // Sem folga: rota√ß√£o simples
                    posicoes = [
                        grupo[indice % grupo.length],
                        grupo[(indice + 1) % grupo.length],
                        grupo[(indice + 2) % grupo.length]
                    ];
                    indice = (indice + 1) % grupo.length;
                }

                escalaAtual.push({
                    dia, diaSemana: nomes[tipo], servico: 'OFICIAL',
                    pedOracao: posicoes[0], principal: posicoes[1], lateral: posicoes[2],
                    classe: 'oficial'
                });
            });

            indices[tipo] = indice;
        }

        function atualizarIndicesGrupos(contadores) {
            // Grupos com folga
            ['terca', 'sabado', 'domingoOficial'].forEach(tipo => {
                if (contadores[tipo === 'domingoOficial' ? 'domingo' : tipo] > 0) {
                    // Simular para encontrar √∫ltimo que folgou
                    const grupo = grupos[tipo];
                    let ind = indices[tipo] || 0;
                    const count = contadores[tipo === 'domingoOficial' ? 'domingo' : tipo];
                    
                    for (let i = 0; i < count; i++) {
                        ind = (ind + 3) % grupo.length;
                    }
                    indices[tipo] = ind;
                }
            });
            
            // Grupo sem folga
            if (contadores.quinta > 0) {
                indices.quinta = (indices.quinta + contadores.quinta) % grupos.quinta.length;
            }
        }

        // ==================== EXIBI√á√ÉO ====================
        
        function exibirEscala() {
            const tbody = document.getElementById('tabelaCorpo');
            tbody.innerHTML = '';

            escalaAtual.forEach((item, i) => {
                const tr = document.createElement('tr');
                
                if (item.principal === 'MESCLAR') {
                    tr.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td colspan="3" style="text-align: center;">
                            <span class="editavel" onclick="editarCampo(${i}, 'pedOracao')" ondblclick="editarCampo(${i}, 'pedOracao')">${item.pedOracao}</span>
                        </td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td><span class="editavel" onclick="editarCampo(${i}, 'pedOracao')" ondblclick="editarCampo(${i}, 'pedOracao')">${item.pedOracao}</span></td>
                        <td><span class="editavel" onclick="editarCampo(${i}, 'principal')" ondblclick="editarCampo(${i}, 'principal')">${item.principal}</span></td>
                        <td><span class="editavel" onclick="editarCampo(${i}, 'lateral')" ondblclick="editarCampo(${i}, 'lateral')">${item.lateral}</span></td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        // ==================== CONFLITOS ====================
        
        function detectarConflitos() {
            const conflitos = [];
            const porDia = {};

            escalaAtual.forEach(item => {
                if (!porDia[item.dia]) porDia[item.dia] = [];
                porDia[item.dia].push(item);
            });

            Object.keys(porDia).forEach(dia => {
                const servicos = porDia[dia];
                if (servicos.length > 1) {
                    servicos.forEach((s1, i) => {
                        servicos.slice(i + 1).forEach(s2 => {
                            const p1 = [s1.pedOracao, s1.principal, s1.lateral].filter(p => p && p !== '-' && p !== 'MESCLAR');
                            const p2 = [s2.pedOracao, s2.principal, s2.lateral].filter(p => p && p !== '-' && p !== 'MESCLAR');
                            
                            p1.forEach(pessoa => {
                                if (p2.includes(pessoa)) {
                                    if (!conflitos.find(c => c.dia == dia && c.pessoa === pessoa)) {
                                        conflitos.push({
                                            dia: parseInt(dia),
                                            pessoa,
                                            servicos: [s1.servico, s2.servico]
                                        });
                                    }
                                }
                            });
                        });
                    });
                }
            });

            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alerta = document.getElementById('alertaConflitos');
            const lista = document.getElementById('listaConflitos');
            const btn = document.getElementById('btnConflitos');

            if (conflitos.length === 0) {
                alerta.style.display = 'none';
                btn.style.display = 'none';
            } else {
                alerta.style.display = 'block';
                btn.style.display = 'inline-block';
                
                lista.innerHTML = conflitos.map(c => 
                    `<p>üìÖ Dia ${c.dia}: <strong>${c.pessoa}</strong> em ${c.servicos.join(' e ')}</p>`
                ).join('');
            }
        }

        function resolverConflitos() {
            if (!confirm('Resolver conflitos automaticamente?\n\nApenas a escala RJM ser√° alterada.')) return;

            let resolvidos = 0;
            substituicoes = [];

            const conflitos = [];
            const porDia = {};

            escalaAtual.forEach((item, index) => {
                if (!porDia[item.dia]) porDia[item.dia] = [];
                porDia[item.dia].push({...item, index});
            });

            Object.keys(porDia).forEach(dia => {
                const servicos = porDia[dia];
                if (servicos.length > 1) {
                    servicos.forEach((s1, i) => {
                        servicos.slice(i + 1).forEach(s2 => {
                            const p1 = [s1.pedOracao, s1.principal, s1.lateral].filter(p => p && p !== '-' && p !== 'MESCLAR');
                            const p2 = [s2.pedOracao, s2.principal, s2.lateral].filter(p => p && p !== '-' && p !== 'MESCLAR');
                            
                            p1.forEach(pessoa => {
                                if (p2.includes(pessoa)) {
                                    // Priorizar RJM para altera√ß√£o
                                    const servicoRJM = s1.servico === 'RJM' ? s1 : s2.servico === 'RJM' ? s2 : null;
                                    if (servicoRJM && resolverConflitoRJM(servicoRJM, pessoa, dia)) {
                                        resolvidos++;
                                    }
                                }
                            });
                        });
                    });
                }
            });

            if (resolvidos > 0) {
                exibirEscala();
                detectarConflitos();
                exibirSubstituicoes();
                mostrarFeedback(`${resolvidos} conflito(s) resolvido(s)!`);
                
                // Salvar escala atualizada
                const mesAno = document.getElementById('mesAno').value;
                if (mesAno) {
                    const [ano, mes] = mesAno.split('-');
                    localStorage.setItem(`escala_${ano}_${mes}`, JSON.stringify(escalaAtual));
                }
            } else {
                mostrarFeedback('Nenhum conflito p√¥de ser resolvido automaticamente.', 'info');
            }
        }

        function resolverConflitoRJM(servicoRJM, pessoa, dia) {
            const index = servicoRJM.index;
            const item = escalaAtual[index];
            
            // Tentar trocar Ped Ora√ß√£o ‚Üî Lateral
            if ((item.pedOracao === pessoa || item.lateral === pessoa) && 
                item.pedOracao !== item.lateral &&
                !estaEscaladoNoDia(item.pedOracao === pessoa ? item.lateral : item.pedOracao, dia, 'RJM')) {
                
                const original = {ped: item.pedOracao, lat: item.lateral};
                escalaAtual[index].pedOracao = original.lat;
                escalaAtual[index].lateral = original.ped;
                
                substituicoes.push({
                    dia: parseInt(dia),
                    tipo: 'Troca de postos',
                    detalhes: `${original.ped} (Ped Ora√ß√£o) ‚Üî ${original.lat} (Lateral)`,
                    motivo: `Conflito de ${pessoa}`
                });
                
                return true;
            }

            // Tentar substituir por algu√©m da sequ√™ncia RJM
            const campo = item.pedOracao === pessoa ? 'pedOracao' : 'lateral';
            const substituto = encontrarSubstitutoRJM(dia, pessoa);
            
            if (substituto) {
                const original = escalaAtual[index][campo];
                escalaAtual[index][campo] = substituto;
                
                substituicoes.push({
                    dia: parseInt(dia),
                    tipo: 'Substitui√ß√£o',
                    detalhes: `${original} ‚Üí ${substituto} (${campo === 'pedOracao' ? 'Ped Ora√ß√£o' : 'Lateral'})`,
                    motivo: `Conflito de ${pessoa}`
                });
                
                return true;
            }

            return false;
        }

        function encontrarSubstitutoRJM(dia, pessoaConflito) {
            const escaladosNoDia = [];
            escalaAtual.filter(item => item.dia == dia).forEach(item => {
                [item.pedOracao, item.principal, item.lateral].forEach(p => {
                    if (p && p !== '-' && p !== 'MESCLAR' && p !== pessoaConflito) {
                        escaladosNoDia.push(p);
                    }
                });
            });

            return sequencias.rjm.find(pessoa => !escaladosNoDia.includes(pessoa));
        }

        function estaEscaladoNoDia(pessoa, dia, excluirServico = null) {
            return escalaAtual.some(item => 
                item.dia == dia && 
                (!excluirServico || item.servico !== excluirServico) &&
                [item.pedOracao, item.principal, item.lateral].includes(pessoa)
            );
        }

        function exibirSubstituicoes() {
            const alerta = document.getElementById('alertaSubstituicoes');
            const lista = document.getElementById('listaSubstituicoes');

            if (substituicoes.length === 0) {
                alerta.style.display = 'none';
            } else {
                alerta.style.display = 'block';
                lista.innerHTML = substituicoes.map(s => 
                    `<p>üìÖ Dia ${s.dia}: <strong>${s.tipo}</strong> - ${s.detalhes}<br>
                    <small>Motivo: ${s.motivo}</small></p>`
                ).join('');
            }
        }

        // ==================== EDI√á√ÉO ====================
        
        function editarCampo(index, campo) {
            const valorAtual = escalaAtual[index][campo];
            const todosMembros = [...new Set([
                ...Object.values(grupos).flat(),
                ...Object.values(sequencias).flat()
            ])].sort();

            const novoValor = prompt(`Editar ${campo}:\nValor atual: ${valorAtual}`, valorAtual);
            
            if (novoValor !== null && novoValor !== valorAtual) {
                escalaAtual[index][campo] = novoValor.toUpperCase();
                exibirEscala();
                detectarConflitos();
                
                // Salvar escala atualizada
                const mesAno = document.getElementById('mesAno').value;
                if (mesAno) {
                    const [ano, mes] = mesAno.split('-');
                    localStorage.setItem(`escala_${ano}_${mes}`, JSON.stringify(escalaAtual));
                }
                
                mostrarFeedback('Campo editado com sucesso!');
            }
        }

        // ==================== PDF ====================
        
        function gerarPDF() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) {
                mostrarFeedback('Gere uma escala primeiro!', 'erro');
                return;
            }

            const [ano, mes] = mesAno.split('-');
            const meses = ['JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                          'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            const mesNome = meses[parseInt(mes) - 1];

            let linhas = '';
            escalaAtual.forEach(item => {
                const cores = {
                    oficial: '#e3f2fd',
                    rjm: '#e8f5e8', 
                    rsetor: '#fff3e0',
                    rlocal: '#f3e5f5',
                    ensaio: '#e8eaf6'
                };

                if (item.principal === 'MESCLAR') {
                    linhas += `<tr style="background-color: ${cores[item.classe]};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td colspan="3" style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                    </tr>`;
                } else {
                    linhas += `<tr style="background-color: ${cores[item.classe]};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.principal}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.lateral}</td>
                    </tr>`;
                }
            });

            const html = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Escala de Porteiros - ${mesNome} ${ano}</title>
                <style>
                    @page { margin: 2cm; size: A4; }
                    body { font-family: Arial, sans-serif; margin: 0; padding: 0; color: #333; }
                    .cabecalho { text-align: center; margin-bottom: 30px; }
                    .cabecalho h1 { font-size: 16px; font-weight: bold; margin: 5px 0; }
                    .cabecalho h2 { font-size: 14px; font-weight: bold; margin: 5px 0; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
                    th { background-color: #f0f0f0; font-weight: bold; text-align: center; padding: 10px 8px; border: 1px solid #333; }
                    td { text-align: center; padding: 8px; border: 1px solid #333; }
                    @media print { * { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; } }
                </style>
            </head>
            <body>
                <div class="cabecalho">
                    <h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
                    <h2>ESCALA DE PORTEIROS</h2>
                    <h2>${mesNome} DE ${ano}</h2>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DIA</th>
                            <th>DIA DA SEMANA</th>
                            <th>SERVI√áO</th>
                            <th>PED ORA√á√ÉO</th>
                            <th>PRINCIPAL</th>
                            <th>LATERAL</th>
                        </tr>
                    </thead>
                    <tbody>${linhas}</tbody>
                </table>
            </body>
            </html>`;

            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(html);
            novaJanela.document.close();
            setTimeout(() => novaJanela.print(), 1000);
        }

        // ==================== GERENCIADOR ====================
        
        function abrirGerenciador() {
            const modal = document.getElementById('modalGerenciador');
            const conteudo = document.getElementById('gerenciadorConteudo');
            
            let html = '<div style="display: flex; gap: 20px; flex-wrap: wrap;">';
            
            // Grupos semanais
            html += '<div style="flex: 1; min-width: 300px;">';
            html += '<h3>üë• Grupos Semanais</h3>';
            
            const gruposInfo = [
                {key: 'terca', nome: '3¬™ Feira', desc: '4 pessoas (1 folga)'},
                {key: 'quinta', nome: '5¬™ Feira', desc: '3 pessoas'},
                {key: 'sabado', nome: 'S√°bado', desc: '4 pessoas (1 folga)'},
                {key: 'domingoOficial', nome: 'Domingo', desc: '4 pessoas (1 folga)'}
            ];
            
            gruposInfo.forEach(g => {
                html += `<div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                    <strong>${g.nome} (${g.desc})</strong><br>
                    <textarea id="grupo_${g.key}" rows="2" style="width: 100%; margin-top: 5px;">${grupos[g.key].join(', ')}</textarea>
                </div>`;
            });
            
            html += '</div>';
            
            // Sequ√™ncias especiais
            html += '<div style="flex: 1; min-width: 300px;">';
            html += '<h3>üîÑ Sequ√™ncias Especiais</h3>';
            
            const seqInfo = [
                {key: 'rjm', nome: 'RJM', desc: '2 por domingo'},
                {key: 'rSetor', nome: 'R. SETOR', desc: '1 por m√™s'},
                {key: 'rLocal', nome: 'R. LOCAL', desc: 'trimestral'},
                {key: 'ensaio', nome: 'ENSAIO', desc: '2 por m√™s'}
            ];
            
            seqInfo.forEach(s => {
                html += `<div style="margin: 15px 0; padding: 10px; background: #f9f9f9; border-radius: 8px;">
                    <strong>${s.nome} (${s.desc})</strong><br>
                    <textarea id="seq_${s.key}" rows="3" style="width: 100%; margin-top: 5px;">${sequencias[s.key].join(', ')}</textarea>
                </div>`;
            });
            
            html += '</div></div>';
            
            // Controles
            html += `<div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                <h4>üîß Controles Avan√ßados</h4>
                <button onclick="reiniciarSequencias()" class="btn btn-warning" style="margin: 5px;">üéØ Reiniciar Sequ√™ncias</button>
                <button onclick="restaurarPadrao()" class="btn btn-danger" style="margin: 5px;">üîÑ Restaurar Padr√£o</button>
                <button onclick="limparEscalas()" class="btn" style="margin: 5px; background: #9c27b0; color: white;">üóëÔ∏è Limpar Escalas Salvas</button>
            </div>`;
            
            conteudo.innerHTML = html;
            modal.style.display = 'block';
        }

        function salvarGrupos() {
            try {
                // Salvar grupos
                ['terca', 'quinta', 'sabado', 'domingoOficial'].forEach(key => {
                    const valor = document.getElementById('grupo_' + key).value;
                    grupos[key] = valor.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                });

                // Salvar sequ√™ncias
                ['rjm', 'rSetor', 'rLocal', 'ensaio'].forEach(key => {
                    const valor = document.getElementById('seq_' + key).value;
                    sequencias[key] = valor.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
                });

                salvarDados();
                fecharModal();
                mostrarFeedback('Configura√ß√µes salvas com sucesso!');
                
                // Limpar escalas para for√ßar regenera√ß√£o
                limparEscalas();
                
            } catch (error) {
                mostrarFeedback('Erro ao salvar: ' + error.message, 'erro');
            }
        }

        function reiniciarSequencias() {
            if (confirm('Reiniciar todas as sequ√™ncias do in√≠cio?')) {
                indices = {rjm:0, rSetor:0, rLocal:0, ensaio:0, terca:0, quinta:0, sabado:0, domingoOficial:0};
                salvarDados();
                limparEscalas();
                mostrarFeedback('Sequ√™ncias reiniciadas!');
            }
        }

        function restaurarPadrao() {
            if (confirm('Restaurar configura√ß√µes padr√£o? Todas as altera√ß√µes ser√£o perdidas!')) {
                grupos = JSON.parse(JSON.stringify(gruposPadrao));
                sequencias = JSON.parse(JSON.stringify(sequenciasPadrao));
                indices = {rjm:0, rSetor:0, rLocal:0, ensaio:0, terca:0, quinta:0, sabado:0, domingoOficial:0};
                salvarDados();
                limparEscalas();
                fecharModal();
                mostrarFeedback('Configura√ß√µes restauradas!');
            }
        }

        function limparEscalas() {
            Object.keys(localStorage).forEach(key => {
                if (key.startsWith('escala_')) {
                    localStorage.removeItem(key);
                }
            });
        }

        function fecharModal() {
            document.getElementById('modalGerenciador').style.display = 'none';
        }

        // ==================== INICIALIZA√á√ÉO ====================
        
        document.getElementById('mesAno').addEventListener('change', function() {
            atualizarMesTexto();
            gerarEscala();
        });

        window.onclick = function(event) {
            const modal = document.getElementById('modalGerenciador');
            if (event.target === modal) {
                fecharModal();
            }
        };

        // Inicializar
        window.onload = function() {
            const hoje = new Date();
            const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesAno').value = mesAtual;
            atualizarMesTexto();
            
            console.log('üéâ Sistema CCB v3.0 Carregado - Vers√£o Otimizada');
            mostrarFeedback('Sistema carregado com sucesso!');
            
            gerarEscala();
        };
        
        // Debug global
        window.debugSistema = function() {
            console.log('=== DEBUG SISTEMA ===');
            console.log('Grupos:', grupos);
            console.log('Sequ√™ncias:', sequencias);
            console.log('√çndices:', indices);
            console.log('Escala atual:', escalaAtual);
            console.log('Substitui√ß√µes:', substituicoes);
        };

    </script>
</body>
</html>
