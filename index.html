<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Porteiros - CCB Santa Am√©lia</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            color: #1976d2;
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls input, .controls button {
            padding: 12px 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .controls input:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .btn-gerar {
            background: #1976d2;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-gerar:hover {
            background: #1565c0;
        }
        
        .btn-pdf {
            background: #d32f2f;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .btn-pdf:hover {
            background: #c62828;
        }
        
        .tabela-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f5f5f5;
            padding: 15px 10px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid #ddd;
            font-size: 14px;
            text-transform: uppercase;
        }
        
        td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        tr:hover {
            background: #e3f2fd;
        }
        
        .servico-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            white-space: nowrap;
        }
        
        .oficial { background: #e3f2fd; color: #1976d2; }
        .rjm { background: #e8f5e8; color: #388e3c; }
        .rsetor { background: #fff3e0; color: #f57c00; }
        .rlocal { background: #f3e5f5; color: #7b1fa2; }
        .ensaio { background: #e8eaf6; color: #3f51b5; }
        
        .editavel {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-height: 20px;
            display: inline-block;
            min-width: 60px;
        }
        
        .editavel:hover {
            background-color: #e3f2fd;
            border: 1px dashed #1976d2;
        }
        
        .editando {
            background-color: #fff3e0;
            border: 2px solid #ff9800;
        }
        
        .destaque {
            background-color: #ffeb3b !important;
            font-weight: bold;
            color: #f57f17;
        }
        
        .dropdown-edicao {
            background: white;
            border: 2px solid #1976d2;
            border-radius: 4px;
            padding: 4px;
            font-size: 12px;
            min-width: 120px;
        }
        
        .btn-edicao {
            background: #4caf50;
            color: white;
            border: none;
            padding: 2px 6px;
            margin: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .mesclar {
            text-align: center;
            background: #f0f0f0;
        }
        
        .conflito-alerta {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: none;
        }
        
        .conflito-alerta h3 {
            color: #d32f2f;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .conflito-lista {
            color: #d32f2f;
            font-size: 14px;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .controls input, .controls button {
                width: 100%;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gerador de Escalas de Servi√ßo</h1>
            <p>Congrega√ß√£o Crist√£ no Brasil - Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <label for="mesAno">üìÖ Selecionar M√™s:</label>
            <input type="month" id="mesAno" onchange="gerarEscala()">
            <button class="btn-gerar" onclick="gerarEscala()">üîÑ Gerar Escala</button>
            <button class="btn-pdf" onclick="gerarPDF()">üìÑ Gerar PDF</button>
            <div id="membroDestacado" style="display: none;" class="btn-gerar">
                Destacando: <span id="nomeDestacado"></span>
                <button onclick="limparDestaque()" style="background: transparent; border: none; color: white; margin-left: 10px;">‚úï</button>
            </div>
        </div>
        
        <div id="alertaConflitos" class="conflito-alerta">
            <h3>‚ö†Ô∏è Conflitos de Mesmo Dia Detectados</h3>
            <div id="listaConflitos" class="conflito-lista"></div>
            <p style="font-size: 12px; margin-top: 10px; color: #666;">
                <strong>Dica:</strong> Clique duplo em qualquer nome para editar manualmente
            </p>
        </div>
        
        <div class="tabela-container">
            <table id="tabelaEscala">
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela">
                    <!-- Dados ser√£o inseridos aqui -->
                </tbody>
            </table>
        </div>
        
        <div class="footer">
            <p>‚úÖ Sistema de Escalas Implementado</p>
            <p>üéØ Distribui√ß√£o Justa e Inteligente</p>
        </div>
    </div>

    <script>
        // Grupos por dia da semana
        const gruposPorDia = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        // Sequ√™ncias dos servi√ßos especiais
        const sequencias = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN', 'ALGACIR', 'SAULO', 'RODINEI', 'SAMUEL', 'C√âLIO', 'JONAS', 'AFONSO'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'JONAS', 'C√âLIO', 'EDI', 'SAMUEL', 'JOS√â CARLOS', 'MARCOS', 'EDIVAN', 'SAULO'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI', 'C√âLIO', 'SAULO', 'MARCOS'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL', 'EDIVAN', 'MARCOS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'JONAS']
        };

        const diasSemana = ['DOMINGO', '2¬™ FEIRA', '3¬™ FEIRA', '4¬™ FEIRA', '5¬™ FEIRA', '6¬™ FEIRA', 'S√ÅBADO'];
        let escalaAtual = [];
        let membroDestacadoAtual = null;
        let editandoAtualmente = null;

        // Lista de todos os membros para edi√ß√£o
        const todosMembros = [
            'AFONSO', 'ALGACIR', 'JONAS', 'ZANIN', 'EDI', 'MARCOS', 'SAULO',
            'JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU', 'JOS√â CARDOSO',
            'ODEMIR', 'SAMUEL', 'EDIVAN', 'C√âLIO'
        ];

        // Inicializar com m√™s atual
        window.onload = function() {
            const hoje = new Date();
            const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesAno').value = mesAtual;
            gerarEscala();
        };

        function getDiasNoMes(ano, mes) {
            return new Date(ano, mes, 0).getDate();
        }

        function getDiaSemana(ano, mes, dia) {
            return new Date(ano, mes - 1, dia).getDay();
        }

        function encontrarNesimoDay(ano, mes, diaSemana, nesimo) {
            let contador = 0;
            const diasNoMes = getDiasNoMes(ano, mes);
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                if (getDiaSemana(ano, mes, dia) === diaSemana) {
                    contador++;
                    if (contador === nesimo) {
                        return dia;
                    }
                }
            }
            return null;
        }

        function temRLocal(mes) {
            return [1, 4, 7, 10].includes(mes);
        }

        function distribuirGrupoComFolga(grupo, totalOcorrencias, indiceInicial) {
            if (indiceInicial === undefined) indiceInicial = 0;
            const escalacao = [];
            let indiceAtual = indiceInicial;
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicoes = [];
                const indiceFolga = (indiceAtual + 3) % grupo.length;
                
                for (let j = 0; j < 3; j++) {
                    const indiceAtualPessoa = (indiceAtual + j) % grupo.length;
                    if (indiceAtualPessoa !== indiceFolga) {
                        posicoes.push(grupo[indiceAtualPessoa]);
                    }
                }
                
                while (posicoes.length < 3) {
                    for (let k = 0; k < grupo.length; k++) {
                        const indiceK = (indiceAtual + k) % grupo.length;
                        if (indiceK !== indiceFolga && !posicoes.includes(grupo[indiceK])) {
                            posicoes.push(grupo[indiceK]);
                            break;
                        }
                    }
                }
                
                escalacao.push({
                    pedOracao: posicoes[0],
                    principal: posicoes[1],
                    lateral: posicoes[2]
                });
                
                indiceAtual = indiceFolga;
            }
            
            return escalacao;
        }

        function distribuirGrupoSemFolga(grupo, totalOcorrencias, indiceInicial) {
            if (indiceInicial === undefined) indiceInicial = 0;
            const escalacao = [];
            
            for (let i = 0; i < totalOcorrencias; i++) {
                const posicaoBase = (indiceInicial + i) % grupo.length;
                
                escalacao.push({
                    pedOracao: grupo[posicaoBase],
                    principal: grupo[(posicaoBase + 1) % grupo.length],
                    lateral: grupo[(posicaoBase + 2) % grupo.length]
                });
            }
            
            return escalacao;
        }

        function gerarEscala() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) return;

            const ano = parseInt(mesAnoValue.split('-')[0]);
            const mes = parseInt(mesAnoValue.split('-')[1]);
            const diasNoMes = getDiasNoMes(ano, mes);
            const escala = [];
            
            // Contar ocorr√™ncias
            const contadores = { terca: 0, quinta: 0, sabado: 0, domingo: 0 };
            const diasPorTipo = { terca: [], quinta: [], sabado: [], domingo: [] };
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const diaSemana = getDiaSemana(ano, mes, dia);
                
                if (diaSemana === 2) {
                    contadores.terca++;
                    diasPorTipo.terca.push(dia);
                } else if (diaSemana === 4) {
                    contadores.quinta++;
                    diasPorTipo.quinta.push(dia);
                } else if (diaSemana === 6) {
                    contadores.sabado++;
                    diasPorTipo.sabado.push(dia);
                } else if (diaSemana === 0) {
                    contadores.domingo++;
                    diasPorTipo.domingo.push(dia);
                }
            }

            // Gerar escala√ß√µes
            const escalacaoTerca = distribuirGrupoComFolga(gruposPorDia.terca, contadores.terca, 0);
            const escalacaoQuinta = distribuirGrupoSemFolga(gruposPorDia.quinta, contadores.quinta, 0);
            const escalacaoSabado = distribuirGrupoComFolga(gruposPorDia.sabado, contadores.sabado, 0);
            const escalacaoDomingo = distribuirGrupoComFolga(gruposPorDia.domingoOficial, contadores.domingo, 0);

            // Sequ√™ncias especiais
            let indiceRJM = 0;
            let indiceRSetor = 0;
            let indiceRLocal = 0;
            let indiceEnsaio = 0;

            // 3¬™ feiras
            for (let i = 0; i < diasPorTipo.terca.length; i++) {
                const dia = diasPorTipo.terca[i];
                const escalacaoDia = escalacaoTerca[i];
                escala.push({
                    dia: dia,
                    diaSemana: '3¬™ FEIRA',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // 5¬™ feiras
            for (let i = 0; i < diasPorTipo.quinta.length; i++) {
                const dia = diasPorTipo.quinta[i];
                const escalacaoDia = escalacaoQuinta[i];
                escala.push({
                    dia: dia,
                    diaSemana: '5¬™ FEIRA',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // S√°bados
            for (let i = 0; i < diasPorTipo.sabado.length; i++) {
                const dia = diasPorTipo.sabado[i];
                const escalacaoDia = escalacaoSabado[i];
                escala.push({
                    dia: dia,
                    diaSemana: 'S√ÅBADO',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // Domingos
            for (let i = 0; i < diasPorTipo.domingo.length; i++) {
                const dia = diasPorTipo.domingo[i];
                
                // RJM primeiro
                const membroRJM1 = sequencias.rjm[indiceRJM % sequencias.rjm.length];
                const membroRJM2 = sequencias.rjm[(indiceRJM + 1) % sequencias.rjm.length];
                indiceRJM += 2;

                escala.push({
                    dia: dia,
                    diaSemana: 'DOMINGO',
                    servico: 'RJM',
                    pedOracao: membroRJM1,
                    principal: '-',
                    lateral: membroRJM2,
                    classe: 'rjm'
                });

                // OFICIAL depois
                const escalacaoDia = escalacaoDomingo[i];
                escala.push({
                    dia: dia,
                    diaSemana: 'DOMINGO',
                    servico: 'OFICIAL',
                    pedOracao: escalacaoDia.pedOracao,
                    principal: escalacaoDia.principal,
                    lateral: escalacaoDia.lateral,
                    classe: 'oficial'
                });
            }

            // R. SETOR
            const terceiraSegunda = encontrarNesimoDay(ano, mes, 1, 3);
            if (terceiraSegunda) {
                escala.push({
                    dia: terceiraSegunda,
                    diaSemana: '2¬™ FEIRA',
                    servico: 'R. SETOR',
                    pedOracao: sequencias.rSetor[indiceRSetor % sequencias.rSetor.length],
                    principal: 'MESCLAR',
                    lateral: 'MESCLAR',
                    classe: 'rsetor',
                    mesclar: true
                });
                indiceRSetor++;
            }

            // R. LOCAL
            if (temRLocal(mes)) {
                const quartaSegunda = encontrarNesimoDay(ano, mes, 1, 4);
                if (quartaSegunda) {
                    escala.push({
                        dia: quartaSegunda,
                        diaSemana: '2¬™ FEIRA',
                        servico: 'R. LOCAL',
                        pedOracao: sequencias.rLocal[indiceRLocal % sequencias.rLocal.length],
                        principal: 'MESCLAR',
                        lateral: 'MESCLAR',
                        classe: 'rlocal',
                        mesclar: true
                    });
                    indiceRLocal++;
                }
            }

            // ENSAIO
            const quartaSexta = encontrarNesimoDay(ano, mes, 5, 4);
            if (quartaSexta) {
                const membroEnsaio1 = sequencias.ensaio[indiceEnsaio % sequencias.ensaio.length];
                const membroEnsaio2 = sequencias.ensaio[(indiceEnsaio + 1) % sequencias.ensaio.length];
                
                escala.push({
                    dia: quartaSexta,
                    diaSemana: '6¬™ FEIRA',
                    servico: 'ENSAIO',
                    pedOracao: membroEnsaio1,
                    principal: '-',
                    lateral: membroEnsaio2,
                    classe: 'ensaio'
                });
                indiceEnsaio += 2;
            }

            // Ordenar e exibir
            escala.sort(function(a, b) { return a.dia - b.dia; });
            escalaAtual = escala;
            exibirEscala(escala);
            detectarConflitos(escala);
        }

        function detectarConflitos(escala) {
            const conflitos = [];
            const diasComServicos = {};
            
            // Agrupar servi√ßos por dia
            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                if (!diasComServicos[item.dia]) {
                    diasComServicos[item.dia] = [];
                }
                diasComServicos[item.dia].push(item);
            }
            
            // Verificar conflitos no mesmo dia
            const dias = Object.keys(diasComServicos);
            for (let d = 0; d < dias.length; d++) {
                const dia = dias[d];
                const servicosDoDia = diasComServicos[dia];
                
                if (servicosDoDia.length > 1) {
                    for (let i = 0; i < servicosDoDia.length; i++) {
                        const servico1 = servicosDoDia[i];
                        for (let j = i + 1; j < servicosDoDia.length; j++) {
                            const servico2 = servicosDoDia[j];
                            
                            const pessoas1 = [servico1.pedOracao, servico1.principal, servico1.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            const pessoas2 = [servico2.pedOracao, servico2.principal, servico2.lateral].filter(function(p) {
                                return p && p !== '-' && p !== 'MESCLAR';
                            });
                            
                            for (let p1 = 0; p1 < pessoas1.length; p1++) {
                                const pessoa = pessoas1[p1];
                                if (pessoas2.indexOf(pessoa) !== -1) {
                                    // Verificar se conflito j√° existe
                                    let conflitoDuplicado = false;
                                    for (let c = 0; c < conflitos.length; c++) {
                                        if (conflitos[c].dia === parseInt(dia) && conflitos[c].pessoa === pessoa) {
                                            conflitoDuplicado = true;
                                            break;
                                        }
                                    }
                                    
                                    if (!conflitoDuplicado) {
                                        conflitos.push({
                                            dia: parseInt(dia),
                                            pessoa: pessoa,
                                            servicos: [servico1.servico, servico2.servico]
                                        });
                                    }
                                }
                            }
                        }
                    }
                }
            }
            
            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alertaDiv = document.getElementById('alertaConflitos');
            const listaDiv = document.getElementById('listaConflitos');
            
            if (conflitos.length === 0) {
                alertaDiv.style.display = 'none';
            } else {
                alertaDiv.style.display = 'block';
                let html = '';
                for (let i = 0; i < conflitos.length; i++) {
                    const conflito = conflitos[i];
                    html += '<p>Dia ' + conflito.dia + ': <strong>' + conflito.pessoa + '</strong> escalado em ' + conflito.servicos.join(' e ') + '</p>';
                }
                listaDiv.innerHTML = html;
            }
        }

        function exibirEscala(escala) {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            for (let i = 0; i < escala.length; i++) {
                const item = escala[i];
                const row = document.createElement('tr');
                
                if (item.mesclar) {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td colspan="3" class="mesclar"><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" ondblclick="editarCampo(' + i + ', \'pedOracao\')">' + item.pedOracao + '</span></td>';
                } else {
                    row.innerHTML = '<td>' + item.dia + '</td><td>' + item.diaSemana + '</td><td><span class="servico-badge ' + item.classe + '">' + item.servico + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.pedOracao + '\')" ondblclick="editarCampo(' + i + ', \'pedOracao\')">' + item.pedOracao + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.principal + '\')" ondblclick="editarCampo(' + i + ', \'principal\')">' + item.principal + '</span></td><td><span class="editavel" onclick="destacarMembro(\'' + item.lateral + '\')" ondblclick="editarCampo(' + i + ', \'lateral\')">' + item.lateral + '</span></td>';
                }
                
                tbody.appendChild(row);
            }
            
            // Aplicar destaques se houver membro selecionado
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        function destacarMembro(nome) {
            if (nome === '-' || nome === 'MESCLAR') return;
            
            if (membroDestacadoAtual === nome) {
                limparDestaque();
            } else {
                membroDestacadoAtual = nome;
                document.getElementById('nomeDestacado').textContent = nome;
                document.getElementById('membroDestacado').style.display = 'block';
                aplicarDestaques();
            }
        }

        function limparDestaque() {
            membroDestacadoAtual = null;
            document.getElementById('membroDestacado').style.display = 'none';
            
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                editaveis[i].classList.remove('destaque');
            }
        }

        function aplicarDestaques() {
            const editaveis = document.querySelectorAll('.editavel');
            for (let i = 0; i < editaveis.length; i++) {
                const elemento = editaveis[i];
                if (elemento.textContent === membroDestacadoAtual) {
                    elemento.classList.add('destaque');
                } else {
                    elemento.classList.remove('destaque');
                }
            }
        }

        function editarCampo(indiceEscala, campo) {
            if (editandoAtualmente) return; // J√° est√° editando algo
            
            editandoAtualmente = { indice: indiceEscala, campo: campo };
            
            const valorAtual = escalaAtual[indiceEscala][campo];
            
            // Encontrar o elemento na tela
            const tbody = document.getElementById('corpoTabela');
            const rows = tbody.children;
            const targetRow = rows[indiceEscala];
            
            let targetCell;
            if (escalaAtual[indiceEscala].mesclar) {
                targetCell = targetRow.children[3].querySelector('.editavel');
            } else {
                const colIndex = campo === 'pedOracao' ? 3 : campo === 'principal' ? 4 : 5;
                targetCell = targetRow.children[colIndex].querySelector('.editavel');
            }
            
            // Criar dropdown
            const dropdown = document.createElement('select');
            dropdown.className = 'dropdown-edicao';
            
            // Adicionar op√ß√µes
            const opcaoVazia = document.createElement('option');
            opcaoVazia.value = '-';
            opcaoVazia.textContent = '-';
            dropdown.appendChild(opcaoVazia);
            
            for (let i = 0; i < todosMembros.length; i++) {
                const opcao = document.createElement('option');
                opcao.value = todosMembros[i];
                opcao.textContent = todosMembros[i];
                if (todosMembros[i] === valorAtual) {
                    opcao.selected = true;
                }
                dropdown.appendChild(opcao);
            }
            
            // Criar bot√µes
            const btnSalvar = document.createElement('button');
            btnSalvar.textContent = '‚úì';
            btnSalvar.className = 'btn-edicao';
            btnSalvar.onclick = function() { salvarEdicao(dropdown.value); };
            
            const btnCancelar = document.createElement('button');
            btnCancelar.textContent = '‚úï';
            btnCancelar.className = 'btn-edicao btn-cancelar';
            btnCancelar.onclick = cancelarEdicao;
            
            // Substituir conte√∫do
            const conteudoOriginal = targetCell.innerHTML;
            targetCell.innerHTML = '';
            targetCell.appendChild(dropdown);
            targetCell.appendChild(btnSalvar);
            targetCell.appendChild(btnCancelar);
            targetCell.classList.add('editando');
            
            // Focar no dropdown
            dropdown.focus();
            
            // Salvar refer√™ncia para cancelar
            editandoAtualmente.elementoOriginal = targetCell;
            editandoAtualmente.conteudoOriginal = conteudoOriginal;
        }

        function salvarEdicao(novoValor) {
            if (!editandoAtualmente) return;
            
            // Atualizar dados
            escalaAtual[editandoAtualmente.indice][editandoAtualmente.campo] = novoValor;
            
            // Restaurar elemento
            const elemento = editandoAtualmente.elementoOriginal;
            elemento.innerHTML = '<span class="editavel" onclick="destacarMembro(\'' + novoValor + '\')" ondblclick="editarCampo(' + editandoAtualmente.indice + ', \'' + editandoAtualmente.campo + '\')">' + novoValor + '</span>';
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
            
            // Redetectar conflitos
            detectarConflitos(escalaAtual);
            
            // Reaplicar destaques
            if (membroDestacadoAtual) {
                aplicarDestaques();
            }
        }

        function cancelarEdicao() {
            if (!editandoAtualmente) return;
            
            // Restaurar conte√∫do original
            const elemento = editandoAtualmente.elementoOriginal;
            elemento.innerHTML = editandoAtualmente.conteudoOriginal;
            elemento.classList.remove('editando');
            
            // Limpar estado
            editandoAtualmente = null;
        }

        function gerarPDF() {
            const mesAnoValue = document.getElementById('mesAno').value;
            if (!mesAnoValue) {
                alert('Selecione um m√™s primeiro!');
                return;
            }

            const ano = mesAnoValue.split('-')[0];
            const mes = mesAnoValue.split('-')[1];
            const meses = [
                'JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO',
                'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'
            ];
            const mesNome = meses[parseInt(mes) - 1];
            
            // Construir linhas HTML com cores baseadas na escala atual
            let linhasHTML = '';
            for (let i = 0; i < escalaAtual.length; i++) {
                const item = escalaAtual[i];
                
                // Determinar cor de fundo baseada no servi√ßo
                let corFundo = '';
                switch(item.servico) {
                    case 'OFICIAL':
                        corFundo = '#e3f2fd';
                        break;
                    case 'RJM':
                        corFundo = '#e8f5e8';
                        break;
                    case 'R. SETOR':
                        corFundo = '#fff3e0';
                        break;
                    case 'R. LOCAL':
                        corFundo = '#f3e5f5';
                        break;
                    case 'ENSAIO':
                        corFundo = '#e8eaf6';
                        break;
                    default:
                        corFundo = '#ffffff';
                }
                
                if (item.mesclar) {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td colspan="3" style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                    </tr>`;
                } else {
                    linhasHTML += `<tr style="background-color: ${corFundo};">
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.dia}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.diaSemana}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.servico}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.pedOracao}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.principal}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${item.lateral}</td>
                    </tr>`;
                }
            }
            
            const htmlContent = `<!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Escala de Porteiros - ${mesNome} ${ano}</title>
                <style>
                    @page { 
                        margin: 2cm; 
                        size: A4; 
                    }
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 0; 
                        padding: 0; 
                        color: #333; 
                    }
                    .cabecalho { 
                        text-align: center; 
                        margin-bottom: 30px; 
                    }
                    .cabecalho h1 { 
                        font-size: 16px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h2 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    .cabecalho h3 { 
                        font-size: 14px; 
                        font-weight: bold; 
                        margin: 5px 0; 
                    }
                    table { 
                        width: 100%; 
                        border-collapse: collapse; 
                        margin-top: 20px; 
                        font-size: 12px; 
                    }
                    th { 
                        background-color: #f0f0f0; 
                        font-weight: bold; 
                        text-align: center; 
                        padding: 10px 8px; 
                        border: 1px solid #333; 
                    }
                    td { 
                        text-align: center; 
                        padding: 8px; 
                        border: 1px solid #333; 
                    }
                    
                    /* Configura√ß√µes para impress√£o colorida */
                    @media print {
                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                </style>
            </head>
            <body>
                <div class="cabecalho">
                    <h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
                    <h2>ESCALA DE PORTEIROS</h2>
                    <h3>${mesNome} DE ${ano}</h3>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>DIA</th>
                            <th>DIA DA SEMANA</th>
                            <th>SERVI√áO</th>
                            <th>PED ORA√á√ÉO</th>
                            <th>PRINCIPAL</th>
                            <th>LATERAL</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${linhasHTML}
                    </tbody>
                </table>
            </body>
            </html>`;
            
            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(htmlContent);
            novaJanela.document.close();
            setTimeout(function() { 
                novaJanela.print(); 
            }, 1000);
        }
    </script>
</body>
</html>
