<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Escalas CCB - Santa Am√©lia</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 { color: #1976d2; font-size: 28px; margin-bottom: 5px; }
        .header p { color: #666; }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls input, .controls button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .btn { 
            cursor: pointer; 
            font-weight: 600; 
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary { background: #1976d2; color: white; }
        .btn-secondary { background: #ff5722; color: white; }
        .btn-manager { background: #9c27b0; color: white; }
        .btn-groups { background: #2e7d32; color: white; }
        
        .btn:hover { transform: translateY(-1px); opacity: 0.9; }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
        th { background: #f5f5f5; font-weight: bold; }
        tr:nth-child(even) { background: #fafafa; }
        
        .nome-editavel { 
            cursor: pointer; 
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        .nome-editavel:hover { background: #e3f2fd; color: #1976d2; }
        
        .servico-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .oficial { background: #e3f2fd; color: #0d47a1; }
        .rjm { background: #e8f5e8; color: #1b5e20; }
        .rsetor { background: #fff3e0; color: #e65100; }
        .rlocal { background: #f3e5f5; color: #4a148c; }
        .ensaio { background: #e8eaf6; color: #1a237e; }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
        }
        
        .modal-header {
            background: #1976d2;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; }
        .modal-footer { padding: 15px 20px; background: #f8f9fa; text-align: center; }
        
        .close {
            color: white;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
        }
        
        .grupos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .grupo-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .grupo-titulo {
            font-weight: bold;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
        }
        
        .membros-lista {
            min-height: 80px;
            border: 2px dashed #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        
        .membro-item {
            display: inline-block;
            background: white;
            padding: 5px 8px;
            margin: 2px;
            border-radius: 15px;
            border: 1px solid #ddd;
            font-size: 12px;
            cursor: pointer;
        }
        
        .membro-item:hover { background: #f44336; color: white; }
        
        .pessoa-disponivel {
            display: inline-block;
            background: #e8f5e8;
            color: #2e7d32;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
        }
        
        .pessoa-disponivel:hover { background: #4caf50; color: white; }
        
        .nome-destacado {
            background: #ffeb3b !important;
            color: #f57f17 !important;
            font-weight: bold !important;
            box-shadow: 0 0 8px rgba(255, 235, 59, 0.8) !important;
            transform: scale(1.05) !important;
        }
        
        .conflito-alert {
            background: #ffebee;
            border: 2px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .conflito-item {
            background: white;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin: 8px 0;
            border-radius: 4px;
        }
        
        .btn-resolver {
            background: #4caf50;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .btn-resolver:hover {
            background: #45a049;
        }
        
        .pessoas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .pessoa-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
        }
        
        .btn-remove { 
            background: #f44336; 
            color: white; 
            border: none; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            cursor: pointer;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .controls { flex-direction: column; align-items: stretch; }
            .controls input, .controls button { width: 100%; margin-bottom: 10px; }
            table { font-size: 12px; }
            th, td { padding: 6px 4px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Sistema de Escalas CCB</h1>
            <p>Santa Am√©lia - Curitiba PR</p>
        </div>
        
        <div class="controls">
            <label for="mesAno">üìÖ M√™s:</label>
            <input type="month" id="mesAno">
            <button class="btn btn-primary" onclick="gerarEscala()">üîÑ Gerar Escala</button>
            <button class="btn btn-secondary" onclick="gerarPDF()">üìÑ PDF</button>
            <button class="btn btn-manager" onclick="abrirModalPessoas()">üë• Pessoas</button>
            <button class="btn btn-groups" onclick="abrirModalGrupos()">‚öôÔ∏è Grupos</button>
        </div>
        
        <div class="conflito-alert" id="conflitoAlert">
            <h4 style="color: #d32f2f; margin-bottom: 10px;">üö® Conflitos Detectados!</h4>
            <div id="listaConflitos"></div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Dia</th>
                        <th>Dia da Semana</th>
                        <th>Servi√ßo</th>
                        <th>Ped Ora√ß√£o</th>
                        <th>Principal</th>
                        <th>Lateral</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Pessoas -->
    <div id="modalPessoas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë• Gerenciar Pessoas</h3>
                <button class="close" onclick="fecharModalPessoas()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="novaPessoa" placeholder="Nome da pessoa..." style="width: 70%; padding: 8px;">
                    <button onclick="adicionarPessoa()" style="padding: 8px 15px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">Adicionar</button>
                </div>
                <div class="pessoas-grid" id="listaPessoas"></div>
            </div>
            <div class="modal-footer">
                <button onclick="salvarPessoas()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Salvar</button>
                <button onclick="fecharModalPessoas()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Grupos -->
    <div id="modalGrupos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Gerenciar Grupos</h3>
                <button class="close" onclick="fecharModalGrupos()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="grupos-grid" id="gruposContainer"></div>
            </div>
            <div class="modal-footer">
                <button onclick="salvarGrupos()" style="background: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üíæ Salvar</button>
                <button onclick="resetarGrupos()" style="background: #ff9800; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">üîÑ Resetar</button>
                <button onclick="fecharModalGrupos()" style="background: #666; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">‚ùå Fechar</button>
            </div>
        </div>
    </div>

    <script>
        // ========== DADOS PADR√ÉO ==========
        const GRUPOS_PADRAO = {
            terca: ['AFONSO', 'ALGACIR', 'JONAS', 'ZANIN'],
            quinta: ['EDI', 'MARCOS', 'SAULO'],
            sabado: ['JOS√â CARLOS', 'RODINEI', 'VANDERLEI', 'ELIZEU'],
            domingoOficial: ['JOS√â CARDOSO', 'ODEMIR', 'SAMUEL', 'EDIVAN']
        };

        const SEQUENCIAS_PADRAO = {
            rjm: ['MARCOS', 'JOS√â CARDOSO', 'EDI', 'EDIVAN', 'JOS√â CARLOS', 'VANDERLEI', 'ELIZEU', 'ZANIN'],
            rSetor: ['ELIZEU', 'ZANIN', 'JOS√â CARDOSO', 'AFONSO', 'RODINEI', 'ALGACIR', 'VANDERLEI'],
            rLocal: ['EDI', 'SAMUEL', 'EDIVAN', 'JONAS', 'JOS√â CARLOS', 'ELIZEU', 'ZANIN'],
            ensaio: ['RODINEI', 'ALGACIR', 'VANDERLEI', 'SAULO', 'C√âLIO', 'EDI', 'SAMUEL']
        };

        const GRUPOS_INFO = {
            terca: { nome: '3¬™ FEIRAS', classe: 'oficial' },
            quinta: { nome: '5¬™ FEIRAS', classe: 'oficial' },
            sabado: { nome: 'S√ÅBADOS', classe: 'oficial' },
            domingoOficial: { nome: 'DOMINGOS', classe: 'oficial' },
            rjm: { nome: 'RJM', classe: 'rjm' },
            rSetor: { nome: 'R. SETOR', classe: 'rsetor' },
            rLocal: { nome: 'R. LOCAL', classe: 'rlocal' },
            ensaio: { nome: 'ENSAIO', classe: 'ensaio' }
        };

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let grupos = JSON.parse(JSON.stringify(GRUPOS_PADRAO));
        let sequencias = JSON.parse(JSON.stringify(SEQUENCIAS_PADRAO));
        let pessoas = ['AFONSO', 'ALGACIR', 'C√âLIO', 'EDI', 'EDIVAN', 'ELIZEU', 'JONAS', 'JOS√â CARDOSO', 'JOS√â CARLOS', 'MARCOS', 'ODEMIR', 'RODINEI', 'SAMUEL', 'SAULO', 'VANDERLEI', 'ZANIN'];
        let indices = { rjm: 0, rSetor: 0, rLocal: 0, ensaio: 0, terca: 0, quinta: 0, sabado: 0, domingoOficial: 0 };
        let escalaAtual = [];
        let escalas = {};

        // ========== INICIALIZA√á√ÉO ==========
        window.onload = function() {
            carregarDados();
            const hoje = new Date();
            const mesAtual = hoje.getFullYear() + '-' + String(hoje.getMonth() + 1).padStart(2, '0');
            document.getElementById('mesAno').value = mesAtual;
            
            // Event listeners
            document.getElementById('novaPessoa').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adicionarPessoa();
            });
            
            setTimeout(gerarEscala, 100);
        };

        // ========== PERSIST√äNCIA ==========
        function salvarDados() {
            localStorage.setItem('ccb_escalas', JSON.stringify({ grupos, sequencias, pessoas, indices, escalas }));
        }

        function carregarDados() {
            const dados = localStorage.getItem('ccb_escalas');
            if (dados) {
                const parsed = JSON.parse(dados);
                grupos = parsed.grupos || grupos;
                sequencias = parsed.sequencias || sequencias;
                pessoas = parsed.pessoas || pessoas;
                indices = parsed.indices || indices;
                escalas = parsed.escalas || escalas;
            }
        }

        // ========== UTILIT√ÅRIOS DE DATA ==========
        function getDiasNoMes(ano, mes) { return new Date(ano, mes, 0).getDate(); }
        function getDiaSemana(ano, mes, dia) { return new Date(ano, mes - 1, dia).getDay(); }
        function encontrarDia(ano, mes, diaSemana, n) {
            let count = 0;
            for (let dia = 1; dia <= getDiasNoMes(ano, mes); dia++) {
                if (getDiaSemana(ano, mes, dia) === diaSemana) {
                    count++;
                    if (count === n) return dia;
                }
            }
            return null;
        }

        // ========== ALGORITMOS DE DISTRIBUI√á√ÉO ==========
        function distribuirGrupo(grupo, total, indice, comFolga = true) {
            const result = [];
            let idx = indice;
            
            for (let i = 0; i < total; i++) {
                if (comFolga) {
                    const folga = (idx + 3) % grupo.length;
                    const pos = [];
                    for (let j = 0; j < grupo.length; j++) {
                        const p = (idx + j) % grupo.length;
                        if (p !== folga) pos.push(grupo[p]);
                        if (pos.length === 3) break;
                    }
                    result.push({ pedOracao: pos[0], principal: pos[1], lateral: pos[2] });
                    idx = folga;
                } else {
                    const base = idx % grupo.length;
                    result.push({
                        pedOracao: grupo[base],
                        principal: grupo[(base + 1) % grupo.length],
                        lateral: grupo[(base + 2) % grupo.length]
                    });
                    idx++;
                }
            }
            
            return { escalacao: result, proximoIndice: idx };
        }

        function distribuirSequencia(seq, qtd, indice) {
            const result = [];
            for (let i = 0; i < qtd; i++) {
                result.push(seq[(indice + i) % seq.length]);
            }
            return { membros: result, proximoIndice: (indice + qtd) % seq.length };
        }

        // ========== GERA√á√ÉO DE ESCALA ==========
        function gerarEscala() {
            const mesAno = document.getElementById('mesAno').value;
            if (!mesAno) return;

            if (escalas[mesAno]) {
                escalaAtual = escalas[mesAno];
                exibirEscala();
                detectarConflitos();
                
                // Exibe mensagem informativa
                const ano = mesAno.split('-')[0];
                const mes = parseInt(mesAno.split('-')[1]);
                const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
                const mesNome = meses[mes - 1];
                
                alert(`üìã Escala j√° existe!\n\nA escala de ${mesNome} de ${ano} j√° foi gerada anteriormente e foi carregada.\n\n‚úÖ Total: ${escalaAtual.length} servi√ßos programados\n\nüí° Para gerar uma nova escala, delete a atual primeiro ou edite manualmente.`);
                
                return;
            }

            const ano = parseInt(mesAno.split('-')[0]);
            const mes = parseInt(mesAno.split('-')[1]);
            const diasNoMes = getDiasNoMes(ano, mes);
            
            const dias = { terca: [], quinta: [], sabado: [], domingo: [] };
            
            for (let dia = 1; dia <= diasNoMes; dia++) {
                const diaSemana = getDiaSemana(ano, mes, dia);
                if (diaSemana === 2) dias.terca.push(dia);
                else if (diaSemana === 4) dias.quinta.push(dia);
                else if (diaSemana === 6) dias.sabado.push(dia);
                else if (diaSemana === 0) dias.domingo.push(dia);
            }

            const resultTerca = distribuirGrupo(grupos.terca, dias.terca.length, indices.terca, true);
            const resultQuinta = distribuirGrupo(grupos.quinta, dias.quinta.length, indices.quinta, false);
            const resultSabado = distribuirGrupo(grupos.sabado, dias.sabado.length, indices.sabado, true);
            const resultDomingo = distribuirGrupo(grupos.domingoOficial, dias.domingo.length, indices.domingoOficial, true);

            const resultRJM = distribuirSequencia(sequencias.rjm, dias.domingo.length * 2, indices.rjm);
            const resultRSetor = distribuirSequencia(sequencias.rSetor, 1, indices.rSetor);
            const resultRLocal = distribuirSequencia(sequencias.rLocal, [1,4,7,10].includes(mes) ? 1 : 0, indices.rLocal);
            const resultEnsaio = distribuirSequencia(sequencias.ensaio, 2, indices.ensaio);

            escalaAtual = [];
            let idxRJM = 0;

            // 3¬™ feiras
            dias.terca.forEach((dia, i) => {
                const esc = resultTerca.escalacao[i];
                escalaAtual.push({
                    dia, diaSemana: '3¬™ FEIRA', servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // 5¬™ feiras
            dias.quinta.forEach((dia, i) => {
                const esc = resultQuinta.escalacao[i];
                escalaAtual.push({
                    dia, diaSemana: '5¬™ FEIRA', servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // S√°bados
            dias.sabado.forEach((dia, i) => {
                const esc = resultSabado.escalacao[i];
                escalaAtual.push({
                    dia, diaSemana: 'S√ÅBADO', servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // Domingos
            dias.domingo.forEach((dia, i) => {
                escalaAtual.push({
                    dia, diaSemana: 'DOMINGO', servico: 'RJM', classe: 'rjm',
                    pedOracao: resultRJM.membros[idxRJM], principal: '-', lateral: resultRJM.membros[idxRJM + 1]
                });
                idxRJM += 2;

                const esc = resultDomingo.escalacao[i];
                escalaAtual.push({
                    dia, diaSemana: 'DOMINGO', servico: 'OFICIAL', classe: 'oficial',
                    pedOracao: esc.pedOracao, principal: esc.principal, lateral: esc.lateral
                });
            });

            // R. SETOR
            const seg3 = encontrarDia(ano, mes, 1, 3);
            if (seg3) {
                escalaAtual.push({
                    dia: seg3, diaSemana: '2¬™ FEIRA', servico: 'R. SETOR', classe: 'rsetor',
                    pedOracao: resultRSetor.membros[0], principal: 'MESCLAR', lateral: 'MESCLAR', mesclar: true
                });
            }

            // R. LOCAL
            if ([1,4,7,10].includes(mes)) {
                const seg4 = encontrarDia(ano, mes, 1, 4);
                if (seg4) {
                    escalaAtual.push({
                        dia: seg4, diaSemana: '2¬™ FEIRA', servico: 'R. LOCAL', classe: 'rlocal',
                        pedOracao: resultRLocal.membros[0], principal: 'MESCLAR', lateral: 'MESCLAR', mesclar: true
                    });
                }
            }

            // ENSAIO
            const sex4 = encontrarDia(ano, mes, 5, 4);
            if (sex4) {
                escalaAtual.push({
                    dia: sex4, diaSemana: '6¬™ FEIRA', servico: 'ENSAIO', classe: 'ensaio',
                    pedOracao: resultEnsaio.membros[0], principal: '-', lateral: resultEnsaio.membros[1]
                });
            }

            escalaAtual.sort((a, b) => a.dia - b.dia);

            // Atualizar √≠ndices
            indices.terca = resultTerca.proximoIndice;
            indices.quinta = resultQuinta.proximoIndice;
            indices.sabado = resultSabado.proximoIndice;
            indices.domingoOficial = resultDomingo.proximoIndice;
            indices.rjm = resultRJM.proximoIndice;
            indices.rSetor = resultRSetor.proximoIndice;
            if ([1,4,7,10].includes(mes)) indices.rLocal = resultRLocal.proximoIndice;
            indices.ensaio = resultEnsaio.proximoIndice;

            escalas[mesAno] = [...escalaAtual];
            salvarDados();
            exibirEscala();
            detectarConflitos();
        }

        // ========== EXIBI√á√ÉO ==========
        function exibirEscala() {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            escalaAtual.forEach((item, i) => {
                const row = document.createElement('tr');
                
                if (item.mesclar) {
                    row.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td colspan="3" style="background: #f0f0f0;">${item.pedOracao}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${item.dia}</td>
                        <td>${item.diaSemana}</td>
                        <td><span class="servico-badge ${item.classe}">${item.servico}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="pedOracao">${item.pedOracao}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="principal">${item.principal}</span></td>
                        <td><span class="nome-editavel" data-index="${i}" data-campo="lateral">${item.lateral}</span></td>
                    `;
                }
                
                tbody.appendChild(row);
            });

            // Event listeners para edi√ß√£o e destaque
            document.querySelectorAll('.nome-editavel').forEach(span => {
                // Clique simples para destacar
                span.addEventListener('click', function(e) {
                    e.stopPropagation();
                    destacarPessoa(this.textContent);
                });
                
                // Duplo clique para editar
                span.addEventListener('dblclick', function(e) {
                    e.stopPropagation();
                    const atual = this.textContent;
                    const select = document.createElement('select');
                    pessoas.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = opt.textContent = p;
                        if (p === atual) opt.selected = true;
                        select.appendChild(opt);
                    });
                    
                    const confirmar = document.createElement('button');
                    confirmar.textContent = '‚úì';
                    confirmar.style.cssText = 'margin-left: 5px; padding: 2px 6px; background: #4caf50; color: white; border: none; border-radius: 3px; cursor: pointer;';
                    confirmar.onclick = () => {
                        const i = parseInt(this.dataset.index);
                        const campo = this.dataset.campo;
                        escalaAtual[i][campo] = select.value;
                        this.textContent = select.value;
                        
                        const mesAno = document.getElementById('mesAno').value;
                        escalas[mesAno] = [...escalaAtual];
                        salvarDados();
                        detectarConflitos();
                        
                        // Reaplica destaque se a pessoa ainda estava destacada
                        if (pessoaDestacada) {
                            setTimeout(() => destacarPessoa(pessoaDestacada), 100);
                        }
                    };
                    
                    this.innerHTML = '';
                    this.appendChild(select);
                    this.appendChild(confirmar);
                    select.focus();
                });
            });
        }

        // ========== SISTEMA DE DESTAQUE ==========
        let pessoaDestacada = null;

        function destacarPessoa(pessoa) {
            // Remove destaques anteriores
            document.querySelectorAll('.nome-destacado').forEach(el => {
                el.classList.remove('nome-destacado');
            });
            
            // Se clicou na mesma pessoa, remove destaque
            if (pessoaDestacada === pessoa) {
                pessoaDestacada = null;
                return;
            }
            
            // Destaca todas as ocorr√™ncias da nova pessoa
            pessoaDestacada = pessoa;
            document.querySelectorAll('.nome-editavel').forEach(span => {
                if (span.textContent === pessoa) {
                    span.classList.add('nome-destacado');
                }
            });
        }

        function removerDestaque() {
            document.querySelectorAll('.nome-destacado').forEach(el => {
                el.classList.remove('nome-destacado');
            });
            pessoaDestacada = null;
        }

        // ========== DETEC√á√ÉO E RESOLU√á√ÉO DE CONFLITOS ==========
        function detectarConflitos() {
            const conflitos = [];
            const servicosPorDia = {};

            // Agrupa servi√ßos por dia
            escalaAtual.forEach((item, index) => {
                if (!servicosPorDia[item.dia]) {
                    servicosPorDia[item.dia] = [];
                }
                servicosPorDia[item.dia].push({...item, index: index});
            });

            // Detecta conflitos
            Object.entries(servicosPorDia).forEach(([dia, servicos]) => {
                const pessoasNoDia = {};
                
                servicos.forEach((servico, servicoIndex) => {
                    [servico.pedOracao, servico.principal, servico.lateral].forEach((pessoa, posicao) => {
                        if (pessoa && pessoa !== '-' && pessoa !== 'MESCLAR') {
                            if (!pessoasNoDia[pessoa]) {
                                pessoasNoDia[pessoa] = [];
                            }
                            pessoasNoDia[pessoa].push({
                                servico: servico.servico,
                                posicao: ['pedOracao', 'principal', 'lateral'][posicao],
                                index: servico.index,
                                servicoIndex: servicoIndex
                            });
                        }
                    });
                });

                // Identifica pessoas com m√∫ltiplas escala√ß√µes no mesmo dia
                Object.entries(pessoasNoDia).forEach(([pessoa, escalacoes]) => {
                    if (escalacoes.length > 1) {
                        const temRJM = escalacoes.some(e => e.servico === 'RJM');
                        const temOficial = escalacoes.some(e => e.servico === 'OFICIAL');
                        
                        if (temRJM && temOficial) {
                            conflitos.push({
                                dia: parseInt(dia),
                                pessoa: pessoa,
                                escalacoes: escalacoes,
                                tipo: 'RJM_OFICIAL'
                            });
                        }
                    }
                });
            });

            exibirConflitos(conflitos);
        }

        function exibirConflitos(conflitos) {
            const alertDiv = document.getElementById('conflitoAlert');
            const listaDiv = document.getElementById('listaConflitos');
            
            if (conflitos.length === 0) {
                alertDiv.style.display = 'none';
                return;
            }

            alertDiv.style.display = 'block';
            listaDiv.innerHTML = '';

            conflitos.forEach((conflito, i) => {
                const item = document.createElement('div');
                item.className = 'conflito-item';
                
                const sugestao = obterSugestaoTroca(conflito.dia, conflito.pessoa);
                
                item.innerHTML = `
                    <strong>Dia ${conflito.dia}:</strong> ${conflito.pessoa} est√° escalado(a) em RJM e OFICIAL
                    ${sugestao ? `
                        <br><span style="color: #2e7d32;">üí° Sugest√£o: Trocar ${conflito.pessoa} ‚Üî ${sugestao.pessoa} entre domingos ${conflito.dia} e ${sugestao.dia}</span>
                        <button class="btn-resolver" onclick="aplicarTroca(${conflito.dia}, '${conflito.pessoa}', ${sugestao.dia}, '${sugestao.pessoa}')">
                            ‚úÖ Aplicar Troca
                        </button>
                    ` : '<br><span style="color: #d32f2f;">‚ùå Nenhuma troca dispon√≠vel</span>'}
                `;
                
                listaDiv.appendChild(item);
            });
        }

        function obterSugestaoTroca(diaConflito, pessoaConflito) {
            // Busca todos os domingos com RJM no m√™s
            const domingoRJM = escalaAtual.filter(s => s.servico === 'RJM' && s.diaSemana === 'DOMINGO');
            
            for (let domingo of domingoRJM) {
                if (domingo.dia === diaConflito) continue; // Pula o domingo do conflito
                
                // Pega as pessoas da RJM deste domingo
                const pessoasRJM = [domingo.pedOracao, domingo.lateral].filter(p => p && p !== '-');
                
                for (let candidato of pessoasRJM) {
                    // Verifica se o candidato N√ÉO est√° no oficial do dia do conflito
                    const oficiaisDiaConflito = escalaAtual.filter(s => 
                        s.dia === diaConflito && s.servico === 'OFICIAL'
                    );
                    
                    const candidatoTemConflito = oficiaisDiaConflito.some(oficial => 
                        [oficial.pedOracao, oficial.principal, oficial.lateral].includes(candidato)
                    );
                    
                    // Verifica se a pessoa do conflito N√ÉO est√° no oficial do dia do candidato
                    const oficiaisDiaCandidato = escalaAtual.filter(s => 
                        s.dia === domingo.dia && s.servico === 'OFICIAL'
                    );
                    
                    const pessoaConflituTemConflito = oficiaisDiaCandidato.some(oficial => 
                        [oficial.pedOracao, oficial.principal, oficial.lateral].includes(pessoaConflito)
                    );
                    
                    if (!candidatoTemConflito && !pessoaConflituTemConflito) {
                        return {
                            pessoa: candidato,
                            dia: domingo.dia
                        };
                    }
                }
            }
            
            return null;
        }

        function aplicarTroca(dia1, pessoa1, dia2, pessoa2) {
            if (confirm(`Trocar na RJM:\n‚Ä¢ Dia ${dia1}: ${pessoa1} ‚Üí ${pessoa2}\n‚Ä¢ Dia ${dia2}: ${pessoa2} ‚Üí ${pessoa1}\n\nConfirmar troca?`)) {
                // Encontra os √≠ndices das RJMs dos dois domingos
                const rjm1Index = escalaAtual.findIndex(s => s.dia === dia1 && s.servico === 'RJM');
                const rjm2Index = escalaAtual.findIndex(s => s.dia === dia2 && s.servico === 'RJM');
                
                if (rjm1Index === -1 || rjm2Index === -1) {
                    alert('Erro: N√£o foi poss√≠vel encontrar as RJMs dos domingos.');
                    return;
                }
                
                const rjm1 = escalaAtual[rjm1Index];
                const rjm2 = escalaAtual[rjm2Index];
                
                // Realiza a troca
                if (rjm1.pedOracao === pessoa1) {
                    if (rjm2.pedOracao === pessoa2) {
                        rjm1.pedOracao = pessoa2;
                        rjm2.pedOracao = pessoa1;
                    } else if (rjm2.lateral === pessoa2) {
                        rjm1.pedOracao = pessoa2;
                        rjm2.lateral = pessoa1;
                    }
                } else if (rjm1.lateral === pessoa1) {
                    if (rjm2.pedOracao === pessoa2) {
                        rjm1.lateral = pessoa2;
                        rjm2.pedOracao = pessoa1;
                    } else if (rjm2.lateral === pessoa2) {
                        rjm1.lateral = pessoa2;
                        rjm2.lateral = pessoa1;
                    }
                }
                
                // Evita pessoa sozinha na RJM
                corrigirPessoaSozinha(rjm1Index);
                corrigirPessoaSozinha(rjm2Index);
                
                const mesAno = document.getElementById('mesAno').value;
                escalas[mesAno] = [...escalaAtual];
                salvarDados();
                
                exibirEscala();
                detectarConflitos();
                
                alert(`‚úÖ Troca realizada com sucesso!\nDia ${dia1}: ${pessoa2}\nDia ${dia2}: ${pessoa1}`);
            }
        }

        function corrigirPessoaSozinha(rjmIndex) {
            const rjm = escalaAtual[rjmIndex];
            
            // Se a mesma pessoa est√° em pedOracao e lateral
            if (rjm.pedOracao === rjm.lateral && rjm.pedOracao !== '-') {
                // Busca pr√≥xima pessoa da sequ√™ncia RJM que n√£o est√° no oficial do mesmo dia
                const oficiaisDoMesmoDia = escalaAtual.filter(s => 
                    s.dia === rjm.dia && s.servico === 'OFICIAL'
                );
                
                const pessoasOcupadas = new Set();
                oficiaisDoMesmoDia.forEach(oficial => {
                    [oficial.pedOracao, oficial.principal, oficial.lateral].forEach(p => {
                        if (p && p !== '-') pessoasOcupadas.add(p);
                    });
                });
                
                // Adiciona a pessoa atual para evitar mant√™-la
                pessoasOcupadas.add(rjm.pedOracao);
                
                // Busca substituto na sequ√™ncia RJM
                const substituto = sequencias.rjm.find(p => !pessoasOcupadas.has(p));
                
                if (substituto) {
                    rjm.lateral = substituto;
                }
            }
        }

        // ========== GERENCIAMENTO DE PESSOAS ==========
        function abrirModalPessoas() {
            carregarListaPessoas();
            document.getElementById('modalPessoas').style.display = 'block';
        }

        function fecharModalPessoas() {
            document.getElementById('modalPessoas').style.display = 'none';
            document.getElementById('novaPessoa').value = '';
        }

        function carregarListaPessoas() {
            const lista = document.getElementById('listaPessoas');
            lista.innerHTML = '';
            
            pessoas.sort().forEach((pessoa, i) => {
                const card = document.createElement('div');
                card.className = 'pessoa-card';
                card.innerHTML = `
                    <span>${pessoa}</span>
                    <button class="btn-remove" onclick="removerPessoa(${i})">‚úï</button>
                `;
                lista.appendChild(card);
            });
        }

        function adicionarPessoa() {
            const input = document.getElementById('novaPessoa');
            const nome = input.value.trim().toUpperCase();
            
            if (!nome) return alert('Digite um nome!');
            if (pessoas.includes(nome)) return alert('Pessoa j√° cadastrada!');
            
            pessoas.push(nome);
            pessoas.sort();
            carregarListaPessoas();
            input.value = '';
        }

        function removerPessoa(i) {
            if (confirm(`Remover ${pessoas[i]}?`)) {
                pessoas.splice(i, 1);
                carregarListaPessoas();
            }
        }

        function salvarPessoas() {
            salvarDados();
            fecharModalPessoas();
        }

        // ========== GERENCIAMENTO DE GRUPOS ==========
        function abrirModalGrupos() {
            carregarGrupos();
            document.getElementById('modalGrupos').style.display = 'block';
        }

        function fecharModalGrupos() {
            document.getElementById('modalGrupos').style.display = 'none';
        }

        function carregarGrupos() {
            const container = document.getElementById('gruposContainer');
            container.innerHTML = '';

            Object.keys(grupos).forEach(grupoId => {
                container.appendChild(criarCardGrupo(grupoId, grupos[grupoId], true));
            });

            Object.keys(sequencias).forEach(seqId => {
                container.appendChild(criarCardGrupo(seqId, sequencias[seqId], false));
            });
        }

        function criarCardGrupo(id, membros, isGrupo) {
            const info = GRUPOS_INFO[id];
            const card = document.createElement('div');
            card.className = 'grupo-card';
            
            card.innerHTML = `
                <div class="grupo-titulo ${info.classe}">${info.nome}</div>
                <div class="membros-lista" data-grupo="${id}">
                    ${membros.map(m => `<span class="membro-item" onclick="removerMembro('${id}', '${m}', ${isGrupo})">${m}</span>`).join('')}
                </div>
                <div style="margin-bottom: 10px;">
                    <strong>Dispon√≠veis:</strong><br>
                    ${obterPessoasLivres(id, isGrupo).map(p => `<span class="pessoa-disponivel" onclick="adicionarMembro('${id}', '${p}', ${isGrupo})">${p}</span>`).join('')}
                </div>
                <button onclick="resetarGrupo('${id}', ${isGrupo})" style="width: 100%; padding: 8px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÑ Resetar</button>
            `;
            
            return card;
        }

        function obterPessoasLivres(grupoAtual, isGrupoAtual) {
            const usadas = new Set();
            
            // Para grupos (ter√ßa, quinta, s√°bado, domingo): exclui pessoas de outros grupos
            if (isGrupoAtual) {
                Object.entries(grupos).forEach(([grupoId, membros]) => {
                    if (grupoId !== grupoAtual) {
                        membros.forEach(m => usadas.add(m));
                    }
                });
            } else {
                // Para sequ√™ncias: exclui pessoas de grupos E outras sequ√™ncias
                Object.values(grupos).forEach(membros => {
                    membros.forEach(m => usadas.add(m));
                });
                
                Object.entries(sequencias).forEach(([sequenciaId, membros]) => {
                    if (sequenciaId !== grupoAtual) {
                        membros.forEach(m => usadas.add(m));
                    }
                });
                
                // ODEMIR √© exclusivo do Domingo Oficial - n√£o pode estar nas sequ√™ncias especiais
                usadas.add('ODEMIR');
            }
            
            return pessoas.filter(p => !usadas.has(p)).sort();
        }

        function adicionarMembro(grupoId, pessoa, isGrupo) {
            if (isGrupo) {
                if (!grupos[grupoId].includes(pessoa)) {
                    grupos[grupoId].push(pessoa);
                    grupos[grupoId].sort();
                }
            } else {
                if (!sequencias[grupoId].includes(pessoa)) {
                    sequencias[grupoId].push(pessoa);
                    sequencias[grupoId].sort();
                }
            }
            carregarGrupos();
        }

        function removerMembro(grupoId, pessoa, isGrupo) {
            if (confirm(`Remover ${pessoa} do grupo ${GRUPOS_INFO[grupoId].nome}?`)) {
                if (isGrupo) {
                    const idx = grupos[grupoId].indexOf(pessoa);
                    if (idx > -1) grupos[grupoId].splice(idx, 1);
                } else {
                    const idx = sequencias[grupoId].indexOf(pessoa);
                    if (idx > -1) sequencias[grupoId].splice(idx, 1);
                }
                carregarGrupos();
            }
        }

        function resetarGrupo(grupoId, isGrupo) {
            if (confirm(`Resetar ${GRUPOS_INFO[grupoId].nome} ao padr√£o?`)) {
                if (isGrupo) {
                    grupos[grupoId] = [...GRUPOS_PADRAO[grupoId]];
                } else {
                    sequencias[grupoId] = [...SEQUENCIAS_PADRAO[grupoId]];
                }
                carregarGrupos();
            }
        }

        function resetarGrupos() {
            if (confirm('Resetar TODOS os grupos ao padr√£o?')) {
                grupos = JSON.parse(JSON.stringify(GRUPOS_PADRAO));
                sequencias = JSON.parse(JSON.stringify(SEQUENCIAS_PADRAO));
                carregarGrupos();
            }
        }

        function salvarGrupos() {
            salvarDados();
            fecharModalGrupos();
        }

        // ========== GERA√á√ÉO DE PDF ==========
        function gerarPDF() {
            if (!escalaAtual.length) return alert('Gere uma escala primeiro!');

            const mesAno = document.getElementById('mesAno').value;
            const [ano, mes] = mesAno.split('-');
            const meses = ['JANEIRO', 'FEVEREIRO', 'MAR√áO', 'ABRIL', 'MAIO', 'JUNHO', 'JULHO', 'AGOSTO', 'SETEMBRO', 'OUTUBRO', 'NOVEMBRO', 'DEZEMBRO'];
            const mesNome = meses[parseInt(mes) - 1];
            
            let linhas = '';
            escalaAtual.forEach(item => {
                if (item.mesclar) {
                    linhas += `<tr><td>${item.dia}</td><td>${item.diaSemana}</td><td class="cor-${item.classe}">${item.servico}</td><td colspan="3" class="mesclar">${item.pedOracao}</td></tr>`;
                } else {
                    linhas += `<tr><td>${item.dia}</td><td>${item.diaSemana}</td><td class="cor-${item.classe}">${item.servico}</td><td>${item.pedOracao}</td><td>${item.principal}</td><td>${item.lateral}</td></tr>`;
                }
            });
            
            const html = `<!DOCTYPE html>
<html><head><meta charset="UTF-8"><title>Escala ${mesNome} ${ano}</title>
<style>
@page { margin: 2cm; }
body { font-family: Arial, sans-serif; color: #333; }
.cabecalho { text-align: center; margin-bottom: 30px; }
.cabecalho h1 { font-size: 18px; color: #1976d2; margin: 5px 0; }
.cabecalho h2 { font-size: 16px; margin: 5px 0; }
table { width: 100%; border-collapse: collapse; font-size: 13px; }
th, td { border: 1px solid #333; padding: 8px; text-align: center; }
th { background: #f0f0f0; font-weight: bold; }
tr:nth-child(even) { background: #f9f9f9; }
.cor-oficial { background: #e3f2fd !important; color: #0d47a1 !important; font-weight: bold; }
.cor-rjm { background: #e8f5e8 !important; color: #1b5e20 !important; font-weight: bold; }
.cor-rsetor { background: #fff3e0 !important; color: #e65100 !important; font-weight: bold; }
.cor-rlocal { background: #f3e5f5 !important; color: #4a148c !important; font-weight: bold; }
.cor-ensaio { background: #e8eaf6 !important; color: #1a237e !important; font-weight: bold; }
.mesclar { background: #f5f5f5 !important; font-weight: normal; }
</style></head>
<body>
<div class="cabecalho">
<h1>CONGREGA√á√ÉO CRIST√É NO BRASIL ‚Äì SANTA AM√âLIA ‚Äì CURITIBA PR</h1>
<h2>ESCALA DE PORTEIROS</h2>
<h2>${mesNome} DE ${ano}</h2>
</div>
<table>
<thead><tr><th>DIA</th><th>DIA DA SEMANA</th><th>SERVI√áO</th><th>PED ORA√á√ÉO</th><th>PRINCIPAL</th><th>LATERAL</th></tr></thead>
<tbody>${linhas}</tbody>
</table>
<div style="margin-top: 20px; text-align: center; font-size: 11px; color: #666;">
<p>Sistema de Escalas CCB Santa Am√©lia ‚Ä¢ Gerado em ${new Date().toLocaleDateString('pt-BR')}</p>
</div>
</body></html>`;
            
            const janela = window.open('', '_blank');
            janela.document.write(html);
            janela.document.close();
            setTimeout(() => janela.print(), 500);
        }

        // ========== EVENT LISTENERS GLOBAIS ==========
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                fecharModalPessoas();
                fecharModalGrupos();
            }
            
            // Remove destaque quando clica em √°rea neutra
            if (!e.target.closest('.nome-editavel') && !e.target.closest('select') && !e.target.closest('button')) {
                removerDestaque();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalPessoas();
                fecharModalGrupos();
                removerDestaque();
            }
        });
    </script>
</body>
</html>
